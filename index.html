
<body html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
        SECURITY SUGGESTION: Implement a Content Security Policy (CSP).
        A CSP helps prevent Cross-Site Scripting (XSS) and other injection attacks.
        Example (very restrictive, customize for your needs):
        <meta http-equiv="Content-Security-Policy"
              content="default-src 'self';
                       script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net https://maps.googleapis.com;
                       style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline';
                       img-src 'self' https://images.unsplash.com https://iili.io https://cdn-icons-png.flaticon.com https://images.pexels.com data: https://maps.gstatic.com https://*.ggpht.com https://firebasestorage.googleapis.com;
                       font-src 'self' https://cdnjs.cloudflare.com;
                       connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://cdnjs.cloudflare.com https://firebasestorage.googleapis.com https://securetoken.googleapis.com https://firebase.googleapis.com https://maps.googleapis.com;
                       object-src 'none';
                       base-uri 'self';
                       form-action 'self';
                       frame-src 'self' https://www.google.com;">
    -->
    <title>Crypto Harvest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* style.css - (Golden Theme) */
        /* Global Styles */
        :root {
            --primary-color: #5D4037; /* Dark Brown */
            --primary-light: #8B5E3C;
            --primary-dark: #3E2723;
            --secondary-color: #B08D57; /* Muted Gold */
            --secondary-light: #D4AC79;
            --secondary-dark: #8C6D43;
            --accent-color: #D4AF37; /* Bright Gold */
            --accent-light: #E7C368;
            --accent-dark: #B8860B; /* DarkGoldenRod */
            --success-color: #556B2F; /* Dark Olive Green */
            --warning-color: #DAA520; /* GoldenRod */
            --danger-color: #A43B3B; /* Deep Red */
            --info-color: #B08D57;   /* Muted Gold (was new Teal) - for info elements */

            --light-color: #F5F2EB; /* Off-white with slight warmth */
            --light-text: #FFFFFF;
            --dark-text: #333333; /* Dark Gray for text on light backgrounds */
            --gray-text: #777777; /* Medium Gray */
            --light-gray: #e0e0e0;
            --medium-gray: #bdbdbd;
            --dark-gray: #616161;
            --card-bg: #FFFFFF; /* White cards are clean */

            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
            --border-radius: 10px;
            --transition: all 0.3s ease;

            /* RGB versions for rgba() */
            --primary-color-rgb: 93, 64, 55;
            --primary-dark-rgb: 62, 39, 35; /* Added for consistency */
            --secondary-color-rgb: 176, 141, 87;
            --accent-color-rgb: 212, 175, 55;
            --info-color-rgb: 176, 141, 87; /* Muted Gold RGB */
            --light-color-rgb: 245, 242, 235; /* For loading overlay */
            --warning-color-rgb: 218, 165, 32; /* For important note background */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color); /* Warmer page background */
            color: var(--dark-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-dark); /* Deep brown titles */
        }

        p {
            margin-bottom: 15px;
            color: var(--gray-text);
        }

        a {
            color: var(--accent-color); /* Bright Gold links */
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            color: var(--accent-light);
        }

        /* Glowing Button Hover Effect */
        .glowing-btn-hover:hover {
            box-shadow: 0 0 8px rgba(var(--accent-color-rgb), 0.6),
                        0 0 15px rgba(var(--accent-color-rgb), 0.4),
                        var(--shadow-hover); /* Combine with existing shadow if any */
        }


        /* Auth Styles */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); /* Dark Brown Gradient */
            color: var(--light-text);
            padding: 20px;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 4px 8px rgba(var(--primary-dark-rgb), 0.3)); /* Brownish shadow */
            border-radius: 50%; /* Ensure logo is circular if it's square by nature */
            object-fit: cover;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: var(--light-text);
        }

        #auth-options {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
        }

        .auth-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text); /* White text on bright gold is okay */
            box-shadow: var(--shadow);
            flex: 1;
            text-align: center;
        }

        .auth-btn:hover {
            transform: translateY(-3px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
            background-color: var(--accent-light);
        }

        .auth-form {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-hover);
            animation: fadeIn 0.5s ease;
            color: var(--dark-text);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-form h2 {
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-text);
        }

        .form-group.password-container i.fas.fa-lock { /* Specific for lock icon */
             left: 15px;
        }

        .password-container .password-toggle i { /* Specific for eye icon */
            left: auto;
            right: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-text);
            cursor: pointer;
        }

        .password-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .strength-bar {
            height: 4px;
            flex: 1;
            background-color: var(--light-gray);
            border-radius: 2px;
        }
        .strength-bar.weak { background-color: var(--danger-color); } /* New Danger */
        .strength-bar.medium { background-color: var(--warning-color); } /* New Warning */
        .strength-bar.strong { background-color: var(--success-color); } /* New Success */


        .strength-text {
            font-size: 0.8rem;
            color: var(--gray-text);
            margin-left: 5px;
        }

        .auth-form input, .modal-content input[type="text"], .modal-content input[type="email"], .modal-content input[type="password"] {
            width: 100%;
            padding: 12px 15px 12px 40px; /* Increased left padding for icon */
            margin-bottom: 5px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #fafafa; /* Slightly off-white input bg */
        }

        /* Adjust padding for inputs not inside a .form-group with an icon */
        .modal-content .form-group > input[type="text"]:not(:placeholder-shown):not(:focus):first-child,
        .modal-content .form-group > input[type="email"]:not(:placeholder-shown):not(:focus):first-child,
        .modal-content .form-group > input[type="password"]:not(:placeholder-shown):not(:focus):first-child {
             padding-left: 15px; /* Default padding if no icon is explicitly styled */
        }
        /* If modal inputs do have icons, this will be overridden by the .form-group i + input styling */
         .modal-content .form-group input[type="text"],
         .modal-content .form-group input[type="email"],
         .modal-content .form-group input[type="password"] {
            padding-left: 40px; /* Assuming icons are present */
         }
         .modal-content #profile-form-group-name input[type="text"] {
             padding-left: 40px; /* Keep icon padding for name in profile */
         }


        .password-container input {
            padding-right: 45px; /* Space for password toggle */
        }

        .password-container.has-strength input {
            padding-right: 70px;
        }


        .auth-form input:focus, .modal-content input[type="text"]:focus, .modal-content input[type="email"]:focus, .modal-content input[type="password"]:focus {
            border-color: var(--accent-color); /* Bright Gold focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3), 0 0 5px rgba(var(--accent-color-rgb), 0.2); /* Golden focus ring */
            background-color: var(--card-bg);
        }

        .terms {
            display: flex;
            align-items: center;
            margin: 15px 0;
            font-size: 0.9rem; /* Applied to container for label as well */
        }

        .terms input {
            width: auto;
            margin-right: 10px;
            accent-color: var(--accent-color); /* Style checkbox */
        }

        .terms label {
            color: var(--gray-text);
        }
        .terms label a { /* Specific for links within terms */
            margin: 0 3px; /* Add a little space around the links */
        }


        #terms-link, #privacy-link { /* Combined for similar styling */
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .btn-text, .btn-loader {
            display: inline-block;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-text);
            font-size: 0.9rem;
        }

        .auth-switch span {
            color: var(--accent-color); /* Bright Gold */
            cursor: pointer;
            font-weight: 600;
        }

        #forgot-password-link {
            display: block;
            text-align: right;
            font-size: 0.9rem;
            color: var(--accent-color); /* Bright Gold */
            margin-top: -10px; /* Adjust if needed */
            margin-bottom: 15px;
            cursor: pointer;
        }
        #forgot-password-link:hover {
            text-decoration: underline;
        }


        /* App Styles */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--light-color); /* Warmer page background */
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        #email-verification-notice {
            background-color: var(--warning-color); /* GoldenRod */
            color: var(--dark-text); /* Dark text on GoldenRod */
            padding: 10px 20px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px; /* Below app-header */
            z-index: 99; /* Below app-header, above content */
            box-shadow: var(--shadow);
        }
        #email-verification-notice button {
            background: none;
            border: none;
            color: var(--primary-dark); /* Darkest Brown */
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }


        .menu-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            transform: scale(1.1);
            color: var(--accent-light); /* Light gold hover for menu icon */
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .app-logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-text);
            margin-bottom: 0; /* Override general h1 margin */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(var(--primary-dark-rgb), 0.3); /* Darker inset on brown header */
            padding: 5px 10px;
            border-radius: 20px;
        }

        #user-balance {
            font-weight: 600;
        }

        .refresh-balance {
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .refresh-balance:hover {
            transform: rotate(180deg);
            color: var(--accent-light); /* Light gold hover */
        }

        .user-avatar {
            position: relative;
            cursor: pointer;
        }
        .user-avatar img { /* For profile picture in header */
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--light-text);
        }

        .user-avatar i { /* Fallback icon if image fails or not set */
            font-size: 1.8rem; /* Original size */
            color: var(--light-text);
            width: 36px; /* Match image size */
            height: 36px; /* Match image size */
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .online-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: var(--success-color); /* Dark Olive Green */
            border-radius: 50%;
            border: 2px solid var(--primary-color); /* Dark Brown border */
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .side-menu.active {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            text-align: center;
            position: relative;
        }

        .menu-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid var(--light-text);
            object-fit: cover;
        }

        .menu-header h3 {
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .menu-header span#menu-user-email { /* Changed ID */
            font-size: 0.9rem;
            opacity: 0.9;
            word-break: break-all;
        }

        .user-level {
            margin-top: 10px;
        }

        #user-level-badge {
            display: inline-block;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text); /* White text okay on Bright Gold */
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .menu-items {
            list-style: none;
            padding: 10px 0;
            flex: 1;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            color: var(--gray-text);
        }

        .menu-item span {
            flex: 1;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .menu-item:hover {
            background-color: var(--light-color); /* Warm off-white */
            color: var(--accent-color); /* Bright Gold */
        }

        .menu-item.active {
            background-color: var(--light-color); /* Warm off-white */
            border-left: 4px solid var(--accent-color); /* Bright Gold */
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
        }

        .menu-footer {
            padding: 15px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray-text);
            border-top: 1px solid var(--light-gray);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            margin-top: 60px; /* Height of app-header */
            transition: var(--transition);
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0; /* Reset margin when menu is not permanently open */
            }
            .side-menu.active + .main-content {
                /* Add blur or dim effect if needed when menu is open on mobile */
            }
            #email-verification-notice {
                top: 56px; /* Adjust if header height is different on mobile */
            }
        }

        /* Page Styles */
        .page {
            animation: fadeIn 0.5s ease;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            margin-bottom: 0;
        }

        .page-description {
            color: var(--gray-text);
            margin-bottom: 20px;
            width: 100%;
        }

        /* Home Page */
        .slideshow-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .slide {
            display: none;
            position: relative;
        }

        .slide img {
            width: 100%;
            vertical-align: middle;
            height: 300px; /* Fixed height for slides */
            object-fit: cover; /* Ensure image covers the area */
        }

        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(var(--primary-dark-rgb),0.9), transparent); /* Dark brown gradient */
            color: var(--light-text);
            padding: 30px 20px 20px;
        }

        .slide-content h3 {
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .slide-content p {
            color: rgba(255,255,255,0.8);
            margin-bottom: 0;
        }

        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(var(--primary-dark-rgb), 0.5); /* Dark brown semi-transparent */
        }

        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev:hover, .next:hover {
            background-color: rgba(var(--primary-dark-rgb), 0.8); /* Darker brown */
        }

        .dot-container { /* Used for styling the dot container below slideshow */
            text-align: center;
            padding: 10px 0;
        }

        .dot {
            cursor: pointer;
            height: 12px;
            width: 12px;
            margin: 0 5px;
            background-color: var(--light-gray);
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }

        .active-dot, .dot:hover {
            background-color: var(--accent-color); /* Bright Gold */
        }
        .fade {
            animation-name: fade;
            animation-duration: 1.5s;
        }
        @keyframes fade {
            from {opacity: .4}
            to {opacity: 1}
        }


        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card.large {
            grid-column: span 2; /* For wider stat cards if needed */
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-color); /* Warm off-white */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
        }
        .referral-stat .stat-icon {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            background-color: rgba(var(--accent-color-rgb), 0.1); /* Light Bright Gold */
        }


        .stat-card h3 {
            font-size: 1rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold for stat values */
            margin-bottom: 0;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .quick-action {
            flex: 1 1 150px; /* Flex grow, shrink, basis */
            min-width: 150px; /* Minimum width before wrapping */
            background-color: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            color: var(--gray-text);
            text-align: center;
        }

        .quick-action i {
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
        }

        .quick-action span {
            font-weight: 500;
        }

        .quick-action:hover {
            transform: translateY(-3px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
        }

        .quick-action:hover i {
            color: var(--light-text);
        }

        .announcement-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        .announcement-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .announcement-card h3 i {
            color: var(--accent-color); /* Bright Gold for bullhorn */
        }

        .announcement-content {
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 5px;
        }

        /* Team Page */
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .rank-badge {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rank-badge i {
            font-size: 1.2rem;
        }

        .action-btn {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .ranking-table, .invitation-section, .direct-referrals-section, .commissions-earned-section {
             background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
         .direct-referrals-section h3, .commissions-earned-section h3 {
            margin-bottom: 15px;
         }


        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--light-color); /* Warm off-white */
            color: var(--primary-color); /* Dark Brown */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: var(--light-color); /* Warm off-white */
        }

        .current-user {
            background-color: rgba(var(--accent-color-rgb), 0.1) !important; /* Light Bright Gold */
            font-weight: 500;
        }

        .invitation-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invite-code-container {
            display: flex;
            margin: 15px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px var(--light-gray);
        }

        #invite-code {
            flex: 1;
            padding: 12px 15px;
            border: none;
            font-weight: 600;
            color: var(--accent-color); /* Bright Gold */
            background-color: #fafafa;
        }

        .copy-btn {
            padding: 12px 20px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .copy-btn:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .invite-note {
            font-style: italic;
            color: var(--gray-text);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .referral-stat {
            background-color: var(--light-color); /* Warm off-white */
            padding: 15px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .referral-stat h4 {
            font-size: 0.9rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .referral-stat p {
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        .referral-share {
            margin: 25px 0;
        }

        .referral-share h4 {
            margin-bottom: 15px;
            color: var(--gray-text);
            font-size: 1rem;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .share-btn i {
            font-size: 1.1rem;
        }

        .share-btn.whatsapp {
            background-color: #25D366;
            color: white;
        }

        .share-btn.facebook {
            background-color: #3b5998; /* Facebook brand blue */
            color: white;
        }

        .share-btn.copy-link {
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--dark-text);
            border: 1px solid var(--secondary-dark);
        }
        .share-btn.copy-link:hover {
            background-color: var(--secondary-light);
        }


        .share-btn:hover {
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); Handled by .glowing-btn-hover if applied */
            opacity: 0.9;
        }

        /* Specific for MLM tables on Team Page */
        .direct-referrals-table th, .direct-referrals-table td,
        .commissions-earned-table th, .commissions-earned-table td {
            padding: 10px 15px;
            font-size: 0.9rem;
        }


        .status-pending {
            color: var(--warning-color); /* GoldenRod */
            font-weight: 600;
        }

        .status-completed {
            color: var(--success-color); /* Dark Olive Green */
            font-weight: 600;
        }

        .status-rejected, .status-cancelled {
            color: var(--danger-color); /* Deep Red */
            font-weight: 600;
        }
         .status-commission_pending, .status-pending_first_deposit {
            color: var(--info-color); /* Muted Gold */
            font-weight: 500;
        }


        /* Plans Page */
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .plan-card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .plan-card h3 {
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3rem;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            text-align: center;
            margin-bottom: 15px;
        }

        .plan-duration {
            text-align: center;
            color: var(--gray-text);
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 25px;
            flex: 1; /* Allows button to stick to bottom */
        }

        .plan-features li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.95rem;
            color: var(--gray-text);
        }

        .plan-features i {
            color: var(--success-color); /* Dark Olive Green */
            margin-top: 3px;
        }

        .buy-plan-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: auto; /* Pushes button to bottom if plan-features is flex:1 */
        }

        .buy-plan-btn:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .popular {
            border: 2px solid var(--accent-color); /* Bright Gold */
        }

        /* Shimmer for popular plan card */
        .plan-card.popular {
            position: relative;
            overflow: hidden;
        }
        .plan-card.popular::before {
            content: "";
            position: absolute;
            top: 0;
            left: -150%;
            width: 70%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 215, 0, 0.35), /* Gold shimmer */
                transparent
            );
            transform: skewX(-25deg);
            transition: left 0.75s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
        }
        .plan-card.popular:hover::before {
            left: 150%;
        }


        .popular-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .plan-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        .plan-info-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .plan-info-card h3 i {
            color: var(--info-color); /* Muted Gold for info icon */
        }

        .info-content {
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 5px;
        }

        .info-content p {
            margin-bottom: 10px;
            display: flex; /* For aligning strong and text */
        }

        .info-content p strong {
            min-width: 120px; /* Ensure consistent label width */
            color: var(--dark-text);
            margin-right: 5px;
        }

        /* Deposit Page */
        .deposit-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .method-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column; /* Stack image and text */
            align-items: center;
            gap: 10px;
            border: 2px solid transparent;
            min-width: 150px; /* Minimum width for method cards for crypto names */
            text-align: center;
        }

        .method-card img {
            height: 40px; /* Adjusted height */
            width: auto;
            max-width: 100px; /* Max width for logo */
            object-fit: contain;
        }

        .method-card.active {
            border-color: var(--accent-color); /* Bright Gold */
            background-color: rgba(var(--accent-color-rgb), 0.05); /* Light Bright Gold */
        }

        .method-card:hover:not(.active) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent-light);
        }

        .deposit-instructions {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .deposit-instructions h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .deposit-instructions h3 i {
            color: var(--info-color); /* Muted Gold */
        }

        .deposit-instructions p {
            margin-bottom: 15px;
        }

        .account-details {
            background-color: var(--light-color); /* Warm off-white */
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            margin-bottom: 10px;
            align-items: center; /* Align items vertically in the flex container */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            min-width: 180px; /* Adjusted width for longer labels */
            color: var(--dark-text);
            margin-bottom: 5px; /* Spacing on wrap */
            margin-right: 10px;
        }

        .detail-value-container {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px; /* Ensure space for address and button */
        }

        .detail-value {
            flex-grow: 1;
            font-family: monospace, 'Courier New', Courier; /* Monospace for numbers */
            font-size: 1rem; /* Adjusted for long addresses */
            color: var(--accent-color); /* Bright Gold */
            word-break: break-all; /* Prevent overflow */
        }

        .copy-address-btn { /* Generic class for copy buttons in details */
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--dark-text); /* Dark text on Muted Gold */
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            margin-left: 10px;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .copy-address-btn:hover {
            background-color: var(--secondary-dark);
            color: var(--light-text);
        }


        .important-note {
            display: flex;
            gap: 10px;
            background-color: rgba(var(--warning-color-rgb), 0.1); /* Light GoldenRod */
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid var(--warning-color); /* GoldenRod */
        }

        .important-note i {
            color: var(--warning-color); /* GoldenRod */
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .important-note p {
            margin-bottom: 0;
            color: var(--dark-text);
        }

        .deposit-form {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .deposit-form h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
        }

        .deposit-form h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .form-select { /* General select style */
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B08D57' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); /* Muted Gold arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
            transition: var(--transition);
            background-color: var(--card-bg);
        }

        .form-select:focus {
            border-color: var(--accent-color); /* Bright Gold */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3); /* Golden focus ring */
        }

        #custom-amount-container {
            margin-top: 10px;
        }

        #custom-amount { /* Input for custom amount */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        #custom-amount:focus {
             border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }


        /* Withdraw Page */
        .withdraw-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 8px;
        }

        .info-item i {
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        .info-content h4 {
            font-size: 0.9rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .info-content p {
            font-weight: 500;
            color: var(--dark-text);
            margin-bottom: 0;
        }

        .withdraw-form {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .withdraw-form h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
        }

        .withdraw-form h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .amount-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .amount-btn {
            padding: 8px 12px; /* Slightly smaller padding */
            background-color: var(--light-color); /* Warm off-white */
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--secondary-dark); /* Darker Muted Gold */
        }

        .amount-btn:hover {
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--light-text);
            border-color: var(--secondary-color);
        }

        /* History Pages */
        .history-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .history-filter select {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            background-color: var(--card-bg);
            min-width: 150px; /* Give select some base width */
            /* Arrow color will be inherited from .form-select if class is added, or default */
        }

        .history-table {
            width: 100%;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .history-table th {
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            text-align: left;
        }
        .history-table td {
            text-align: left;
        }

        .history-table tr:nth-child(even) {
            background-color: var(--light-color); /* Warm off-white */
        }
        .history-table tr:hover {
            background-color: rgba(var(--secondary-color-rgb), 0.1); /* Light Muted Gold */
        }


        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .summary-card h4 {
            color: var(--gray-text);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            margin-bottom: 0;
            font-size: 1.2rem;
        }

        .action-link {
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
        }

        .action-link:hover {
            color: var(--accent-dark);
        }
        td .action-link {
            font-size: 0.9em;
        }


        /* Earnings Page */
        .earnings-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .earnings-filter {
             margin-bottom: 15px;
        }
        .earnings-filter select {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            background-color: var(--card-bg);
            min-width: 150px;
        }


        .earnings-chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .earnings-chart-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .earnings-chart-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        #earnings-chart {
            width: 100% !important;
            max-height: 350px;
        }

        .earnings-table-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .earnings-table-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .earnings-table-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .earnings-table th, .earnings-table td {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        .badge {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--light-text);
        }
        .badge.investment { background-color: var(--secondary-color); color: var(--dark-text); } /* Muted Gold, Dark Text */
        .badge.referral { background-color: var(--accent-color); } /* Bright Gold, Light Text okay */


        /* Contact Page */
        .contact-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .contact-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .contact-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light-color); /* Warm off-white */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .contact-card.whatsapp .contact-icon {
            color: #25D366; /* WhatsApp Green */
        }

        .contact-card.email .contact-icon {
            color: var(--accent-color); /* Bright Gold */
        }

        .contact-card.phone .contact-icon {
            color: var(--info-color); /* Muted Gold */
        }

        .contact-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .contact-card p {
            margin-bottom: 20px;
            flex: 1;
            color: var(--gray-text);
        }

        .contact-btn {
            display: inline-block;
            padding: 10px 25px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            margin-top: auto; /* Push button to bottom */
        }

        .contact-btn:hover {
            background-color: var(--accent-light);
            color: var(--light-text);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .contact-form-container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .contact-form-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .contact-form-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        #contact-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        #contact-form input,
        #contact-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #fafafa;
        }

        #contact-form textarea {
            resize: vertical;
            min-height: 120px;
        }

        #contact-form input:focus,
        #contact-form textarea:focus {
            border-color: var(--accent-color); /* Bright Gold */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3); /* Golden focus ring */
            background-color: var(--card-bg);
        }


        /* About Us Page Styles */
        #about-page .about-section {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        #about-page .about-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #about-page .about-section h3 i {
            color: var(--accent-color);
        }
        #about-page .about-section p, #about-page .about-section ul {
            color: var(--gray-text);
            margin-bottom: 15px;
        }
        #about-page .about-section ul {
            list-style: disc;
            padding-left: 20px;
        }
        #about-page .about-section ul li {
            margin-bottom: 8px;
        }
        #about-page .about-section strong {
            color: var(--dark-text);
        }
        .map-container {
            position: relative;
            overflow: hidden;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: var(--border-radius);
        }
        .map-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        #about-page .disclaimer {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--dark-gray);
            border-left: 3px solid var(--warning-color);
            padding-left: 10px;
            margin-top: 20px;
        }


        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--light-color-rgb), 0.8); /* Warm off-white overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            background-color: var(--card-bg);
            padding: 30px 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-hover);
            color: var(--dark-text);
        }

        .loader-content i {
            font-size: 2.5rem;
            color: var(--accent-color); /* Bright Gold spinner */
            margin-bottom: 15px;
            display: block;
        }

        .loader-content p {
            font-weight: 500;
            color: var(--dark-text);
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        /* Notification System */
        #notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: calc(100% - 40px);
            max-width: 380px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: var(--light-text);
            box-shadow: var(--shadow-hover);
            animation: slideInRight 0.4s ease-out, fadeOut 0.5s ease-in 3.5s forwards; /* Default animation */
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative; /* For close button positioning */
        }
        .notification.persistent {
             animation: slideInRight 0.4s ease-out forwards; /* Only slide in, no auto fadeOut */
        }


        @keyframes slideInRight {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut { /* Used by .notification by default */
            from { opacity: 1; transform: scale(1) translateX(0); }
            to { opacity: 0; transform: scale(0.9) translateX(20px); } /* Slight slide out while fading */
        }

        .notification i {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .notification.success { background-color: var(--success-color); } /* Dark Olive Green */
        .notification.error { background-color: var(--danger-color); } /* Deep Red */
        .notification.warning { background-color: var(--warning-color); color: var(--dark-text); } /* GoldenRod, Dark Text */
        .notification.info { background-color: var(--info-color); color: var(--dark-text); } /* Muted Gold, Dark Text */

        .notification-close-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-left: auto;
            padding: 0 5px;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .notification-close-btn:hover {
            opacity: 1;
        }


        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--primary-dark-rgb), 0.7); /* Darker Brown backdrop */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
            opacity: 0;
            max-height: 90vh; /* Ensure modal is scrollable if content overflows */
            overflow-y: auto;
        }
         /* Larger modal for terms/privacy/about */
        .modal-content.large {
            max-width: 800px;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-icon {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-icon i {
            font-size: 3.5rem;
            display: none;
        }

        .modal-icon i.success { display: block; color: var(--success-color); }
        .modal-icon i.warning { display: block; color: var(--warning-color); }
        .modal-icon i.error { display: block; color: var(--danger-color); }
        /* No specific modal icon for info, but can be added if needed */


        .modal h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-dark); /* Darkest Brown */
            font-size: 1.4rem;
        }
        .modal .form-group label { /* Specific for modal labels */
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
            text-align: left;
        }


        .modal p {
            text-align: center;
            margin-bottom: 25px;
            color: var(--gray-text);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
            font-size: 0.95rem;
        }

        .modal-btn.cancel {
            background-color: var(--light-gray);
            color: var(--dark-text);
            border: 1px solid var(--medium-gray);
        }

        .modal-btn.cancel:hover {
            background-color: var(--medium-gray);
        }

        .modal-btn.confirm {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
        }
        .modal-btn.confirm.error { background-color: var(--danger-color); }
        .modal-btn.confirm.warning { background-color: var(--warning-color); color: var(--dark-text); }


        .modal-btn.confirm:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }
        .modal-btn.confirm.error:hover { background-color: var(--danger-color); opacity: 0.8; }
        .modal-btn.confirm.warning:hover { background-color: var(--warning-color); opacity: 0.8; }


        .terms-content, .privacy-content { /* Combined for similar structure */
            max-height: 80vh;
            overflow-y: auto;
        }

        .terms-text, .privacy-text { /* Combined for similar structure */
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .terms-text h4, .privacy-text h4 { /* Combined for similar structure */
            margin-top: 20px;
            color: var(--primary-color); /* Dark Brown */
            font-size: 1.1rem;
        }
        .terms-content #terms-accept.submit-btn,
        .privacy-content #privacy-accept.submit-btn { /* Combined */
             width: auto;
             margin: 20px auto 0;
             display: block;
        }

        /* Profile Modal Specific Styles */
        #profile-modal .modal-content {
            max-width: 500px; /* Slightly wider for profile content */
        }

        .profile-image-container {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        #profile-modal-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            margin-bottom: 10px;
            cursor: pointer; /* Make it look clickable for upload */
        }

        #profile-image-upload {
            display: none; /* Hide actual file input */
        }
        #profile-upload-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: var(--dark-text);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        #profile-upload-label:hover {
            background-color: var(--secondary-light);
        }
        #profile-modal .password-strength { /* Re-scope for profile modal */
             margin-bottom:15px; /* Add some space below if new pass confirmed */
        }


        /* Responsive Styles */
        @media (max-width: 992px) {
            .stat-card.large {
                grid-column: span 1;
            }
            .modal-content.large {
                max-width: 90%;
            }
        }


        @media (max-width: 768px) {
            .stats-container, .referral-stats, .earnings-stats {
                grid-template-columns: 1fr;
            }

            .app-title {
                font-size: 2rem;
            }

            .auth-form {
                padding: 25px;
            }

            .side-menu {
                width: 260px;
                left: -270px;
            }
             .side-menu.active {
                left: 0;
            }


            .main-content {
                padding: 15px;
            }

            .quick-actions {
                flex-direction: row;
                justify-content: space-around;
            }
            .quick-action {
                flex-basis: calc(33.33% - 10px);
            }

            .contact-methods {
                grid-template-columns: 1fr;
            }
            #notification-container {
                top: 70px;
                width: calc(100% - 30px);
            }
            .slide img {
                height: 250px;
            }
             #about-page .about-section {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            #auth-options {
                flex-direction: column;
                gap: 15px;
            }

            .auth-btn {
                width: 100%;
            }
            .auth-form {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 0 10px;
            }
            .modal-content.large {
                 padding: 20px;
                 margin: 0 10px;
            }


            .modal-buttons {
                flex-direction: column-reverse;
                gap: 10px;
            }

            .modal-btn {
                width: 100%;
            }

            .history-filter, .earnings-filter {
                flex-direction: column;
                align-items: stretch;
            }
            .history-filter select, .earnings-filter select {
                width: 100%;
            }
            .quick-action {
                flex-basis: calc(50% - 8px);
            }
            .app-logo h1 {
                font-size: 1rem;
            }
            .slide img {
                height: 200px;
            }
            .prev, .next {
                padding: 12px;
                font-size: 16px;
            }
            .dot {
                height: 10px;
                width: 10px;
            }
            .deposit-methods .method-card {
                min-width: 130px; /* Adjusted for potentially 3 cards */
                padding: 10px;
            }
            .deposit-methods .method-card img {
                height: 30px;
            }
            .detail-label {
                width: 100%;
                margin-bottom: 3px;
            }
            .detail-value-container {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .detail-value {
                width: 100%;
                margin-bottom: 5px;
            }
            .copy-address-btn {
                margin-left: 0;
                margin-top: 5px;
            }
        }

    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container" class="container">
        <div class="logo-container">
            <img src="https://iili.io/3s46Tjj.png" alt="Crypto Harvest Logo" class="logo">
            <h1 class="app-title">Crypto Harvest</h1>
        </div>

        <div id="auth-options">
            <button id="show-register-form-btn" class="auth-btn animate__animated animate__fadeInUp glowing-btn-hover">Register</button>
            <button id="show-login-form-btn" class="auth-btn animate__animated animate__fadeInUp glowing-btn-hover">Login</button>
        </div>

        <div id="register-form" class="auth-form hidden">
            <h2>Create Account</h2>
            <div class="form-group">
                <i class="fas fa-user"></i>
                <input type="text" id="reg-name" placeholder="Full Name" required aria-label="Full Name">
            </div>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reg-email" placeholder="Email Address" required aria-label="Email Address">
            </div>
            <div class="form-group password-container has-strength">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-password" placeholder="Password" required aria-label="Password" autocomplete="new-password">
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
                <div class="password-strength">
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-text"></span>
                </div>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-confirm-password" placeholder="Confirm Password" required aria-label="Confirm Password" autocomplete="new-password">
            </div>
            <div class="form-group">
                <i class="fas fa-user-plus"></i>
                <input type="text" id="reg-invite" placeholder="Invitation Code (Optional)" aria-label="Invitation Code">
            </div>
            <div class="form-group terms">
                <input type="checkbox" id="reg-terms" aria-labelledby="terms-label">
                <label for="reg-terms" id="terms-label">I agree to the <a href="#" id="terms-link">Terms & Conditions</a> and <a href="#" id="privacy-link">Privacy Policy</a></label>
            </div>
            <button id="submit-register" class="submit-btn glowing-btn-hover">
                <span class="btn-text">Register</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Already have an account? <span id="switch-to-login">Login</span></p>
        </div>

        <div id="login-form" class="auth-form hidden">
            <h2>Login</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="login-email" placeholder="Email Address" required aria-label="Email Address" autocomplete="email">
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="login-password" placeholder="Password" required aria-label="Password" autocomplete="current-password">
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
            </div>
            <span id="forgot-password-link">Forgot Password?</span>
            <button id="submit-login" class="submit-btn glowing-btn-hover">
                <span class="btn-text">Login</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Don't have an account? <span id="switch-to-register">Register</span></p>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="menu-toggle" id="menu-toggle" aria-label="Toggle Menu">
                <i class="fas fa-bars"></i>
            </div>
            <div class="app-logo">
                <img src="https://iili.io/3s46Tjj.png" alt="Crypto Harvest Logo">
                <h1>Crypto Harvest</h1>
            </div>
            <div class="user-info">
                <div class="balance-container">
                    <span id="user-balance">$0.00</span>
                    <i class="fas fa-sync-alt refresh-balance" id="refresh-balance" title="Refresh Balance" aria-label="Refresh Balance"></i>
                </div>
                <div class="user-avatar" id="user-profile" aria-label="User Profile Menu" role="button" tabindex="0">
                    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Avatar" id="header-user-avatar-img">
                    <span class="online-status"></span>
                </div>
            </div>
        </header>

        <!-- Email Verification Notice -->
        <div id="email-verification-notice" class="hidden">
            Your email is not verified. Please check your inbox (and spam folder) for the verification link.
            <button id="resend-verification-email-btn">Resend Email</button>
        </div>

        <!-- Side Menu -->
        <nav class="side-menu" id="side-menu" aria-label="Main Navigation">
            <div class="menu-header">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Profile" id="menu-user-img"> <!-- Default user profile image -->
                <h3 id="menu-username">User Name</h3>
                <span id="menu-user-email">user@example.com</span>
                <div class="user-level">
                    <span id="user-level-badge">Standard</span>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item active" data-page="home"><i class="fas fa-home" aria-hidden="true"></i> <span>Home</span></li>
                <li class="menu-item" data-page="team"><i class="fas fa-users" aria-hidden="true"></i> <span>Team & MLM</span></li>
                <li class="menu-item" data-page="plans"><i class="fas fa-box-open" aria-hidden="true"></i> <span>Plans</span></li>
                <li class="menu-item" data-page="deposit"><i class="fas fa-money-bill-wave" aria-hidden="true"></i> <span>Deposit</span></li>
                <li class="menu-item" data-page="withdraw"><i class="fas fa-wallet" aria-hidden="true"></i> <span>Withdraw</span></li>
                <li class="menu-item" data-page="deposit-history"><i class="fas fa-history" aria-hidden="true"></i> <span>Deposit History</span></li>
                <li class="menu-item" data-page="withdraw-history"><i class="fas fa-clock" aria-hidden="true"></i> <span>Withdraw History</span></li>
                <li class="menu-item" data-page="earnings"><i class="fas fa-chart-line" aria-hidden="true"></i> <span>Earnings</span></li>
                <li class="menu-item" data-page="about"><i class="fas fa-info-circle" aria-hidden="true"></i> <span>About Us</span></li> <!-- NEW -->
                <li class="menu-item" data-page="contact"><i class="fas fa-headset" aria-hidden="true"></i> <span>Contact Us</span></li>
                <li class="menu-item" id="logout-btn"><i class="fas fa-sign-out-alt" aria-hidden="true"></i> <span>Logout</span></li>
            </ul>
            <div class="menu-footer">
                <p>Version 2.2.0 (Profile Edit)</p>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden" aria-live="assertive" aria-atomic="true">
                <div class="loader-content">
                    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Home Page -->
            <div class="page" id="home-page">
                 <!--
                    VERY IMPORTANT NOTE ON LANGUAGE:
                    Phrases like "Earn Daily 5% Returns" and "guaranteed daily returns"
                    are extremely risky from a legal and trust perspective.
                    They strongly suggest a Ponzi scheme or unsustainable high-yield investment program (HYIP).
                    Platforms like ScamAdviser will heavily penalize sites using such language.
                    CONSIDER REPHRASING to something like:
                    "Potential for daily earnings based on plan performance."
                    "Explore our investment plans and their potential returns."
                    NEVER GUARANTEE profits in investments. This is crucial for user trust and legal compliance.
                -->
                <div class="slideshow-container">
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1620714223084-8fcacc6dfd8d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGludmVzdG1lbnQlMjBncm93dGh8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60" alt="Investment Growth Concept">
                        <div class="slide-content">
                            <h3>Potential for Daily 5% Returns</h3> <!-- MODIFIED LANGUAGE -->
                            <p>Invest in our plans and explore potential daily returns.</p> <!-- MODIFIED LANGUAGE -->
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8cmVmZXJyYWwlMjBwcm9ncmFtfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60" alt="Referral Program Concept">
                        <div class="slide-content">
                            <h3>MLM Rewards: Up to 3 Levels!</h3>
                            <p>Earn commissions from your downline network.</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.pexels.com/photos/50987/money-card-business-credit-card-50987.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Easy Withdrawals Concept">
                        <div class="slide-content">
                            <h3>Easy Withdrawals</h3>
                            <p>Withdraw your earnings via USDT (BEP20/TRC20) or Easypaisa.</p>
                        </div>
                    </div>
                    <a class="prev" onclick="plusSlides(-1)" aria-label="Previous Slide">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)" aria-label="Next Slide">&#10095;</a>
                </div>
                <br>
                <div class="dot-container" style="text-align:center" aria-label="Slideshow Controls">
                    <span class="dot" onclick="currentSlide(1)" aria-label="Go to slide 1"></span>
                    <span class="dot" onclick="currentSlide(2)" aria-label="Go to slide 2"></span>
                    <span class="dot" onclick="currentSlide(3)" aria-label="Go to slide 3"></span>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-wallet" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Balance</h3>
                            <p id="total-balance">$0.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-crown" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Plan</h3>
                            <p id="active-plan">None</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Daily Plan Earnings</h3>
                            <p id="daily-earnings">$0.00</p>
                        </div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sitemap" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total MLM Commissions</h3>
                            <p id="home-total-mlm-commissions">$0.00</p>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action glowing-btn-hover" id="quick-deposit">
                        <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                        <span>Deposit</span>
                    </button>
                    <button class="quick-action glowing-btn-hover" id="quick-withdraw">
                        <i class="fas fa-wallet" aria-hidden="true"></i>
                        <span>Withdraw</span>
                    </button>
                    <button class="quick-action glowing-btn-hover" id="quick-invite">
                        <i class="fas fa-user-plus" aria-hidden="true"></i>
                        <span>Invite (Team)</span>
                    </button>
                </div>

                <div class="announcement-card">
                    <h3><i class="fas fa-bullhorn" aria-hidden="true"></i> Announcement</h3>
                    <div class="announcement-content">
                        <p id="announcement-text">Welcome to Crypto Harvest with our new MLM system! Grow your network and earn multi-level commissions. Start exploring our plans today!</p> <!-- MODIFIED LANGUAGE -->
                    </div>
                </div>
            </div>

            <!-- Team Page -->
            <div class="page hidden" id="team-page">
                <div class="page-header">
                    <h2>Your Team & MLM Network</h2>
                </div>

                <div class="invitation-section">
                    <h3><i class="fas fa-user-plus" aria-hidden="true"></i> Your Invitation Code</h3>
                    <div class="invite-code-container">
                        <input type="text" id="invite-code" readonly aria-label="Your Invitation Code">
                        <button id="copy-invite" class="copy-btn glowing-btn-hover">
                            <i class="far fa-copy" aria-hidden="true"></i> Copy
                        </button>
                    </div>
                    <p class="invite-note">Share this code with friends. You earn 10% from L1, 5% from L2, and 2% from L3 plan purchases!</p>

                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-users" aria-hidden="true"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Direct Referrals (L1)</h4>
                                <p id="total-direct-referrals">0</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd" aria-hidden="true"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Total Commissions Earned</h4>
                                <p id="total-commissions-earned">$0.00</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-day" aria-hidden="true"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Today's Commissions</h4>
                                <p id="today-commissions-earned">$0.00</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-bullseye" aria-hidden="true"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Direct Referral Target</h4>
                                <p id="referral-target">0/5</p>
                            </div>
                        </div>
                    </div>

                    <div class="referral-share">
                        <h4>Share Your Link:</h4>
                        <div class="share-buttons">
                            <button class="share-btn whatsapp glowing-btn-hover" aria-label="Share on WhatsApp">
                                <i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp
                            </button>
                            <button class="share-btn facebook glowing-btn-hover" aria-label="Share on Facebook">
                                <i class="fab fa-facebook" aria-hidden="true"></i> Facebook
                            </button>
                            <button class="share-btn copy-link glowing-btn-hover" aria-label="Copy Referral Link">
                                <i class="fas fa-link" aria-hidden="true"></i> Copy Link
                            </button>
                        </div>
                    </div>
                </div>

                <div class="direct-referrals-section">
                    <h3><i class="fas fa-network-wired" aria-hidden="true"></i> My Direct Referrals (Level 1)</h3>
                    <div class="table-responsive">
                        <table class="direct-referrals-table history-table" aria-label="Direct Referrals List">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Registration Date</th>
                                </tr>
                            </thead>
                            <tbody id="direct-referrals-body">
                                <!-- Filled by JS: Shows users current user directly referred -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="commissions-earned-section">
                    <h3><i class="fas fa-coins" aria-hidden="true"></i> Commissions Earned History</h3>
                    <div class="table-responsive">
                        <table class="commissions-earned-table history-table" aria-label="Commissions Earned History">
                            <thead>
                                <tr>
                                    <th>Source User</th>
                                    <th>Level</th>
                                    <th>Commission</th>
                                    <th>Trigger Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="commissions-earned-body">
                                <!-- Filled by JS: Shows commissions current user received -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <div class="ranking-header" style="margin-top: 30px;">
                    <h3>Your Current Rank</h3>
                    <div class="rank-badge" id="user-rank-badge">
                        <span>#0</span>
                        <i class="fas fa-trophy" aria-hidden="true"></i>
                    </div>
                </div>
                <button id="view-ranking-btn" class="action-btn glowing-btn-hover">
                    <i class="fas fa-list-ol" aria-hidden="true"></i> View Top Investors Ranking
                </button>
                <div class="ranking-table hidden" id="ranking-table-container"> <!-- Changed ID -->
                    <h3>Top 10 Investors (by Plan Amount)</h3>
                    <div class="table-responsive">
                        <table aria-label="Top Investors Ranking">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Investment</th>
                                    <th>Total Earnings (Plan + MLM)</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Plans Page -->
            <div class="page hidden" id="plans-page">
                <div class="page-header">
                    <h2>Investment Plans</h2>
                </div>
                <p class="page-description">Choose a plan to start potentially earning 5% daily returns for 30 days. Plan purchases also trigger MLM commissions for your upline.</p> <!-- MODIFIED LANGUAGE -->

                <div class="plans-container">
                    <div class="plan-card">
                        <h3>Basic Plan</h3>
                        <div class="plan-price">$5</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Daily Earnings: 5%</li> <!-- MODIFIED LANGUAGE -->
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Total Return: 150%</li> <!-- MODIFIED LANGUAGE -->
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Principal Included in potential total return</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="5">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card popular">
                        <div class="popular-badge">Most Popular</div>
                        <h3>Silver Plan</h3>
                        <div class="plan-price">$10</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Total Return: 150%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="10">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Gold Plan</h3>
                        <div class="plan-price">$25</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Total Return: 150%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="25">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Platinum Plan</h3>
                        <div class="plan-price">$50</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                           <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Total Return: 150%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="50">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Diamond Plan</h3>
                        <div class="plan-price">$100</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Potential Total Return: 150%</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle" aria-hidden="true"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="100">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </div>

                <div class="plan-info-card">
                    <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Plan Information</h3>
                    <div class="info-content">
                        <p><strong>Potential Daily Earnings:</strong> 5% of your investment amount</p> <!-- MODIFIED -->
                        <p><strong>Duration:</strong> 30 days (including weekends)</p>
                        <p><strong>Potential Total Return:</strong> 150% (Principal + 50% profit)</p> <!-- MODIFIED -->
                        <p><strong>Withdrawals:</strong> Daily earnings can be withdrawn anytime (Min. $2)</p>
                        <p><strong>Principal:</strong> Returned at the end of the plan period</p>
                        <p><strong>MLM Commissions:</strong> L1: 10%, L2: 5%, L3: 2% on plan purchases</p>
                        <p><strong>Disclaimer:</strong> All investments carry risk. Past performance is not indicative of future results. There is no guarantee of profit.</p> <!-- ADDED DISCLAIMER -->
                    </div>
                </div>
            </div>

            <!-- Deposit Page -->
            <div class="page hidden" id="deposit-page">
                <div class="page-header">
                    <h2>Deposit Funds</h2>
                </div>
                 <p class="page-description">Add funds to your account to purchase investment plans. Use USDT (BEP20/TRC20) or Easypaisa for deposits.</p>

                <div class="deposit-methods">
                    <div class="method-card active" data-method="usdt_bep20" role="button" tabindex="0" aria-pressed="true">
                        <img src="https://iili.io/3voPXmx.png" alt="USDT BEP20">
                        <span>USDT (BEP20)</span>
                    </div>
                    <div class="method-card" data-method="usdt_trc20" role="button" tabindex="0" aria-pressed="false">
                        <img src="https://iili.io/3voLiLQ.png" alt="USDT TRC20">
                        <span>USDT (TRC20)</span>
                    </div>
                    <div class="method-card" data-method="easypaisa" role="button" tabindex="0" aria-pressed="false">
                        <img src="https://iili.io/3PB0Ltp.jpg" alt="Easypaisa"> <!-- Replace with actual Easypaisa logo URL -->
                        <span>Easypaisa</span>
                    </div>
                </div>

                <div class="deposit-instructions">
                    <h3><i class="fas fa-info-circle" aria-hidden="true"></i> Deposit Instructions (<span id="deposit-method-name">USDT BEP20</span>)</h3>
                    <p id="deposit-instruction-paragraph">Send funds to the following details:</p>
                    <div class="account-details">
                        <div class="detail-item" id="deposit-detail-item-1">
                            <span class="detail-label" id="deposit-account-label1">Deposit Address (BEP20):</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="deposit-account-value1">0xeb0ee64208106984101b1f127cf221358771dbfa</span>
                                <button id="copy-deposit-value1" class="copy-address-btn" aria-label="Copy Deposit Address">
                                    <i class="far fa-copy" aria-hidden="true"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="detail-item hidden" id="deposit-detail-item-2">
                            <span class="detail-label" id="deposit-account-label2">Account Holder Name:</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="deposit-account-value2"></span>
                                <button id="copy-deposit-value2" class="copy-address-btn hidden" aria-label="Copy Account Holder Name">
                                    <i class="far fa-copy" aria-hidden="true"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="important-note">
                        <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                        <p id="deposit-important-note-text">After sending funds, fill the form below to verify your deposit. Processing time: 5-30 minutes. Ensure you send to the correct network address/account.</p>
                    </div>
                </div>

                <div class="deposit-form">
                    <h3><i class="fas fa-edit" aria-hidden="true"></i> Deposit Form</h3>
                    <div class="form-group">
                        <label for="deposit-amount">Amount (USD/PKR for Easypaisa)</label>
                        <select id="deposit-amount" class="form-select" aria-label="Select Deposit Amount">
                            <option value="">Select Amount</option>
                            <option value="5">$5 (Basic Plan)</option>
                            <option value="10">$10 (Silver Plan)</option>
                            <option value="25">$25 (Gold Plan)</option>
                            <option value="50">$50 (Platinum Plan)</option>
                            <option value="100">$100 (Diamond Plan)</option>
                            <option value="other">Other Amount</option>
                        </select>
                        <div id="custom-amount-container" class="hidden">
                            <input type="number" id="custom-amount" placeholder="Enter custom amount (Min $5 or equivalent)" min="5" aria-label="Custom Deposit Amount">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deposit-transaction" id="deposit-transaction-label">Transaction ID / Hash</label>
                        <input type="text" id="deposit-transaction" placeholder="Enter transaction ID / Hash / Easypaisa TID" required aria-label="Transaction ID or Hash">
                    </div>

                    <div class="form-group">
                        <label for="deposit-sender" id="deposit-sender-label">Your Sending Wallet Address / Easypaisa Number (Optional)</label>
                        <input type="text" id="deposit-sender" placeholder="e.g., Your USDT sending address or Easypaisa number" aria-label="Your Sending Wallet Address or Easypaisa Number">
                    </div>

                    <button id="submit-deposit" class="submit-btn glowing-btn-hover">
                        <span class="btn-text">Submit Deposit</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div class="page hidden" id="withdraw-page">
                <div class="page-header">
                    <h2>Withdraw Funds</h2>
                </div>
                <p class="page-description">Minimum withdrawal amount: $2. Max $500 per transaction. Withdrawals via USDT or Easypaisa.</p>

                <div class="withdraw-info-card">
                    <div class="info-item">
                        <i class="fas fa-wallet" aria-hidden="true"></i>
                        <div class="info-content">
                            <h4>Available Balance</h4>
                            <p id="withdraw-available-balance">$0.00</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-clock" aria-hidden="true"></i>
                        <div class="info-content">
                            <h4>Processing Time</h4>
                            <p>1-6 hours (During business hours)</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-percentage" aria-hidden="true"></i>
                        <div class="info-content">
                            <h4>Withdrawal Fee</h4>
                            <p>5% (Standard)</p>
                        </div>
                    </div>
                </div>

                <div class="withdraw-form">
                    <h3><i class="fas fa-money-bill-wave" aria-hidden="true"></i> Withdrawal Request</h3>

                    <div class="form-group">
                        <label for="withdraw-method">Withdrawal Method</label>
                        <select id="withdraw-method" class="form-select" aria-label="Select Withdrawal Method">
                            <option value="">Select Method</option>
                            <option value="usdt_bep20">USDT (BEP20)</option>
                            <option value="usdt_trc20">USDT (TRC20)</option>
                            <option value="easypaisa">Easypaisa</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="withdraw-account" id="withdraw-account-label">Your USDT Wallet Address</label>
                        <input type="text" id="withdraw-account" placeholder="Enter your USDT (BEP20/TRC20) Address" required aria-label="Your Withdrawal Account Address or Number">
                    </div>

                    <div class="form-group">
                        <label for="withdraw-name" id="withdraw-name-label">Account Holder Name (Optional for Crypto, Required for Easypaisa)</label>
                        <input type="text" id="withdraw-name" placeholder="Enter name associated with account" aria-label="Account Holder Name">
                    </div>

                    <div class="form-group">
                        <label for="withdraw-amount">Amount (USD)</label>
                        <input type="number" id="withdraw-amount" placeholder="Enter amount (Min $2)" min="2" max="500" required aria-label="Withdrawal Amount">
                        <div class="amount-buttons">
                            <button class="amount-btn" data-amount="2" aria-label="Set withdrawal amount to $2">$2</button>
                            <button class="amount-btn" data-amount="5" aria-label="Set withdrawal amount to $5">$5</button>
                            <button class="amount-btn" data-amount="10" aria-label="Set withdrawal amount to $10">$10</button>
                            <button class="amount-btn" data-amount="20" aria-label="Set withdrawal amount to $20">$20</button>
                            <button class="amount-btn" data-amount="50" aria-label="Set withdrawal amount to $50">$50</button>
                        </div>
                    </div>

                    <button id="submit-withdraw" class="submit-btn glowing-btn-hover">
                        <span class="btn-text">Request Withdrawal</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>

            <!-- Deposit History Page -->
            <div class="page hidden" id="deposit-history-page">
                <div class="page-header">
                    <h2>Deposit History</h2>
                    <div class="history-filter">
                        <select id="deposit-filter" class="form-select" aria-label="Filter Deposit History">
                            <option value="all">All Deposits</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="history-table" aria-label="Deposit History Table">
                        <thead>
                            <tr>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="deposit-history-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Deposits</h4>
                        <p id="total-deposits">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Deposits</h4>
                        <p id="pending-deposits">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Deposits</h4>
                        <p id="completed-deposits">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Withdraw History Page -->
            <div class="page hidden" id="withdraw-history-page">
                <div class="page-header">
                    <h2>Withdrawal History</h2>
                    <div class="history-filter">
                        <select id="withdraw-filter" class="form-select" aria-label="Filter Withdrawal History">
                            <option value="all">All Withdrawals</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="history-table" aria-label="Withdrawal History Table">
                        <thead>
                            <tr>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdraw-history-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Withdrawals</h4>
                        <p id="total-withdrawals">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Withdrawals</h4>
                        <p id="pending-withdrawals">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Withdrawals</h4>
                        <p id="completed-withdrawals">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Earnings Page -->
            <div class="page hidden" id="earnings-page">
                <div class="page-header">
                    <h2>Your Earnings Breakdown</h2>
                    <div class="earnings-filter">
                        <select id="earnings-period" class="form-select" aria-label="Filter Earnings Period">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>

                <div class="earnings-stats">
                    <div class="stat-card large">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Grand Total Earnings (Plan + MLM)</h3>
                            <p id="total-earnings">$0.00</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Today's Total Earnings</h3>
                            <p id="today-earnings">$0.00</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-friends" aria-hidden="true"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total MLM Commissions</h3>
                            <p id="all-referral-earnings">$0.00</p> <!-- This is specifically total MLM commissions -->
                        </div>
                    </div>
                </div>

                <div class="earnings-chart-container">
                    <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Earnings Overview (Selected Period)</h3>
                    <canvas id="earnings-chart" aria-label="Earnings Chart"></canvas>
                </div>

                <div class="earnings-table-container">
                    <h3><i class="fas fa-list" aria-hidden="true"></i> Recent Earnings (Selected Period)</h3>
                    <div class="table-responsive">
                        <table class="earnings-table history-table" aria-label="Recent Earnings Table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="earnings-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- About Us Page (NEW) -->
            <div class="page hidden" id="about-page">
                <div class="page-header">
                    <h2>About Crypto Harvest</h2>
                </div>
                <p class="page-description">Learn more about our platform, mission, and commitment to our users.</p>

                <div class="about-section">
                    <h3><i class="fas fa-building" aria-hidden="true"></i> Our Mission & Ownership</h3>
                    <p>Crypto Harvest aims to provide a user-friendly platform for exploring investment plans within the cryptocurrency space, coupled with a multi-level marketing program for community growth and rewards. Our core mission is to [Placeholder: e.g., "democratize access to crypto earning opportunities through innovative plans and a robust referral system." Replace with actual mission].</p>
                    <p><strong>Ownership:</strong> Crypto Harvest is developed and managed by [Placeholder: "a dedicated team of financial technology enthusiasts and blockchain experts." or "FutureTech Innovations Ltd." if a company name exists]. We are committed to transparency and continuous improvement of our platform.</p>
                    <p>[Placeholder: "Further details about our core team members and their expertise will be made available through official announcements as we reach new milestones."]</p>
                </div>

                <div class="about-section">
                    <h3><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Our Location (Conceptual)</h3>
                    <p>While we operate as a global online platform, our primary operational hub is conceptualized in [Placeholder: e.g., "a leading global financial technology center to ensure access to top talent and infrastructure."].</p>
                    <p>Below is a conceptual representation of a tech hub. For specific office locations, please refer to official company registry if applicable or await future announcements.</p>
                    <div class="map-container">
                        <!-- REPLACE THE SRC with your actual Google Maps embed code -->
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3022.142293706601!2d-73.98784668459495!3d40.75057897932775!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c2590118458f0d%3A0xa6c3a86775732977!2sTimes%20Square!5e0!3m2!1sen!2sus!4v1670000000000!5m2!1sen!2sus"
                                width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Conceptual Location Map"></iframe>
                    </div>
                    <p class="disclaimer">Note: The map above is for illustrative purposes only and may not represent a physical office open to the public. Crypto Harvest primarily operates as an online service.</p>
                </div>

                <div class="about-section">
                    <h3><i class="fas fa-shield-alt" aria-hidden="true"></i> Platform Integrity & User Awareness</h3>
                    <p>Your security and trust are important to us. We encourage all users to be informed and cautious.</p>

                    <h4>Our Commitment to Security (Placeholder)</h4>
                    <p>Crypto Harvest is committed to providing a secure platform. We employ security practices such as [Placeholder: e.g., "data encryption, secure authentication mechanisms, and regular security audits (if applicable)"]. However, no system is 100% immune to all threats.</p>

                    <h4>Understanding Investment Risks</h4>
                    <p>All investments, especially in the cryptocurrency space, carry inherent risks. <strong>There are no guaranteed returns.</strong> Please invest responsibly and only what you can afford to lose. Be wary of any platform or individual promising unrealistic or guaranteed high profits, as this is a common sign of a scam. Past performance is not indicative of future results.</p>

                    <h4>Identifying Potential Threats</h4>
                    <ul>
                        <li><strong>Phishing Awareness:</strong> Be cautious of unsolicited emails, text messages, or social media messages asking for your login credentials (email, password) or private keys. Always access Crypto Harvest by typing the official website URL directly into your browser. Verify the website address and look for HTTPS (secure connection).</li>
                        <li><strong>Fake Websites & Clones:</strong> Scammers may create fake websites that look very similar to ours. Always double-check the domain name before entering any information. Bookmark our official site for easy and secure access.</li>
                        <li><strong>Impersonation:</strong> Our official support team will <strong>never</strong> ask for your password, full credit card numbers, or request you to send cryptocurrency to a personal wallet for "verification" or "problem-solving." Be extremely wary of anyone claiming to be Crypto Harvest support on unofficial channels (e.g., random social media DMs).</li>
                    </ul>

                    <h4>External Reviews & Due Diligence</h4>
                    <p>We encourage users to conduct their own thorough due diligence before participating in any online investment platform. You may find independent reviews, discussions, and analyses on various online forums, social media, and cryptocurrency review sites. However, be critical of all information you find, as reviews (both positive and negative) can sometimes be manipulated or biased. Crypto Harvest does not endorse or control third-party review sites, and we are not responsible for their content.</p>
                    <p>Factors to consider when evaluating any platform:</p>
                    <ul>
                        <li><strong>Realistic Returns:</strong> Are the promised returns excessively high or "guaranteed"? This is a major red flag.</li>
                        <li><strong>Transparency:</strong> Is there clear information about how the platform operates and the risks involved?</li>
                        <li><strong>Team Information:</strong> Is there credible information about the team or company behind the platform?</li>
                        <li><strong>Community Feedback:</strong> What is the general sentiment in independent communities (be wary of overly promotional or purely negative echo chambers)?</li>
                    </ul>

                    <h4>Reporting Suspicious Activity</h4>
                    <p>If you encounter any suspicious activity, websites impersonating Crypto Harvest, or potential phishing attempts that appear to be related to our platform, please report them to us immediately through our official <a href="#" onclick="navigateToPage('contact'); return false;">Contact Us page</a>. Providing details can help us investigate and warn other users.</p>

                    <p class="disclaimer"><strong>Disclaimer:</strong> The information provided on this page is for general awareness and educational purposes only. It does not constitute financial or investment advice. Crypto Harvest is not responsible for actions taken by users on third-party sites or for losses incurred due to scams or fraudulent activities external to our direct platform operations. Users are solely responsible for their investment decisions and for maintaining the security of their accounts.</p>
                </div>

            </div>


            <!-- Contact Page -->
            <div class="page hidden" id="contact-page">
                <div class="page-header">
                    <h2>Contact Us</h2>
                </div>
                 <p class="page-description">Have questions or need help? Contact our support team.</p>

                <div class="contact-methods">
                    <div class="contact-card whatsapp">
                        <div class="contact-icon">
                            <i class="fab fa-whatsapp" aria-hidden="true"></i>
                        </div>
                        <h3>WhatsApp Support</h3>
                        <p>Contact us directly on WhatsApp for quick assistance with your queries.</p>
                        <a href="https://wa.me/YOUR_WHATSAPP_NUMBER" target="_blank" rel="noopener noreferrer" class="contact-btn glowing-btn-hover">Chat Now</a> <!-- REPLACE WITH YOUR ACTUAL NUMBER -->
                    </div>

                    <div class="contact-card email">
                        <div class="contact-icon">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                        </div>
                        <h3>Email Support</h3>
                        <p>Send us an email, and our team will respond within 24 hours.</p>
                        <a href="mailto:YOUR_SUPPORT_EMAIL@example.com" class="contact-btn glowing-btn-hover">Email Us</a> <!-- REPLACE WITH YOUR ACTUAL EMAIL -->
                    </div>

                    <div class="contact-card phone">
                        <div class="contact-icon">
                            <i class="fas fa-phone-alt" aria-hidden="true"></i>
                        </div>
                        <h3>Call Support</h3>
                        <p>Call us during business hours (10AM - 6PM, Mon-Fri, EST).</p>
                        <a href="tel:03461848433" class="contact-btn glowing-btn-hover">Call Now</a> <!-- REPLACE WITH YOUR ACTUAL NUMBER -->
                    </div>
                </div>

                <div class="contact-form-container">
                    <h3><i class="fas fa-paper-plane" aria-hidden="true"></i> Send us a Message</h3>
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">Your Name</label>
                            <input type="text" id="contact-name" placeholder="Enter your name" required aria-label="Your Name">
                        </div>

                        <div class="form-group">
                            <label for="contact-email">Email Address</label>
                            <input type="email" id="contact-email" placeholder="Enter your email" required aria-label="Your Email Address">
                        </div>

                        <div class="form-group">
                            <label for="contact-subject">Subject</label>
                            <input type="text" id="contact-subject" placeholder="Enter subject" required aria-label="Message Subject">
                        </div>

                        <div class="form-group">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" rows="5" placeholder="Enter your message" required aria-label="Your Message"></textarea>
                        </div>

                        <button type="submit" class="submit-btn glowing-btn-hover">
                            <span class="btn-text">Send Message</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification System -->
    <div id="notification-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden" role="alertdialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-message">
        <div class="modal-content animate__animated animate__fadeInDown animate__faster">
            <div class="modal-icon">
                <i class="fas fa-check-circle success" aria-hidden="true"></i>
                <i class="fas fa-exclamation-circle warning" aria-hidden="true"></i>
                <i class="fas fa-times-circle error" aria-hidden="true"></i>
            </div>
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn confirm glowing-btn-hover">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="terms-modal-title">
        <div class="modal-content terms-content large animate__animated animate__fadeInUp animate__faster">
            <h3 id="terms-modal-title">Terms & Conditions</h3>
            <div class="terms-text">
                <p><strong>Last Updated: July 2024</strong></p>

                <h4>1. Investment Plans</h4>
                <p>All investment plans offered by Crypto Harvest have a fixed duration of 30 days. Potential daily earnings are calculated at a rate of 5% of the principal investment amount. These earnings are credited daily to your account's 'earnings' sub-balance. Crypto Harvest does not guarantee profits; all investments involve risk, and past performance is not indicative of future results.</p> <!-- MODIFIED LANGUAGE -->

                <h4>2. Withdrawals</h4>
                <p>The minimum amount for withdrawal is $2 from your main 'balance'. Withdrawal requests are typically processed within 1 to 6 hours during standard business hours (10:00 AM to 6:00 PM, Monday to Friday, EST). A standard withdrawal fee of 5% applies to all transactions. Maximum withdrawal per transaction is $500. Withdrawals are processed in USDT (BEP20 or TRC20) or Easypaisa (PKR equivalent, subject to exchange rates determined by Crypto Harvest).</p>

                <h4>3. Multi-Level Marketing (MLM) Program</h4>
                <p>Users can earn commissions from their downline network up to 3 levels.
                    Level 1 (Direct Referrals): 10% commission on their plan purchases.
                    Level 2: 5% commission on their plan purchases.
                    Level 3: 2% commission on their plan purchases.
                    Commissions are calculated on the plan amount purchased by a downline member and are credited directly to the upline user's main 'balance'.
                    Participation in the MLM program is subject to compliance with all terms and ethical marketing practices.
                </p>

                <h4>4. Account Security</h4>
                <p>You are solely responsible for maintaining the confidentiality of your account credentials, including your password, and for restricting access to your computer or mobile device. Crypto Harvest is not liable for any loss or damage arising from your failure to protect your account. You must notify us immediately of any unauthorized use of your account or any other breach of security. We recommend using a strong, unique password and enabling two-factor authentication if available.</p>

                <h4>5. Amendments to Terms</h4>
                <p>Crypto Harvest reserves the right to modify these Terms & Conditions at any time without prior notice. Any changes will be effective immediately upon posting the revised terms on the platform. Your continued use of the platform after such modifications constitutes your acceptance of the new Terms & Conditions. It is your responsibility to review these Terms periodically.</p>

                <h4>6. Prohibited Activities</h4>
                <p>Users are prohibited from creating multiple accounts for abusive purposes, using automated scripts or bots to interact with the platform in unintended ways, engaging in fraudulent activities, attempting to exploit any vulnerabilities in the system, or using the platform for any illegal activities. Violation of these terms may result in account suspension or termination and forfeiture of funds, subject to applicable laws.</p>

                <h4>7. Disclaimer of Liability & Risk Disclosure</h4>
                <p>Crypto Harvest provides its services "as is" and makes no warranties regarding the platform's reliability or profitability. Investment in cryptocurrencies and related platforms involves significant risk, including the risk of losing your entire investment. Past performance is not indicative of future results. Crypto Harvest is not a financial advisor, and no content on this platform should be considered financial advice. You are solely responsible for your investment decisions. We are not responsible for any financial losses incurred by users.</p>

                <h4>8. Data Privacy</h4>
                <p>Please refer to our <a href="#" id="modal-privacy-link-from-terms">Privacy Policy</a> for information on how we collect, use, and protect your personal data.</p>

            </div>
            <button id="terms-accept" class="submit-btn glowing-btn-hover">I Understand & Accept</button>
        </div>
    </div>

    <!-- Privacy Policy Modal (NEW - Placeholder Content) -->
    <div id="privacy-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="privacy-modal-title">
        <div class="modal-content privacy-content large animate__animated animate__fadeInUp animate__faster">
            <h3 id="privacy-modal-title">Privacy Policy</h3>
            <div class="privacy-text">
                <p><strong>Last Updated: July 2024</strong></p>

                <h4>1. Information We Collect</h4>
                <p>We collect information you provide directly to us, such as when you create an account, make a deposit, or contact us. This may include:
                    <ul>
                        <li>Your name, email address, and password.</li>
                        <li>Transaction information related to deposits, withdrawals, and plan purchases.</li>
                        <li>Information about your referrals and MLM network.</li>
                        <li>Communications with us.</li>
                    </ul>
                We may also collect limited information automatically, such as IP address and device type, for security and analytics purposes.
                </p>

                <h4>2. How We Use Your Information</h4>
                <p>We use your information to:
                    <ul>
                        <li>Provide, maintain, and improve our services.</li>
                        <li>Process transactions and manage your account.</li>
                        <li>Calculate and distribute MLM commissions.</li>
                        <li>Communicate with you about your account and our services.</li>
                        <li>Ensure the security of our platform.</li>
                        <li>Comply with legal obligations.</li>
                    </ul>
                </p>

                <h4>3. Information Sharing</h4>
                <p>We do not sell your personal information. We may share your information in limited circumstances, such as:
                    <ul>
                        <li>With service providers who assist us in operating the platform (e.g., Firebase for database and authentication).</li>
                        <li>If required by law or to protect our rights or the rights of others.</li>
                        <li>In connection with a merger, sale of company assets, financing, or acquisition of all or a portion of our business by another company.</li>
                    </ul>
                Your upline/downline members may see limited information about you (e.g., name/username, level) as necessary for the MLM program to function.
                </p>

                <h4>4. Data Security</h4>
                <p>We implement reasonable security measures to protect your information. However, no security system is impenetrable, and we cannot guarantee the absolute security of your data. You are responsible for keeping your password confidential.</p>

                <h4>5. Your Choices</h4>
                <p>You can access and update certain account information through your profile. You may also request deletion of your account, subject to our data retention policies and legal obligations.</p>

                <h4>6. Cookies</h4>
                <p>We may use cookies and similar tracking technologies to enhance your experience and for analytics. You can typically set your browser to refuse cookies, but some parts of our service may not function properly.</p>

                <h4>7. Changes to This Policy</h4>
                <p>We may update this Privacy Policy from time to time. We will notify you of any significant changes by posting the new policy on our platform or by email.</p>

                <h4>8. Contact Us</h4>
                <p>If you have any questions about this Privacy Policy, please contact us through the methods provided on our Contact Us page.</p>
            </div>
            <button id="privacy-accept" class="submit-btn glowing-btn-hover">I Understand</button>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
        <div class="modal-content animate__animated animate__fadeInUp animate__faster">
            <h3 id="profile-modal-title">Edit Profile</h3>

            <div class="profile-image-container">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile Picture" id="profile-modal-img" title="Click to change photo">
                <input type="file" id="profile-image-upload" accept="image/*">
                <label for="profile-image-upload" id="profile-upload-label" role="button" tabindex="0">
                    <i class="fas fa-camera"></i> Change Photo
                </label>
                <div id="profile-image-upload-loader" class="hidden" style="margin-top: 10px;">
                    <i class="fas fa-spinner fa-spin"></i> Uploading...
                </div>
            </div>

            <div class="form-group" id="profile-form-group-name">
                <label for="profile-name">Full Name</label>
                <i class="fas fa-user"></i>
                <input type="text" id="profile-name" placeholder="Your Full Name" aria-label="Full Name">
            </div>
            <button id="save-profile-name" class="submit-btn glowing-btn-hover" style="margin-bottom: 20px;">
                <span class="btn-text">Save Name</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>

            <hr style="margin: 25px 0;">

            <h4>Change Password</h4>
            <div class="form-group password-container">
                <label for="profile-current-password">Current Password</label>
                <i class="fas fa-key"></i>
                <input type="password" id="profile-current-password" placeholder="Current Password" aria-label="Current Password" autocomplete="current-password">
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
            </div>
            <div class="form-group password-container has-strength">
                <label for="profile-new-password">New Password</label>
                <i class="fas fa-lock"></i>
                <input type="password" id="profile-new-password" placeholder="New Password" aria-label="New Password" autocomplete="new-password">
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
                <div class="password-strength">
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-text"></span>
                </div>
            </div>
            <div class="form-group password-container">
                <label for="profile-confirm-password">Confirm New Password</label>
                <i class="fas fa-lock"></i>
                <input type="password" id="profile-confirm-password" placeholder="Confirm New Password" aria-label="Confirm New Password" autocomplete="new-password">
            </div>
            <button id="save-profile-password" class="submit-btn glowing-btn-hover">
                <span class="btn-text">Change Password</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>

            <div class="modal-buttons" style="margin-top: 30px; justify-content: center;">
                <button id="profile-modal-close" class="modal-btn cancel">Close</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <!-- Added Firebase Storage -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // app.js (MLM Version - Golden Theme - Crypto Harvest with Profile Edit)

        // IMPORTANT: Firebase Security & Configuration Notes
        // 1. API Key: While this key is visible client-side, it's for identifying your Firebase project.
        //    REAL SECURITY is enforced by Firebase Security Rules and restricting your API key in Google Cloud Console.
        //    In Google Cloud Console -> APIs & Services -> Credentials:
        //    - Find your API key.
        //    - Under "Application restrictions", select "HTTP referrers (web sites)" and add your website domain(s).
        //    - Under "API restrictions", select "Restrict key" and choose only the necessary Firebase services.
        // 2. PLACEHOLDERS: Ensure ALL "YOUR_..." values below are replaced with your *actual* Firebase project details.
        const firebaseConfig = {
            apiKey: "AIzaSyAPm1qgzS0e6CJ1GOcpUGdFiFswYvS5LFg", // REPLACE with your actual API Key
            authDomain: "hunting-9f603.firebaseapp.com",     // REPLACE with your actual authDomain or ensure it's correct
            databaseURL: "https://hunting-9f603-default-rtdb.asia-southeast1.firebasedatabase.app/", // REPLACE with your actual databaseURL
            projectId: "hunting-9f603",                       // REPLACE with your actual projectId
            storageBucket: "hunting-9f603.appspot.com",       // REPLACE with your actual storageBucket
            messagingSenderId: "YOUR_ACTUAL_MESSAGING_SENDER_ID", // **CRITICAL: REPLACE**
            appId: "YOUR_ACTUAL_APP_ID"                         // **CRITICAL: REPLACE**
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage(); // Initialize Firebase Storage

        // MLM Configuration
        const MLM_COMMISSION_RATES = { 1: 0.10, 2: 0.05, 3: 0.02 }; // Level: Rate
        const MLM_MAX_LEVELS = 3;
        const MIN_WITHDRAWAL_AMOUNT = 2;
        const MAX_WITHDRAWAL_AMOUNT = 500;
        const WITHDRAWAL_FEE_PERCENTAGE = 0.05; // 5%
        const DEFAULT_PROFILE_IMG_URL = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";


        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const emailVerificationNoticeEl = document.getElementById('email-verification-notice');
        const resendVerificationEmailBtn = document.getElementById('resend-verification-email-btn');

        const showRegisterFormBtn = document.getElementById('show-register-form-btn');
        const showLoginFormBtn = document.getElementById('show-login-form-btn');

        const registerFormEl = document.getElementById('register-form');
        const loginFormEl = document.getElementById('login-form');

        const switchToLogin = document.getElementById('switch-to-login');
        const switchToRegister = document.getElementById('switch-to-register');

        const submitRegisterBtn = document.getElementById('submit-register');
        const submitLoginBtn = document.getElementById('submit-login');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        const termsLink = document.getElementById('terms-link');
        const termsModal = document.getElementById('terms-modal');
        const termsAccept = document.getElementById('terms-accept');
        const modalPrivacyLinkFromTerms = document.getElementById('modal-privacy-link-from-terms');

        const privacyLink = document.getElementById('privacy-link'); // For registration form
        const privacyModal = document.getElementById('privacy-modal');
        const privacyAccept = document.getElementById('privacy-accept');


        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationContainer = document.getElementById('notification-container');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const loadingOverlay = document.getElementById('loading-overlay');
        const refreshBalance = document.getElementById('refresh-balance');
        const quickDeposit = document.getElementById('quick-deposit');
        const quickWithdraw = document.getElementById('quick-withdraw');
        const quickInvite = document.getElementById('quick-invite');

        // Profile Modal Elements
        const userProfileTrigger = document.getElementById('user-profile');
        const profileModal = document.getElementById('profile-modal');
        const profileModalCloseBtn = document.getElementById('profile-modal-close');
        const profileModalImg = document.getElementById('profile-modal-img');
        const profileImageUploadInput = document.getElementById('profile-image-upload');
        const profileUploadLabel = document.getElementById('profile-upload-label');
        const profileImageUploadLoader = document.getElementById('profile-image-upload-loader');
        const profileNameInput = document.getElementById('profile-name');
        const saveProfileNameBtn = document.getElementById('save-profile-name');
        const profileCurrentPasswordInput = document.getElementById('profile-current-password');
        const profileNewPasswordInput = document.getElementById('profile-new-password');
        const profileConfirmPasswordInput = document.getElementById('profile-confirm-password');
        const saveProfilePasswordBtn = document.getElementById('save-profile-password');
        const headerUserAvatarImg = document.getElementById('header-user-avatar-img');


        // User data
        let currentUser = null;
        let userData = null;
        let earningsInterval = null; // For plan earnings
        let earningsChartInstance = null;
        let globalReferralCode = null; // Store parsed referral code from URL

        // =========================================================================================
        // CRITICAL SECURITY NOTE: FIREBASE REALTIME DATABASE RULES
        // =========================================================================================
        // {
        //   "rules": {
        //     "users": {
        //       "$uid": {
        //         ".read": "auth != null && auth.uid == $uid",
        //         ".write": "auth != null && auth.uid == $uid",
        //         "name": { ".write": "newData.isString() && newData.val().length > 0 && newData.val().length < 50" },
        //         "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },
        //         "profileImage": { ".write": "newData.isString() && newData.val().startsWith('https://firebasestorage.googleapis.com/') || newData.val() == null"},
        //         "balance": { ".write": "newData.isNumber()" },
        //         "earnings": { ".write": "newData.isNumber()" },
        //         "activePlan": { ".write": "newData.isNumber() || newData.val() == null" },
        //         "totalReferralEarnings": { ".write": false }, // Should be updated server-side or via transactions
        //         "uplineUids": { ".write": "!data.exists()" },
        //         "referredByUid": { ".write": "!data.exists() || data.val() == null" },
        //         "inviteCode": { ".write": "!data.exists() && newData.isString()" },
        //         "transactions": { "$transactionId": { ".write": "auth != null && auth.uid == $uid" } },
        //         "deposits": { "$depositId": {
        //             ".write": "auth != null && auth.uid == $uid && (newData.child('status').val() == 'cancelled' || !data.exists())",
        //             ".validate": "newData.hasChildren(['userId', 'amount', 'method', 'transactionId', 'date', 'status'])"
        //         }},
        //         "withdrawals": { "$withdrawalId": {
        //             ".write": "auth != null && auth.uid == $uid && (newData.child('status').val() == 'cancelled' || !data.exists())",
        //             ".validate": "newData.hasChildren(['userId', 'amount', 'method', 'account', 'date', 'status'])"
        //         }},
        //         "earningsHistory": { "$earningId": { ".write": "auth != null && auth.uid == $uid && !data.exists()" }},
        //         "referralHistory": { ".write": false }, // Should be updated by admin/system logic
        //         ".indexOn": ["activePlan", "inviteCode"]
        //       }
        //     },
        //     "admin": {
        //       "pending_deposits": { ".read": "auth != null && root.child('admins').child(auth.uid).val() === true", ".write": "auth != null && (root.child('admins').child(auth.uid).val() === true || (auth.uid == newData.child('userUid').val() && newData.child('status').val() == 'cancelled_by_user') )" },
        //       "pending_withdrawals": { ".read": "auth != null && root.child('admins').child(auth.uid).val() === true", ".write": "auth != null && (root.child('admins').child(auth.uid).val() === true || (auth.uid == newData.child('userUid').val() && newData.child('status').val() == 'cancelled_by_user') )" }
        //     },
        //     "contact_messages": {
        //       "$messageId": {
        //         ".write": "newData.hasChildren(['name', 'email', 'subject', 'message', 'date'])",
        //         ".read": "auth != null && root.child('admins').child(auth.uid).val() === true"
        //       }
        //     }
        //   }
        // }
        // =========================================================================================
        // FIREBASE STORAGE RULES (storage.rules)
        // =========================================================================================
        // rules_version = '2';
        // service firebase.storage {
        //   match /b/{bucket}/o {
        //     match /profileImages/{userId}/{fileName} { // Allow users to write to their own folder
        //       allow read; // Or more restrictive if needed
        //       allow write: if request.auth != null && request.auth.uid == userId &&
        //                    request.resource.size < 5 * 1024 * 1024 && // Max 5MB
        //                    request.resource.contentType.matches('image/.*'); // Only images
        //     }
        //   }
        // }
        // =========================================================================================


        // Initialize the app
        function init() {
            parseReferralCodeFromUrl();
            setupEventListeners();
            checkAuthState();
            autoShowFormBasedOnUrl();
        }

        function parseReferralCodeFromUrl() {
            const hash = window.location.hash; // e.g., #register?ref=XYZ
            const searchParams = new URLSearchParams(window.location.search); // e.g., ?ref=ABC

            let refCode = searchParams.get('ref');

            if (hash) {
                const hashParts = hash.split('?'); // Separate #page from ?param=value
                if (hashParts.length > 1) {
                    const hashQueryStr = hashParts[1];
                    const hashUrlParams = new URLSearchParams(hashQueryStr);
                    const refFromHash = hashUrlParams.get('ref');
                    if (refFromHash) {
                        refCode = refFromHash; // Prioritize ref from hash if present
                    }
                }
            }

            if (refCode) {
                globalReferralCode = refCode;
                console.log("Referral code from URL:", globalReferralCode);
            }
        }

        function autoShowFormBasedOnUrl() {
            const hash = window.location.hash;
            const regInviteInput = document.getElementById('reg-invite');

            if (hash.includes('#register')) {
                showAuthForm(registerFormEl);
                if (globalReferralCode && regInviteInput && !regInviteInput.value) {
                    regInviteInput.value = globalReferralCode;
                    console.log("Populated invite code field on initial load with:", globalReferralCode);
                }
            } else if (hash.includes('#login')) {
                showAuthForm(loginFormEl);
            }
        }


        function setupEventListeners() {
            showRegisterFormBtn.addEventListener('click', () => showAuthForm(registerFormEl));
            showLoginFormBtn.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToLogin.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToRegister.addEventListener('click', () => showAuthForm(registerFormEl));

            submitRegisterBtn.addEventListener('click', registerUser);
            submitLoginBtn.addEventListener('click', loginUser);
            forgotPasswordLink.addEventListener('click', handleForgotPassword);

            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.add('active');
                termsModal.classList.remove('hidden');
            });
            termsAccept.addEventListener('click', () => {
                termsModal.classList.remove('active');
                termsModal.classList.add('hidden');
            });

            privacyLink.addEventListener('click', (e) => { // For registration form
                e.preventDefault();
                privacyModal.classList.add('active');
                privacyModal.classList.remove('hidden');
            });
            modalPrivacyLinkFromTerms.addEventListener('click', (e) => { // For link inside terms modal
                e.preventDefault();
                termsModal.classList.remove('active');
                termsModal.classList.add('hidden');
                privacyModal.classList.add('active');
                privacyModal.classList.remove('hidden');
            });
            privacyAccept.addEventListener('click', () => {
                privacyModal.classList.remove('active');
                privacyModal.classList.add('hidden');
            });

            // Modal close on backdrop click
            document.addEventListener('click', (event) => {
                if (event.target === termsModal) {
                    termsModal.classList.remove('active'); termsModal.classList.add('hidden');
                }
                if (event.target === privacyModal) {
                    privacyModal.classList.remove('active'); privacyModal.classList.add('hidden');
                }
                if (event.target === confirmationModal) {
                    confirmationModal.classList.remove('active'); confirmationModal.classList.add('hidden');
                }
                if (event.target === profileModal) { // Close profile modal on backdrop click
                    profileModal.classList.remove('active'); profileModal.classList.add('hidden');
                }
            });

            menuToggle.addEventListener('click', () => sideMenu.classList.toggle('active'));

            menuItems.forEach(item => {
                if (item.id !== 'logout-btn') {
                    item.addEventListener('click', () => navigateToPage(item.dataset.page));
                }
            });

            logoutBtn.addEventListener('click', logoutUser);
            modalCancel.addEventListener('click', () => {
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
            });

            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.closest('.password-container').querySelector('input');
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                    }
                });
            });

            if (document.getElementById('reg-password')) document.getElementById('reg-password').addEventListener('input', () => checkPasswordStrength(document.getElementById('reg-password'), '#register-form'));


            const depositAmountSelect = document.getElementById('deposit-amount');
            if (depositAmountSelect) {
                depositAmountSelect.addEventListener('change', function() {
                    const customAmountContainer = document.getElementById('custom-amount-container');
                    if (this.value === 'other') customAmountContainer.classList.remove('hidden');
                    else customAmountContainer.classList.add('hidden');
                });
            }

            if (quickDeposit) quickDeposit.addEventListener('click', () => navigateToPage('deposit'));
            if (quickWithdraw) quickWithdraw.addEventListener('click', () => navigateToPage('withdraw'));
            if (quickInvite) quickInvite.addEventListener('click', () => navigateToPage('team'));
            if (refreshBalance) refreshBalance.addEventListener('click', refreshUserBalance);
            if (resendVerificationEmailBtn) resendVerificationEmailBtn.addEventListener('click', resendVerificationEmail);


            // Profile Modal Event Listeners
            if (userProfileTrigger) {
                 userProfileTrigger.addEventListener('click', openProfileModal);
                 userProfileTrigger.addEventListener('keydown', (e) => { // Accessibility
                    if (e.key === 'Enter' || e.key === ' ') openProfileModal();
                 });
            }
            if (profileModalCloseBtn) profileModalCloseBtn.addEventListener('click', closeProfileModal);
            if (profileModalImg) profileModalImg.addEventListener('click', () => profileImageUploadInput.click()); // Click image to trigger file input
            if (profileUploadLabel) profileUploadLabel.addEventListener('click', () => profileImageUploadInput.click());
            if (profileImageUploadInput) profileImageUploadInput.addEventListener('change', handleProfileImageUpload);
            if (saveProfileNameBtn) saveProfileNameBtn.addEventListener('click', handleSaveProfileName);
            if (saveProfilePasswordBtn) saveProfilePasswordBtn.addEventListener('click', handleSaveProfilePassword);
            if (profileNewPasswordInput) profileNewPasswordInput.addEventListener('input', () => checkPasswordStrength(profileNewPasswordInput, '#profile-modal'));


            initSlideshow();
            initPlanButtons();
            initTransactionButtons();
            initCopyButton();
            initRankingButton();
            initShareButtons();
            initAmountButtons();
            initContactForm();
            initHistoryFilters();
        }

        function showAuthForm(formToShow) {
            [registerFormEl, loginFormEl].forEach(form => {
                if (form) form.classList.add('hidden');
            });

            if (formToShow) {
                formToShow.classList.remove('hidden');
                if (formToShow === registerFormEl && globalReferralCode) {
                    const regInviteInput = document.getElementById('reg-invite');
                    if (regInviteInput && !regInviteInput.value) { // Only populate if empty
                        regInviteInput.value = globalReferralCode;
                        console.log("Populated invite code field in showAuthForm with:", globalReferralCode);
                    }
                }
            }

            const authOptions = document.getElementById('auth-options');
            if (authOptions) authOptions.classList.add('hidden');
        }

        function navigateToPage(pageName) {
            pages.forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                const pageHeading = targetPage.querySelector('h2');
                if (pageHeading) pageHeading.focus();
            } else {
                console.error(`Page with ID ${pageName}-page not found.`);
                document.getElementById('home-page').classList.remove('hidden');
                document.getElementById('home-page').querySelector('h3')?.focus();
            }

            menuItems.forEach(item => item.classList.remove('active'));
            const activeMenuItem = document.querySelector(`.menu-item[data-page="${pageName}"]`);
            if (activeMenuItem) activeMenuItem.classList.add('active');

            sideMenu.classList.remove('active');

            if (pageName === 'team') initTeamPage();
            else if (pageName === 'plans') initPlansPage();
            else if (pageName === 'deposit') initDepositPage();
            else if (pageName === 'withdraw') initWithdrawPage();
            else if (pageName === 'earnings') initEarningsPage();
            else if (pageName === 'deposit-history') loadDepositHistory();
            else if (pageName === 'withdraw-history') loadWithdrawHistory();
            else if (pageName === 'about') initAboutPage();
        }

        function checkAuthState() {
            showLoading();
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    authContainer.classList.add('hidden');
                    document.getElementById('auth-options').classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    if (!user.emailVerified) {
                        emailVerificationNoticeEl.classList.remove('hidden');
                    } else {
                        emailVerificationNoticeEl.classList.add('hidden');
                    }
                } else {
                    currentUser = null;
                    userData = null;
                    authContainer.classList.remove('hidden');
                    document.getElementById('auth-options').classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    emailVerificationNoticeEl.classList.add('hidden');

                    if (!window.location.hash.includes('#register') && !window.location.hash.includes('#login')) {
                         showAuthForm(loginFormEl);
                    }


                    if (earningsInterval) {
                        clearInterval(earningsInterval);
                        earningsInterval = null;
                    }
                    hideLoading();
                }
            });
        }

        function loadUserData(userId) {
            showLoading();
            database.ref('users/' + userId).on('value', snapshot => {
                userData = snapshot.val();
                if (userData) {
                    updateUI();
                    startEarningsCalculation();
                } else {
                    console.warn("User data not found for UID:", userId, "Logging out.");
                    logoutUser();
                }
                hideLoading();
            }, error => {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data. Please try again. Details: ' + error.message, 'error');
                logoutUser();
                hideLoading();
            });
        }

        function refreshUserBalance() {
            if (!currentUser) return;
            showLoading();
            database.ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val(); // This will trigger the 'on' listener and update UI
                    if (userData) {
                        showNotification('Balance refreshed!', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing balance:', error);
                    showNotification('Error refreshing balance: ' + error.message, 'error');
                })
                .finally(() => hideLoading());
        }

        function updateUI() {
            if (!currentUser || !userData) return;
            const userProfilePic = userData.profileImage || DEFAULT_PROFILE_IMG_URL;

            document.getElementById('menu-username').textContent = userData.name || 'User';
            document.getElementById('menu-user-email').textContent = userData.email || currentUser.email || 'Email Not Set';
            document.getElementById('menu-user-img').src = userProfilePic;
            if(headerUserAvatarImg) headerUserAvatarImg.src = userProfilePic;


            updateBalanceDisplay();

            const activePlanAmount = userData.activePlan || 0;
            const activePlanName = activePlanAmount > 0 ? `${getPlanName(activePlanAmount)} ($${activePlanAmount})` : 'None';
            document.getElementById('active-plan').textContent = activePlanName;

            const dailyPlanEarningsVal = activePlanAmount > 0 ? (activePlanAmount * 0.05) : 0;
            document.getElementById('daily-earnings').textContent = `$${dailyPlanEarningsVal.toFixed(2)}`;

            document.getElementById('home-total-mlm-commissions').textContent = `$${(userData.totalReferralEarnings || 0).toFixed(2)}`;

            document.getElementById('invite-code').value = userData.inviteCode || currentUser.uid.slice(0, 8).toUpperCase();

            const directReferralCount = userData.downline ? Object.keys(userData.downline).length : 0;
            document.getElementById('total-direct-referrals').textContent = directReferralCount;
            document.getElementById('total-commissions-earned').textContent = `$${(userData.totalReferralEarnings || 0).toFixed(2)}`;

            const today = new Date().toISOString().split('T')[0];
            let todayCommissions = 0;
            if (userData.referralHistory) {
                Object.values(userData.referralHistory).forEach(entry => {
                    if (entry.date && entry.date.startsWith(today)) {
                        todayCommissions += entry.amount || 0;
                    }
                });
            }
            document.getElementById('today-commissions-earned').textContent = `$${todayCommissions.toFixed(2)}`;

            const referralTargetCount = 5;
            document.getElementById('referral-target').textContent = `${directReferralCount}/${referralTargetCount} ${directReferralCount >= referralTargetCount ? '(Completed)' : ''}`;

            document.getElementById('user-rank-badge').innerHTML = `<span>#${userData.rank || 'N/A'}</span> <i class="fas fa-trophy"></i>`;

            let level = "Standard";
            if (userData.activePlan >= 100) level = "Diamond Investor";
            else if (userData.activePlan >= 50) level = "Platinum Investor";
            else if (userData.activePlan >= 25) level = "Gold Investor";
            else if (userData.activePlan >= 10) level = "Silver Investor";
            else if (userData.activePlan >= 5) level = "Basic Investor";
            document.getElementById('user-level-badge').textContent = level;

            if (document.getElementById('team-page') && !document.getElementById('team-page').classList.contains('hidden')) {
                loadDirectReferrals();
                loadCommissionsEarnedHistory();
            }
            if (document.getElementById('earnings-page') && !document.getElementById('earnings-page').classList.contains('hidden')) {
                loadEarningsHistory();
            }
        }

        function getPlanName(amount) {
            const plans = { 5: "Basic", 10: "Silver", 25: "Gold", 50: "Platinum", 100: "Diamond" };
            return plans[amount] ? `${plans[amount]} Plan` : "Custom Plan";
        }

        function updateBalanceDisplay() {
            if (!userData) return;
            const currentBalance = userData.balance || 0;
            const currentPlanEarnings = userData.earnings || 0;
            const totalAvailable = currentBalance + currentPlanEarnings;

            document.getElementById('user-balance').textContent = `$${totalAvailable.toFixed(2)}`;
            document.getElementById('total-balance').textContent = `$${totalAvailable.toFixed(2)}`;

            const withdrawAvailEl = document.getElementById('withdraw-available-balance');
            if (withdrawAvailEl) withdrawAvailEl.textContent = `$${totalAvailable.toFixed(2)}`;
        }

        async function registerUser() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const termsAccepted = document.getElementById('reg-terms').checked;
            const inviteCodeInput = document.getElementById('reg-invite').value.trim();

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!name || !email || !password || !confirmPassword) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (name.length > 50) {
                showNotification('Full name should not exceed 50 characters.', 'error'); return;
            }
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address.', 'error'); return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match.', 'error'); return;
            }
            if (password.length < 8 || !validatePassword(password)) {
                showNotification('Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.', 'error', true); return;
            }
            if (!termsAccepted) {
                showNotification('Please accept the Terms & Conditions and Privacy Policy.', 'error'); return;
            }
             if (inviteCodeInput && inviteCodeInput.length > 20) {
                showNotification('Invitation code seems too long.', 'error'); return;
            }


            showLoadingButton(submitRegisterBtn, true);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                currentUser = user;

                await user.updateProfile({ displayName: name }); // Update Firebase Auth profile name
                await user.sendEmailVerification();
                showNotification('Registration successful! Please check your email to verify your account. This is crucial for full account functionality.', 'success', true);

                const newUserRef = database.ref('users/' + user.uid);
                const newUserData = {
                    name: name,
                    email: email,
                    profileImage: DEFAULT_PROFILE_IMG_URL,
                    balance: 0,
                    earnings: 0,
                    totalReferralEarnings: 0,
                    activePlan: null,
                    planStartDate: null,
                    lastEarningsUpdate: null,
                    inviteCode: generateInviteCode(),
                    referredBy: inviteCodeInput || null, // This is the invite code they used
                    referredByUid: null, // This will be the UID of the referrer
                    uplineUids: {},
                    downline: {},
                    registrationDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    rank: "New"
                };

                await newUserRef.set(newUserData);

                if (inviteCodeInput) {
                    await setupMLMUplines(inviteCodeInput, user.uid, name, email);
                }
                registerFormEl.reset();
            } catch (error) {
                console.error("Registration error:", error);
                showNotification('Registration failed: ' + (error.code === 'auth/email-already-in-use' ? 'This email is already registered. Try logging in.' : error.message), 'error');
            } finally {
                showLoadingButton(submitRegisterBtn, false, "Register");
            }
        }

        async function setupMLMUplines(referrerInviteCode, newUserId, newUserName, newUserEmail) {
            if (!referrerInviteCode) return;

            try {
                const snapshot = await database.ref('users').orderByChild('inviteCode').equalTo(referrerInviteCode).once('value');
                if (snapshot.exists()) {
                    const referrerUid = Object.keys(snapshot.val())[0];
                    const referrerData = snapshot.val()[referrerUid];

                    if (!referrerData) {
                        console.warn("Referrer data is unexpectedly null for UID:", referrerUid);
                        await database.ref(`users/${newUserId}`).update({ attemptedInviteCode: referrerInviteCode, referralError: "ReferrerDataNull" });
                        return;
                    }

                    const updates = {};
                    updates[`users/${newUserId}/referredByUid`] = referrerUid;

                    const newUserUplines = {};
                    newUserUplines.level1 = referrerUid;
                    if (referrerData.uplineUids && referrerData.uplineUids.level1) {
                        newUserUplines.level2 = referrerData.uplineUids.level1;
                    }
                    if (referrerData.uplineUids && referrerData.uplineUids.level2) {
                        newUserUplines.level3 = referrerData.uplineUids.level2;
                    }
                    updates[`users/${newUserId}/uplineUids`] = newUserUplines;

                    updates[`users/${referrerUid}/downline/${newUserId}`] = {
                        name: newUserName,
                        email: newUserEmail,
                        registrationDate: new Date().toISOString()
                    };

                    await database.ref().update(updates);
                    console.log(`MLM uplines set for ${newUserId}. Added to ${referrerUid}'s downline.`);
                } else {
                    console.warn("Referrer with invite code not found:", referrerInviteCode);
                    await database.ref(`users/${newUserId}`).update({ attemptedInviteCode: referrerInviteCode, referralError: "ReferrerNotFound" });
                }
            } catch (error) {
                console.error("Error setting up MLM uplines: ", error);
                 await database.ref(`users/${newUserId}`).update({ referralError: `SetupError: ${error.message.substring(0,100)}` });
            }
        }


        function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('Please enter email and password.', 'error'); return;
            }

            showLoadingButton(submitLoginBtn, true);
            auth.signInWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    if (userCredential.user) {
                        await database.ref('users/' + userCredential.user.uid).update({ lastLogin: new Date().toISOString() });
                        showNotification('Login successful!', 'success');
                    }
                    loginFormEl.reset();
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    let message = 'Login failed. Please check your credentials.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        message = 'Invalid email or password.';
                    } else if (error.code === 'auth/too-many-requests') {
                        message = 'Too many login attempts. Please try again later.';
                    } else {
                        message = 'Login failed: ' + error.message;
                    }
                    showNotification(message, 'error');
                })
                .finally(() => {
                    showLoadingButton(submitLoginBtn, false, "Login");
                });
        }

        function handleForgotPassword() {
            const email = prompt("Please enter your email address to reset your password:");
            if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showLoading();
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showNotification('Password reset email sent to ' + email + '. Check your inbox and spam folder.', 'success');
                    })
                    .catch((error) => {
                        console.error("Forgot password error:", error);
                        let message = 'Error sending reset email.';
                        if (error.code === 'auth/user-not-found') {
                            message = 'No account found with this email address.';
                        } else {
                            message = 'Error sending reset email: ' + error.message;
                        }
                        showNotification(message, 'error');
                    })
                    .finally(() => hideLoading());
            } else if (email) {
                showNotification('Please enter a valid email address.', 'error');
            }
        }

        function resendVerificationEmail() {
            if (currentUser && !currentUser.emailVerified) {
                showLoadingButton(resendVerificationEmailBtn, true, "Sending...");
                currentUser.sendEmailVerification()
                    .then(() => {
                        showNotification('Verification email resent! Please check your inbox and spam folder.', 'success', true);
                    })
                    .catch((error) => {
                        console.error("Resend verification error:", error);
                        showNotification('Error resending email: ' + error.message, 'error');
                    })
                    .finally(() => {
                        showLoadingButton(resendVerificationEmailBtn, false, "Resend Email");
                        resendVerificationEmailBtn.disabled = true;
                        setTimeout(() => { resendVerificationEmailBtn.disabled = false; }, 60000);
                    });
            }
        }

        function generateInviteCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = 'CH';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function validatePassword(password) {
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`])[A-Za-z\d!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]{8,}$/;
            return regex.test(password);
        }

        function checkPasswordStrength(passwordInputEl, formSelector) {
            const password = passwordInputEl.value;
            const strengthBars = document.querySelectorAll(`${formSelector} .strength-bar`);
            const strengthText = document.querySelector(`${formSelector} .strength-text`);

            if (!strengthBars.length || !strengthText) return; // Elements not found in the current form context

            let score = 0;
            if (!password) {
                strengthBars.forEach(bar => bar.className = 'strength-bar');
                strengthText.textContent = '';
                return;
            }

            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[a-z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)) score++;


            strengthBars.forEach((bar, index) => bar.className = 'strength-bar' );

            if (score <= 2) {
                strengthBars[0].classList.add('weak');
                strengthText.textContent = 'Weak'; strengthText.style.color = 'var(--danger-color)';
            } else if (score >= 3 && score <= 4) {
                strengthBars[0].classList.add('medium'); strengthBars[1].classList.add('medium');
                strengthText.textContent = 'Medium'; strengthText.style.color = 'var(--warning-color)';
            } else {
                strengthBars.forEach(b => b.classList.add('strong'));
                strengthText.textContent = 'Strong'; strengthText.style.color = 'var(--success-color)';
            }
        }


        function logoutUser() {
            showLoading();
            auth.signOut()
                .then(() => { /* Handled by onAuthStateChanged */ })
                .catch(error => {
                    console.error("Logout error:", error);
                    showNotification('Error logging out: ' + error.message, 'error');
                })
                .finally(() => { /* onAuthStateChanged will hide loading */ });
        }

        function showLoadingButton(buttonElement, isLoading, defaultText = "Submit") {
            const btnTextEl = buttonElement.querySelector('.btn-text');
            const btnLoaderEl = buttonElement.querySelector('.btn-loader');

            if (isLoading) {
                if(btnTextEl) btnTextEl.classList.add('hidden');
                if(btnLoaderEl) btnLoaderEl.classList.remove('hidden');
                buttonElement.disabled = true;
                buttonElement.setAttribute('aria-busy', 'true');
            } else {
                if(btnTextEl) {
                    btnTextEl.classList.remove('hidden');
                    if (defaultText) btnTextEl.textContent = defaultText;
                }
                if(btnLoaderEl) btnLoaderEl.classList.add('hidden');
                buttonElement.disabled = false;
                buttonElement.removeAttribute('aria-busy');
            }
        }

        function showNotification(message, type, persistent = false) {
            if (!notificationContainer) {
                console.error("Notification container not found!");
                return;
            }
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate__animated`;
            notification.setAttribute('role', type === 'error' || type === 'warning' ? 'alert' : 'status');

            if (persistent) {
                 notification.classList.add('persistent');
            }

            let iconClass;
            switch (type) {
                case 'success': iconClass = 'fa-check-circle'; break;
                case 'error': iconClass = 'fa-times-circle'; break;
                case 'warning': iconClass = 'fa-exclamation-triangle'; break;
                case 'info': iconClass = 'fa-info-circle'; break;
                default: iconClass = 'fa-bell';
            }
            notification.innerHTML = `<i class="fas ${iconClass}" aria-hidden="true"></i><span>${message}</span>`;
            notificationContainer.appendChild(notification);

            if (persistent) {
                 const closeBtn = document.createElement('button');
                 closeBtn.innerHTML = '&times;';
                 closeBtn.className = 'notification-close-btn';
                 closeBtn.setAttribute('aria-label', 'Close notification');
                 closeBtn.onclick = () => notification.remove();
                 notification.appendChild(closeBtn);
            } else {
                 notification.addEventListener('animationend', (event) => {
                    if (event.animationName === 'fadeOut') {
                        notification.remove();
                    }
                 });
            }
        }


        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }

        let slideIndex = 1;
        let slideshowTimeout;

        function initSlideshow() { showSlides(slideIndex); }
        function plusSlides(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex += n); }
        function currentSlide(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex = n); }

        function showSlides(n) {
            let i;
            const slides = document.getElementsByClassName("slide");
            const dots = document.getElementsByClassName("dot");
            if (slides.length === 0 || dots.length === 0) return;

            if (n > slides.length) {slideIndex = 1}
            if (n < 1) {slideIndex = slides.length}

            for (i = 0; i < slides.length; i++) slides[i].style.display = "none";
            for (i = 0; i < dots.length; i++) dots[i].className = dots[i].className.replace(" active-dot", "");

            slides[slideIndex-1].style.display = "block";
            dots[slideIndex-1].className += " active-dot";

            slideshowTimeout = setTimeout(() => { plusSlides(1); }, 5000);
        }

        function initPlanButtons() {
            const buyButtons = document.querySelectorAll('.buy-plan-btn');
            buyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const planAmount = parseInt(this.dataset.plan);
                    purchasePlan(planAmount, this);
                });
            });
        }

        function initPlansPage() {
            if (!currentUser || !currentUser.emailVerified) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Verify Email";
                });
                return;
            }

            if (userData && userData.activePlan) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Plan Active";
                });
            } else {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').textContent = "Buy Now";
                });
            }
        }

        async function purchasePlan(planAmount, buttonElement) {
            if (!currentUser || !userData) {
                showNotification('Please login to purchase a plan.', 'error'); return;
            }
            if (!currentUser.emailVerified) {
                showNotification('Please verify your email before purchasing a plan.', 'warning', true);
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }

            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);

            if (totalAvailableBalance < planAmount) {
                showNotification('Insufficient balance. Please deposit funds.', 'error'); return;
            }

            if (userData.activePlan) {
                showNotification('You already have an active plan. Wait for it to complete or contact support.', 'error'); return;
            }
            showConfirmationModal(
                `Confirm Plan Purchase`,
                `Purchase ${getPlanName(planAmount)} for $${planAmount}? This will utilize funds from your balance. Potential earnings are not guaranteed. This will also trigger MLM commissions for your upline.`,
                async () => {
                    showLoadingButton(buttonElement, true);

                    let newPlanEarnings = userData.earnings || 0;
                    let newMainBalance = userData.balance || 0;
                    let amountFromPlanEarnings = 0;
                    let amountFromMainBalance = 0;

                    if (newPlanEarnings >= planAmount) {
                        amountFromPlanEarnings = planAmount;
                        newPlanEarnings -= planAmount;
                    } else {
                        amountFromPlanEarnings = newPlanEarnings;
                        const remaining = planAmount - newPlanEarnings;
                        newPlanEarnings = 0;
                        amountFromMainBalance = remaining;
                        newMainBalance -= remaining;
                    }

                    const updates = {
                        balance: newMainBalance,
                        earnings: newPlanEarnings,
                        activePlan: planAmount,
                        planStartDate: new Date().toISOString(),
                        lastEarningsUpdate: new Date().toISOString()
                    };

                    try {
                        await database.ref('users/' + currentUser.uid).update(updates);
                        const logEntry = {
                            type: 'plan_purchase',
                            amount: planAmount,
                            planName: getPlanName(planAmount),
                            date: new Date().toISOString(),
                            deductedFromBalance: amountFromMainBalance,
                            deductedFromEarnings: amountFromPlanEarnings
                        };
                        await database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);

                        showNotification(`${getPlanName(planAmount)} purchased successfully! Potential daily plan earnings: $${(planAmount * 0.05).toFixed(2)}.`, 'success');

                        if (document.getElementById('plans-page') && !document.getElementById('plans-page').classList.contains('hidden')) {
                            initPlansPage();
                        }
                        startEarningsCalculation();

                        await awardMLMCommissions(currentUser.uid, planAmount, 'plan_purchase');

                    } catch (error) {
                        console.error("Plan purchase error:", error);
                        showNotification(`Purchase error: ${error.message}. Your balance might not have been updated correctly. Please contact support if issues persist.`, 'error', true);
                    } finally {
                        showLoadingButton(buttonElement, false, "Buy Now");
                    }
                }, 'success'
            );
        }

        async function awardMLMCommissions(sourceUserUid, triggerAmount, triggerAction = 'plan_purchase') {
            if (!sourceUserUid || triggerAmount <= 0) return;
            console.log(`Attempting to award MLM commissions for ${sourceUserUid} from ${triggerAmount} purchase.`);

            try {
                const sourceUserSnapshot = await database.ref(`users/${sourceUserUid}`).once('value');
                if (!sourceUserSnapshot.exists()) {
                    console.error("Source user for MLM commission not found:", sourceUserUid);
                    return;
                }
                const sourceUserData = sourceUserSnapshot.val();

                if (!sourceUserData.uplineUids || Object.keys(sourceUserData.uplineUids).length === 0) {
                    console.log("Source user has no uplines:", sourceUserUid);
                    return;
                }

                for (let level = 1; level <= MLM_MAX_LEVELS; level++) {
                    const uplineUid = sourceUserData.uplineUids[`level${level}`];
                    if (uplineUid) {
                        const commissionRate = MLM_COMMISSION_RATES[level];
                        if (commissionRate) {
                            const commissionAmount = parseFloat((triggerAmount * commissionRate).toFixed(2));

                            if (commissionAmount > 0) {
                                const uplineUserRef = database.ref(`users/${uplineUid}`);
                                await uplineUserRef.transaction(uplineData => {
                                    if (uplineData) {
                                        uplineData.balance = parseFloat(((uplineData.balance || 0) + commissionAmount).toFixed(2));
                                        uplineData.totalReferralEarnings = parseFloat(((uplineData.totalReferralEarnings || 0) + commissionAmount).toFixed(2));
                                    }
                                    return uplineData;
                                });
                                const commissionEntry = {
                                    sourceUserUid: sourceUserUid,
                                    sourceUserName: sourceUserData.name || "N/A",
                                    sourceUserEmail: sourceUserData.email || "N/A",
                                    amount: commissionAmount,
                                    level: level,
                                    date: new Date().toISOString(),
                                    triggerAction: triggerAction,
                                    triggerAmount: triggerAmount,
                                    planName: triggerAction === 'plan_purchase' ? getPlanName(triggerAmount) : null
                                };
                                await database.ref(`users/${uplineUid}/referralHistory`).push(commissionEntry);
                                console.log(`Awarded $${commissionAmount} (L${level}) to ${uplineUid}.`);
                            }
                        }
                    } else {
                        console.log(`No upline found at level ${level} for user ${sourceUserUid}.`);
                        break;
                    }
                }
            } catch (error) {
                console.error("Error awarding MLM commissions:", error);
                showNotification("Error processing MLM commissions. Please contact support.", "error", true);
            }
        }


        function startEarningsCalculation() {
            if (earningsInterval) clearInterval(earningsInterval);

            if (!currentUser || !userData || !userData.activePlan || !userData.planStartDate) {
                return;
            }

            const planStartDate = new Date(userData.planStartDate);
            const planEndDate = new Date(planStartDate);
            planEndDate.setDate(planEndDate.getDate() + 30);

            const now = new Date();

            if (now >= planEndDate) {
                const principal = userData.activePlan;
                const updates = {
                    balance: parseFloat(((userData.balance || 0) + principal).toFixed(2)),
                    activePlan: null,
                    planStartDate: null,
                    lastEarningsUpdate: null,
                    planCompletedOn: now.toISOString()
                };

                database.ref('users/' + currentUser.uid).update(updates)
                    .then(() => {
                        const logEntry = {
                            type: 'plan_completion',
                            amount: principal,
                            description: `Principal for ${getPlanName(principal)} returned to balance.`,
                            date: now.toISOString()
                        };
                        database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);
                        showNotification(`Your ${getPlanName(principal)} plan has completed! $${principal.toFixed(2)} principal returned to balance.`, 'success', true);
                    }).catch(err => console.error("Error finalizing plan completion:", err));
                return;
            }

            const lastUpdate = userData.lastEarningsUpdate ? new Date(userData.lastEarningsUpdate) : planStartDate;
            const hoursPassedSinceLastUpdate = (now - lastUpdate) / (1000 * 60 * 60);

            if (hoursPassedSinceLastUpdate >= 1) {
                const planAmount = userData.activePlan;
                const hourlyPlanEarnings = (planAmount * 0.05) / 24;
                const missedPlanEarnings = hourlyPlanEarnings * Math.floor(hoursPassedSinceLastUpdate);

                if (missedPlanEarnings > 0) {
                    const newTotalPlanEarnings = (userData.earnings || 0) + missedPlanEarnings;
                    const earningsUpdate = {
                        earnings: parseFloat(newTotalPlanEarnings.toFixed(2)),
                        lastEarningsUpdate: now.toISOString()
                    };
                    const logEntry = {
                        type: 'investment_earning',
                        amount: parseFloat(missedPlanEarnings.toFixed(2)),
                        plan: planAmount,
                        date: now.toISOString(),
                        description: `Hourly plan earnings catch-up`
                    };
                    database.ref(`users/${currentUser.uid}/earningsHistory`).push(logEntry);
                    database.ref('users/' + currentUser.uid).update(earningsUpdate)
                        .catch(err => console.error("Error updating catch-up earnings:", err));
                }
            }

            earningsInterval = setInterval(() => {
                if (!currentUser || !userData || !userData.activePlan) {
                    clearInterval(earningsInterval);
                    return;
                }
                 const currentActivePlan = userData.activePlan; // Use live userData value
                 const currentPlanStartDate = new Date(userData.planStartDate);
                 const currentPlanEndDate = new Date(currentPlanStartDate);
                 currentPlanEndDate.setDate(currentPlanEndDate.getDate() + 30);

                if (new Date() >= currentPlanEndDate) {
                    clearInterval(earningsInterval);
                    startEarningsCalculation(); // Re-evaluate plan status
                    return;
                }

                const planAmount = currentActivePlan;
                const hourlyRate = (planAmount * 0.05) / 24;

                const newTotalPlanEarnings = (userData.earnings || 0) + hourlyRate;
                const updateData = {
                    earnings: parseFloat(newTotalPlanEarnings.toFixed(2)),
                    lastEarningsUpdate: new Date().toISOString()
                };

                const logEntry = {
                    type: 'investment_earning',
                    amount: parseFloat(hourlyRate.toFixed(2)),
                    plan: planAmount,
                    date: new Date().toISOString(),
                    description: `Regular hourly plan earning`
                };
                database.ref(`users/${currentUser.uid}/earningsHistory`).push(logEntry);

                database.ref('users/' + currentUser.uid).update(updateData)
                .catch(err => console.error("Error updating hourly plan earnings:", err));

            }, 3600000); // Every hour
        }

        function initTransactionButtons() {
            const depositButton = document.getElementById('submit-deposit');
            if (depositButton) depositButton.addEventListener('click', submitDepositRequest);

            const withdrawButton = document.getElementById('submit-withdraw');
            if (withdrawButton) withdrawButton.addEventListener('click', submitWithdrawalRequest);
        }

        function initDepositPage() {
            const methodCards = document.querySelectorAll('#deposit-page .method-card');
            const depositMethodNameEl = document.getElementById('deposit-method-name');

            const detailItem1 = document.getElementById('deposit-detail-item-1');
            const detailLabel1 = document.getElementById('deposit-account-label1');
            const detailValue1 = document.getElementById('deposit-account-value1');
            const copyBtn1 = document.getElementById('copy-deposit-value1');

            const detailItem2 = document.getElementById('deposit-detail-item-2');
            const detailLabel2 = document.getElementById('deposit-account-label2');
            const detailValue2 = document.getElementById('deposit-account-value2');
            const copyBtn2 = document.getElementById('copy-deposit-value2');

            const instructionParagraphEl = document.getElementById('deposit-instruction-paragraph');
            const importantNoteTextEl = document.getElementById('deposit-important-note-text');
            const transactionLabelEl = document.getElementById('deposit-transaction-label');
            const senderLabelEl = document.getElementById('deposit-sender-label');
            const transactionInputEl = document.getElementById('deposit-transaction');

            const depositDetails = {
                usdt_bep20: {
                    address: '0xeb0ee64208106984101b1f127cf221358771dbfa',
                    name: 'USDT (BEP20)',
                    label1: 'Deposit Address (BEP20):',
                    note: "After sending USDT, fill the form below to verify your deposit. Processing time: 5-30 minutes after admin verification. Ensure you send to the correct network address (BEP20)."
                },
                usdt_trc20: {
                    address: 'TKEmWeig1jtWLgPZp4pX4PHAsPsrFNdqf2',
                    name: 'USDT (TRC20)',
                    label1: 'Deposit Address (TRC20):',
                    note: "After sending USDT, fill the form below to verify your deposit. Processing time: 5-30 minutes after admin verification. Ensure you send to the correct network address (TRC20)."
                },
                easypaisa: {
                    number: '03709912807',
                    holder: 'Memoona Zohra',
                    name: 'Easypaisa',
                    label1: 'Easypaisa Account Number:',
                    label2: 'Account Holder Name:',
                    note: "Send payment to the Easypaisa account above. Then, enter the Transaction ID (TID) from your Easypaisa app and submit the form. Processing time: 5-30 minutes after admin verification."
                }
            };

            function updateDepositInstructionsUI(selectedMethodKey) {
                const details = depositDetails[selectedMethodKey];
                if (!details) return;

                depositMethodNameEl.textContent = details.name;
                instructionParagraphEl.textContent = `Send funds to the following ${details.name} details:`;
                importantNoteTextEl.innerHTML = details.note;

                detailLabel1.textContent = details.label1;
                detailValue1.textContent = details.address || details.number;
                copyBtn1.classList.remove('hidden');

                if (selectedMethodKey === 'easypaisa') {
                    detailItem2.classList.remove('hidden');
                    detailLabel2.textContent = details.label2;
                    detailValue2.textContent = details.holder;
                    copyBtn2.classList.add('hidden'); // Typically don't copy holder name
                    transactionLabelEl.textContent = "Easypaisa Transaction ID (TID)";
                    transactionInputEl.placeholder = "Enter Easypaisa TID (e.g., 12345678901)";
                    senderLabelEl.textContent = "Your Sending Easypaisa Number (Optional)";
                } else {
                    detailItem2.classList.add('hidden');
                    transactionLabelEl.textContent = "Transaction ID / Hash";
                     transactionInputEl.placeholder = "Enter transaction ID or hash (e.g., 0x123abc...)";
                    senderLabelEl.textContent = "Your Sending Wallet Address (Optional)";
                }
            }


            methodCards.forEach(card => {
                card.addEventListener('click', function() {
                    methodCards.forEach(c => {
                        c.classList.remove('active');
                        c.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-pressed', 'true');
                    const method = this.dataset.method;
                    updateDepositInstructionsUI(method);
                });
                card.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        this.click();
                    }
                });
            });

            if (copyBtn1) {
                copyBtn1.addEventListener('click', () => {
                    const textToCopy = detailValue1.textContent;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showNotification('Copied to clipboard!', 'success');
                    }).catch(err => {
                        showNotification('Failed to copy. Please copy manually.', 'error');
                        console.error('Copy failed:', err);
                    });
                });
            }

            const defaultActiveCard = document.querySelector('#deposit-page .method-card.active');
            if (defaultActiveCard) {
                updateDepositInstructionsUI(defaultActiveCard.dataset.method);
            } else if (methodCards.length > 0) {
                methodCards[0].click();
            }
        }


        function submitDepositRequest() {
            if (!currentUser || !currentUser.emailVerified) {
                showNotification('Please verify your email before making a deposit.', 'warning', true);
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }

            const amountSelect = document.getElementById('deposit-amount');
            let amount = amountSelect.value === 'other' ?
                parseFloat(document.getElementById('custom-amount').value) :
                parseFloat(amountSelect.value);

            const transactionId = document.getElementById('deposit-transaction').value.trim();
            const senderAddress = document.getElementById('deposit-sender').value.trim();
            const method = document.querySelector('#deposit-page .method-card.active')?.dataset.method;

            if (!method) {
                showNotification('Please select a deposit method.', 'error'); return;
            }
            if (!amount || isNaN(amount) || amount < (method === 'easypaisa' ? 1400 : 5) ) { // Assuming $1 = 280 PKR for min check
                showNotification(`Invalid amount. Minimum deposit is ${method === 'easypaisa' ? 'approx. 1400 PKR (equivalent of $5)' : '$5'}.`, 'error'); return;
            }
            if (!transactionId) {
                showNotification('Please enter the Transaction ID / Hash.', 'error'); return;
            }
            if (transactionId.length < 10 || transactionId.length > 100) {
                showNotification('Transaction ID seems invalid. Please check.', 'error'); return;
            }
            if (senderAddress && senderAddress.length > 100) {
                showNotification('Sender address/number seems too long.', 'error'); return;
            }


            const submitDepositBtn = document.getElementById('submit-deposit');
            showLoadingButton(submitDepositBtn, true);

            const depositData = {
                userId: currentUser.uid,
                userName: userData.name || "N/A",
                userEmail: currentUser.email,
                amount: amount,
                currency: method === 'easypaisa' ? 'PKR' : 'USD',
                method: method,
                transactionId: transactionId,
                senderAddress: senderAddress,
                date: new Date().toISOString(),
                status: 'pending'
            };

            const depositKey = database.ref(`users/${currentUser.uid}/deposits`).push().key;
            database.ref(`users/${currentUser.uid}/deposits/${depositKey}`).set({...depositData, id: depositKey})
            .then(() => {
                // Also add to an admin queue for processing
                database.ref(`admin/pending_deposits/${depositKey}`).set({...depositData, userUid: currentUser.uid, depositId: depositKey });

                showNotification('Deposit request submitted! It will be processed after admin verification (typically 5-30 mins during business hours).', 'success', true);
                const depositForm = document.querySelector('#deposit-page .deposit-form');
                if (depositForm) depositForm.reset();
                document.getElementById('custom-amount-container').classList.add('hidden');
                amountSelect.value = "";
            })
            .catch(error => {
                console.error("Deposit submission error:", error);
                showNotification(`Deposit error: ${error.message}. Please try again or contact support.`, 'error');
            })
            .finally(() => {
                showLoadingButton(submitDepositBtn, false, "Submit Deposit");
            });
        }

        function initWithdrawPage() {
            if (userData) updateBalanceDisplay(); // Update balance display when page loads
            const withdrawMethodSelect = document.getElementById('withdraw-method');
            if(withdrawMethodSelect) {
                withdrawMethodSelect.addEventListener('change', function() {
                    updateWithdrawalFormUI(this.value);
                });
                updateWithdrawalFormUI(withdrawMethodSelect.value); // Initial UI setup
            }
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            if (withdrawAmountInput) {
                withdrawAmountInput.min = MIN_WITHDRAWAL_AMOUNT;
                withdrawAmountInput.max = MAX_WITHDRAWAL_AMOUNT;
                withdrawAmountInput.placeholder = `Enter amount (Min $${MIN_WITHDRAWAL_AMOUNT}, Max $${MAX_WITHDRAWAL_AMOUNT})`;
            }
        }

        function updateWithdrawalFormUI(selectedMethod) {
            const accountInput = document.getElementById('withdraw-account');
            const accountLabel = document.getElementById('withdraw-account-label');
            const nameInput = document.getElementById('withdraw-name');
            const nameLabel = document.getElementById('withdraw-name-label');

            if (!accountInput || !accountLabel || !nameInput || !nameLabel) return;

            if (selectedMethod === 'easypaisa') {
                accountLabel.textContent = 'Your Easypaisa Account Number';
                accountInput.placeholder = 'Enter 11-digit Easypaisa Account Number';
                accountInput.type = 'tel';
                accountInput.pattern = "\\d{11}";
                nameLabel.textContent = 'Account Holder Name (Required for Easypaisa)';
                nameInput.required = true;
            } else if (selectedMethod === 'usdt_bep20' || selectedMethod === 'usdt_trc20') {
                const network = selectedMethod.split('_')[1].toUpperCase();
                accountLabel.textContent = `Your USDT (${network}) Wallet Address`;
                accountInput.placeholder = `Enter your USDT (${network}) Address (e.g., 0x... or T...)`;
                accountInput.type = 'text';
                accountInput.removeAttribute('pattern');
                nameLabel.textContent = 'Account Holder Name (Optional for Crypto)';
                nameInput.required = false;
            } else { // Default/No selection
                accountLabel.textContent = 'Your Wallet Address / Account Number';
                accountInput.placeholder = 'Select method first';
                accountInput.type = 'text';
                accountInput.removeAttribute('pattern');
                nameLabel.textContent = 'Account Holder Name (Optional)';
                nameInput.required = false;
            }
        }


        function initAmountButtons() {
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            document.querySelectorAll('#withdraw-page .amount-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    if(withdrawAmountInput) withdrawAmountInput.value = this.dataset.amount;
                });
            });
        }

        function submitWithdrawalRequest() {
            if (!currentUser || !currentUser.emailVerified) {
                showNotification('Please verify your email before making a withdrawal.', 'warning', true);
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }

            const method = document.getElementById('withdraw-method').value;
            const account = document.getElementById('withdraw-account').value.trim();
            const name = document.getElementById('withdraw-name').value.trim();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);

            if (!method) {
                showNotification('Please select a withdrawal method.', 'error'); return;
            }
            if (!account) {
                showNotification(`Please enter your ${method === 'easypaisa' ? 'Easypaisa Account Number' : 'USDT Wallet Address'}.`, 'error'); return;
            }
             if (method === 'easypaisa' && !name) {
                showNotification('Please enter the Account Holder Name for Easypaisa withdrawal.', 'error'); return;
            }
            if (isNaN(amount) || amount <= 0) {
                showNotification('Please enter a valid withdrawal amount.', 'error'); return;
            }
            if (method === 'easypaisa' && (!/^\d{11}$/.test(account))) {
                showNotification('Please enter a valid 11-digit Easypaisa account number.', 'error'); return;
            } else if (method === 'usdt_bep20' && !/^0x[a-fA-F0-9]{40}$/.test(account)) {
                 showNotification('Invalid USDT (BEP20) address format.', 'error'); return;
            } else if (method === 'usdt_trc20' && !/^T[A-Za-z1-9]{33}$/.test(account)) {
                 showNotification('Invalid USDT (TRC20) address format.', 'error'); return;
            }


            if (amount < MIN_WITHDRAWAL_AMOUNT) {
                showNotification(`Minimum withdrawal is $${MIN_WITHDRAWAL_AMOUNT}.`, 'error'); return;
            }
            if (amount > MAX_WITHDRAWAL_AMOUNT) {
                showNotification(`Maximum withdrawal is $${MAX_WITHDRAWAL_AMOUNT}.`, 'error'); return;
            }

            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);
            if (amount > totalAvailableBalance) {
                showNotification('Insufficient total available balance.', 'error'); return;
            }

            const feeAmount = parseFloat((amount * WITHDRAWAL_FEE_PERCENTAGE).toFixed(2));
            const netAmountToReceive = parseFloat((amount - feeAmount).toFixed(2));
            const amountToDeduct = amount; // Total amount to deduct from user's balance

            const withdrawalData = {
                userId: currentUser.uid,
                userName: userData.name || "N/A",
                userEmail: currentUser.email,
                method: method,
                account: account,
                name: name,
                requestedAmount: amount,
                currency: method === 'easypaisa' ? 'PKR_equivalent' : 'USD',
                fee: feeAmount,
                netAmount: netAmountToReceive,
                date: new Date().toISOString(),
                status: 'pending'
            };

            showConfirmationModal(
                'Confirm Withdrawal',
                `Withdraw $${amount.toFixed(2)} via ${method.toUpperCase().replace('_', ' ')} to ${account}? <br>Fee: $${feeAmount.toFixed(2)}. You will receive approximately: $${netAmountToReceive.toFixed(2)}${method === 'easypaisa' ? ' (PKR equivalent, subject to current exchange rate)' : ''}.`,
                async () => {
                    const submitWithdrawBtn = document.getElementById('submit-withdraw');
                    showLoadingButton(submitWithdrawBtn, true);

                    // Deduct from balance (earnings first, then main balance)
                    let newPlanEarnings = userData.earnings || 0;
                    let newMainBalance = userData.balance || 0;

                    if (newPlanEarnings >= amountToDeduct) {
                        newPlanEarnings -= amountToDeduct;
                    } else {
                        const remainingToDeduct = amountToDeduct - newPlanEarnings;
                        newPlanEarnings = 0;
                        newMainBalance -= remainingToDeduct;
                    }

                    const balanceUpdate = {
                        earnings: parseFloat(newPlanEarnings.toFixed(2)),
                        balance: parseFloat(newMainBalance.toFixed(2))
                    };

                    try {
                        // 1. Update user's balance in DB
                        await database.ref('users/' + currentUser.uid).update(balanceUpdate);

                        // 2. Add withdrawal request to user's history
                        const withdrawalKey = database.ref(`users/${currentUser.uid}/withdrawals`).push().key;
                        await database.ref(`users/${currentUser.uid}/withdrawals/${withdrawalKey}`).set({...withdrawalData, id: withdrawalKey});

                        // 3. Add withdrawal request to admin processing queue
                        await database.ref(`admin/pending_withdrawals/${withdrawalKey}`).set({...withdrawalData, userUid: currentUser.uid, withdrawalId: withdrawalKey});

                        showNotification('Withdrawal request submitted! Processing takes 1-6 hours after admin approval during business hours.', 'success', true);
                        const withdrawForm = document.querySelector('#withdraw-page .withdraw-form');
                        if(withdrawForm) withdrawForm.reset();
                        document.getElementById('withdraw-method').value = ""; // Reset select
                        updateWithdrawalFormUI(""); // Reset UI based on empty selection


                    } catch (error) {
                        console.error("Withdrawal submission error:", error);
                        showNotification(`Withdrawal error: ${error.message}. Please try again or contact support.`, 'error', true);
                        // Note: Consider if a rollback mechanism for balance deduction is needed here on failure.
                        // For simplicity, this example doesn't implement complex transaction rollbacks.
                    } finally {
                        showLoadingButton(submitWithdrawBtn, false, "Request Withdrawal");
                    }
                }, 'warning'
            );
        }

        function initCopyButton() {
            const copyButton = document.getElementById('copy-invite');
            const inviteCodeInput = document.getElementById('invite-code');
            if (copyButton && inviteCodeInput) {
                copyButton.addEventListener('click', () => {
                    inviteCodeInput.select();
                    inviteCodeInput.setSelectionRange(0, 99999); // For mobile devices
                    try {
                        navigator.clipboard.writeText(inviteCodeInput.value).then(() => {
                             showNotification('Invite code copied!', 'success');
                        }).catch(err => {
                            showNotification('Failed to copy code. Please copy manually.', 'error');
                            console.error('Copy invite code failed:', err);
                        });
                    } catch (err) {
                        // Fallback for older browsers (less common now)
                        showNotification('Failed to copy code. Please copy manually.', 'error');
                        console.error('Copy invite code (fallback) failed:', err);
                    }
                });
            }
        }

        function initShareButtons() {
            const inviteCodeEl = document.getElementById('invite-code');
            const baseAppUrl = window.location.origin + window.location.pathname; // Or your actual base URL

            document.querySelector('.share-btn.whatsapp')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (userData?.inviteCode || "DEMOCODE");
                const referralLink = `${baseAppUrl}#register?ref=${inviteCode}`;
                const message = `Join Crypto Harvest with my invite code: ${inviteCode} and explore potential earnings with MLM! Sign up here: ${referralLink}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank', 'noopener,noreferrer');
            });

            document.querySelector('.share-btn.facebook')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (userData?.inviteCode || "DEMOCODE");
                const referralLink = `${baseAppUrl}#register?ref=${inviteCode}`;
                const message = `Join Crypto Harvest with my invite code: ${inviteCode} and explore potential earnings with MLM!`;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}&quote=${encodeURIComponent(message)}`, '_blank', 'noopener,noreferrer');
            });

            document.querySelector('.share-btn.copy-link')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (userData?.inviteCode || "DEMOCODE");
                const link = `${baseAppUrl}#register?ref=${inviteCode}`;
                navigator.clipboard.writeText(link)
                    .then(() => showNotification('Referral link copied!', 'success'))
                    .catch((err) => {
                        showNotification('Failed to copy link. Please copy manually.', 'error');
                        console.error('Copy link failed:', err);
                    });
            });
        }

        function initRankingButton() {
            const viewRankingBtn = document.getElementById('view-ranking-btn');
            const rankingTableDiv = document.getElementById('ranking-table-container');
            if (viewRankingBtn && rankingTableDiv) {
                viewRankingBtn.addEventListener('click', () => {
                    const isHidden = rankingTableDiv.classList.contains('hidden');
                    if (isHidden) {
                        loadUserRankings();
                        rankingTableDiv.classList.remove('hidden');
                        viewRankingBtn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Ranking`;
                        viewRankingBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        rankingTableDiv.classList.add('hidden');
                        viewRankingBtn.innerHTML = `<i class="fas fa-list-ol"></i> View Top Investors Ranking`;
                        viewRankingBtn.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        }

        function initTeamPage() {
            loadDirectReferrals();
            loadCommissionsEarnedHistory();
        }

        function initAboutPage() {
            console.log("About page initialized.");
        }


        function loadUserRankings() {
            showLoading();
            database.ref('users').orderByChild('activePlan').limitToLast(20).once('value') // Get users with activePlan (could be many if nulls are counted)
                .then(snapshot => {
                    const rankings = [];
                    snapshot.forEach(userSnapshot => {
                        const user = userSnapshot.val();
                        if (user.name && user.activePlan && user.activePlan > 0) { // Ensure activePlan is a positive number
                            rankings.push({
                                id: userSnapshot.key,
                                name: user.name.substring(0, 1) + '***' + user.name.substring(user.name.length -1), // Anonymize name
                                investment: user.activePlan,
                                totalEarnings: (user.earnings || 0) + (user.totalReferralEarnings || 0)
                            });
                        }
                    });

                    // Sort by investment amount (desc), then by total earnings (desc)
                    rankings.sort((a, b) => b.investment - a.investment || b.totalEarnings - a.totalEarnings);

                    const rankingBody = document.getElementById('ranking-body');
                    if (!rankingBody) { hideLoading(); return; }
                    rankingBody.innerHTML = ''; // Clear previous entries

                    const top10 = rankings.slice(0, 10);
                    if (top10.length === 0) {
                        rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No active investors found.</td></tr>';
                    } else {
                        top10.forEach((user, index) => {
                            const row = document.createElement('tr');
                            if (currentUser && user.id === currentUser.uid) {
                                row.classList.add('current-user');
                            }
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${user.name}</td>
                                <td>$${user.investment.toFixed(0)}</td>
                                <td>$${user.totalEarnings.toFixed(2)}</td>
                            `;
                            rankingBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading rankings:", error);
                    showNotification('Error loading rankings: ' + error.message, 'error');
                })
                .finally(() => hideLoading());
        }

        function loadDepositHistory() {
            const depositHistoryBody = document.getElementById('deposit-history-body');
            if (!depositHistoryBody) return;

            if (!currentUser || !userData || !userData.deposits) {
                depositHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No deposit history.</td></tr>';
                updateDepositSummary(0, 0, 0);
                return;
            }

            const filterValue = document.getElementById('deposit-filter')?.value || 'all';
            const depositsArray = Object.entries(userData.deposits).map(([key, value]) => ({ ...value, id: key }));

            depositHistoryBody.innerHTML = '';

            const filteredDeposits = depositsArray
                .filter(d => filterValue === 'all' || d.status === filterValue)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredDeposits.length === 0) {
                 depositHistoryBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No deposits match '${filterValue}'.</td></tr>`;
            } else {
                filteredDeposits.forEach(deposit => {
                    const row = document.createElement('tr');
                    const amountDisplay = deposit.currency === 'PKR' ? `PKR ${deposit.amount.toFixed(0)}` : `$${deposit.amount.toFixed(2)}`;
                    row.innerHTML = `
                        <td>${amountDisplay}</td>
                        <td>${deposit.method ? deposit.method.toUpperCase().replace('_', ' ') : 'N/A'}</td>
                        <td>${formatDate(deposit.date)}</td>
                        <td class="status-${deposit.status}">${deposit.status.charAt(0).toUpperCase() + deposit.status.slice(1)}</td>
                        <td>
                            ${deposit.status === 'pending' ?
                                `<span class="action-link" data-id="${deposit.id}" data-type="deposit" role="button" tabindex="0">Cancel</span>` :
                                '--'}
                        </td>
                    `;
                    depositHistoryBody.appendChild(row);
                });
            }
            let summaryTotalUSD = 0, summaryPendingUSD = 0, summaryCompletedUSD = 0;
            const PKR_TO_USD_RATE = 1/280; // Approx rate, should be dynamic or configurable

            depositsArray.forEach(d => {
                const amountInUSD = d.currency === 'PKR' ? (d.amount * PKR_TO_USD_RATE) : d.amount;
                if (d.status === 'completed') summaryCompletedUSD += amountInUSD;
                if (d.status === 'pending') summaryPendingUSD += amountInUSD;
                summaryTotalUSD += amountInUSD;
            });
            updateDepositSummary(summaryTotalUSD, summaryPendingUSD, summaryCompletedUSD);

            attachCancelListeners(depositHistoryBody, 'deposit');
        }

        function updateDepositSummary(total, pending, completed) {
            document.getElementById('total-deposits').textContent = `$${total.toFixed(2)}`;
            document.getElementById('pending-deposits').textContent = `$${pending.toFixed(2)}`;
            document.getElementById('completed-deposits').textContent = `$${completed.toFixed(2)}`;
        }

        function loadWithdrawHistory() {
            const withdrawHistoryBody = document.getElementById('withdraw-history-body');
             if (!withdrawHistoryBody) return;

            if (!currentUser || !userData || !userData.withdrawals) {
                withdrawHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No withdrawal history.</td></tr>';
                updateWithdrawalSummary(0, 0, 0);
                return;
            }

            const filterValue = document.getElementById('withdraw-filter')?.value || 'all';
            const withdrawalsArray = Object.entries(userData.withdrawals).map(([key, value]) => ({ ...value, id: key }));

            withdrawHistoryBody.innerHTML = '';

            const filteredWithdrawals = withdrawalsArray
                .filter(w => filterValue === 'all' || w.status === filterValue)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredWithdrawals.length === 0) {
                 withdrawHistoryBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No withdrawals match '${filterValue}'.</td></tr>`;
            } else {
                filteredWithdrawals.forEach(withdrawal => {
                    const row = document.createElement('tr');
                     const amountDisplay = withdrawal.currency === 'PKR_equivalent' ? `$${withdrawal.requestedAmount.toFixed(2)} (PKR Eq.)` : `$${withdrawal.requestedAmount.toFixed(2)}`;
                    row.innerHTML = `
                        <td>${amountDisplay}</td>
                        <td>${withdrawal.method ? withdrawal.method.toUpperCase().replace('_', ' ') : 'N/A'}</td>
                        <td>${formatDate(withdrawal.date)}</td>
                        <td class="status-${withdrawal.status}">${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}</td>
                        <td>
                            ${withdrawal.status === 'pending' ?
                                `<span class="action-link" data-id="${withdrawal.id}" data-type="withdrawal" data-amount="${withdrawal.requestedAmount}" role="button" tabindex="0">Cancel</span>` :
                                '--'}
                        </td>
                    `;
                    withdrawHistoryBody.appendChild(row);
                });
            }
            let summaryTotal = 0, summaryPending = 0, summaryCompleted = 0;
            withdrawalsArray.forEach(w => {
                if (w.status === 'completed') summaryCompleted += w.requestedAmount;
                if (w.status === 'pending') summaryPending += w.requestedAmount;
                summaryTotal += w.requestedAmount;
            });
            updateWithdrawalSummary(summaryTotal, summaryPending, summaryCompleted);

            attachCancelListeners(withdrawHistoryBody, 'withdrawal');
        }

        function updateWithdrawalSummary(total, pending, completed) {
            document.getElementById('total-withdrawals').textContent = `$${total.toFixed(2)}`;
            document.getElementById('pending-withdrawals').textContent = `$${pending.toFixed(2)}`;
            document.getElementById('completed-withdrawals').textContent = `$${completed.toFixed(2)}`;
        }

        function attachCancelListeners(tableBody, type) {
            tableBody.querySelectorAll('.action-link').forEach(link => {
                link.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const amount = parseFloat(this.dataset.amount); // Get amount for withdrawals
                    if (type === 'deposit') cancelTransaction(id, 'deposit', 0);
                    else if (type === 'withdrawal') cancelTransaction(id, 'withdrawal', amount);
                });
                 link.addEventListener('keydown', function(event) { // Accessibility
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        this.click();
                    }
                });
            });
        }

        async function cancelTransaction(id, type, amountToRefund = 0) {
            const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
            showConfirmationModal(
                `Cancel ${capitalizedType}`,
                `Are you sure you want to cancel this ${type} request? ${type === 'withdrawal' ? 'The amount will be refunded to your balance.' : ''}`,
                async () => {
                    showLoading();
                    const userTransactionPath = `users/${currentUser.uid}/${type}s/${id}`;
                    const adminQueuePath = `admin/pending_${type}s/${id}`;

                    try {
                        // Update status in user's record and admin queue
                        await database.ref(userTransactionPath).update({ status: 'cancelled', cancelledByUserAt: new Date().toISOString() });
                        await database.ref(adminQueuePath).update({ status: 'cancelled_by_user', cancelledDate: new Date().toISOString() }); // For admin visibility

                        // Refund amount for withdrawals
                        if (type === 'withdrawal' && amountToRefund > 0 && userData) {
                            const currentBalance = userData.balance || 0;
                            const currentEarnings = userData.earnings || 0;
                            // It's simpler to just add back to main balance. Original deduction logic was complex.
                            const newMainBalance = parseFloat((currentBalance + amountToRefund).toFixed(2));
                            await database.ref(`users/${currentUser.uid}`).update({ balance: newMainBalance });
                        }

                        showNotification(`${capitalizedType} request cancelled.`, 'success');
                        if(type === 'deposit') loadDepositHistory();
                        if(type === 'withdrawal') loadWithdrawHistory();
                    } catch (error) {
                        console.error(`Error cancelling ${type}:`, error);
                        showNotification(`Error cancelling ${type}: ${error.message}. Please contact support.`, 'error', true);
                    } finally {
                        hideLoading();
                    }
                }, 'warning'
            );
        }

        function loadDirectReferrals() {
            const directReferralsBody = document.getElementById('direct-referrals-body');
            if (!directReferralsBody || !currentUser || !userData || !userData.downline) {
                if(directReferralsBody) directReferralsBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No direct referrals yet.</td></tr>';
                return;
            }

            const downlineEntries = Object.values(userData.downline);
            directReferralsBody.innerHTML = ''; // Clear previous entries

            if (downlineEntries.length === 0) {
                directReferralsBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No direct referrals yet.</td></tr>';
                return;
            }

            downlineEntries.sort((a,b) => new Date(b.registrationDate || 0) - new Date(a.registrationDate || 0)); // Sort by newest first

            downlineEntries.forEach(referralInfo => {
                const row = document.createElement('tr');
                const anonymizedEmail = referralInfo.email ? referralInfo.email.substring(0,3) + '***' + referralInfo.email.substring(referralInfo.email.indexOf('@')) : 'N/A';
                row.innerHTML = `
                    <td>${referralInfo.name || 'N/A'}</td>
                    <td>${anonymizedEmail}</td>
                    <td>${formatDate(referralInfo.registrationDate) || 'N/A'}</td>
                `;
                directReferralsBody.appendChild(row);
            });
        }

        function loadCommissionsEarnedHistory() {
            const commissionsBody = document.getElementById('commissions-earned-body');
            if (!commissionsBody) return;

            if (!currentUser || !userData || !userData.referralHistory) {
                commissionsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
                return;
            }

            const commissionsArray = Object.values(userData.referralHistory)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by newest first

            commissionsBody.innerHTML = ''; // Clear previous entries
            if (commissionsArray.length === 0) {
                 commissionsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
            } else {
                commissionsArray.forEach(commission => {
                    const row = document.createElement('tr');
                    const sourceUserDisplay = commission.sourceUserName ? commission.sourceUserName.substring(0,1) + '***' : 'User';
                    const sourceIdDisplay = commission.sourceUserUid ? `...${commission.sourceUserUid.slice(-4)}` : '';

                    row.innerHTML = `
                        <td>${sourceUserDisplay} (ID: ${sourceIdDisplay})</td>
                        <td>Level ${commission.level}</td>
                        <td>$${commission.amount.toFixed(2)}</td>
                        <td>$${commission.triggerAmount.toFixed(2)} (${commission.planName || commission.triggerAction})</td>
                        <td>${formatDate(commission.date)}</td>
                    `;
                    commissionsBody.appendChild(row);
                });
            }
        }

        function initEarningsPage() {
            loadEarningsHistory();
        }

        function loadEarningsHistory() {
            const earningsTableBody = document.getElementById('earnings-body');
            if (!earningsTableBody) return;

            if (!currentUser || !userData) {
                earningsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No earnings history.</td></tr>';
                updateEarningsSummaryOnPage(0, 0, 0);
                if (earningsChartInstance) updateChartData([], 'all');
                return;
            }

            const periodFilter = document.getElementById('earnings-period')?.value || 'all';
            const allEarningsEntries = [];

            // Collate earnings from investments
            if (userData.earningsHistory) {
                Object.values(userData.earningsHistory).forEach(entry => {
                    allEarningsEntries.push({
                        date: entry.date,
                        type: 'Investment',
                        amount: entry.amount,
                        description: `From ${entry.plan ? getPlanName(entry.plan) : 'Active Plan'}`
                    });
                });
            }
            // Collate earnings from referrals
            if (userData.referralHistory) {
                Object.values(userData.referralHistory).forEach(entry => {
                    allEarningsEntries.push({
                        date: entry.date,
                        type: 'Referral',
                        amount: entry.amount,
                        description: `L${entry.level} from ${entry.sourceUserName ? entry.sourceUserName.substring(0,1) + '***' : 'Downline'}`
                    });
                });
            }

            // Sort all entries by date
            allEarningsEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Filter by selected period
            const now = new Date();
            const filteredForPeriod = allEarningsEntries.filter(e => {
                const entryDate = new Date(e.date);
                if (periodFilter === 'today') return entryDate.toDateString() === now.toDateString();
                if (periodFilter === 'week') {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1) ); // Set to Monday of current week
                    weekStart.setHours(0,0,0,0);
                    return entryDate >= weekStart;
                }
                if (periodFilter === 'month') return entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear();
                return true; // 'all'
            });

            // Calculate summaries based on ALL entries (not just filtered period for some stats)
            let grandTotalAllTime = 0;
            let todayGrandTotal = 0;
            let totalMLMAllTime = userData.totalReferralEarnings || 0; // Get directly from user data for accuracy

            allEarningsEntries.forEach(e => {
                grandTotalAllTime += e.amount;
                if (new Date(e.date).toDateString() === new Date().toDateString()) {
                    todayGrandTotal += e.amount;
                }
            });

            updateEarningsSummaryOnPage(
                grandTotalAllTime,
                todayGrandTotal,
                totalMLMAllTime
            );

            // Populate table with PERIOD filtered data
            earningsTableBody.innerHTML = '';
            if (filteredForPeriod.length === 0) {
                earningsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No earnings for this period.</td></tr>`;
            } else {
                filteredForPeriod.slice(0, 50).forEach(earning => { // Limit to 50 entries for performance
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(earning.date)}</td>
                        <td><span class="badge ${earning.type.toLowerCase()}">${earning.type}</span></td>
                        <td>$${earning.amount.toFixed(2)}</td>
                        <td>${earning.description}</td>
                    `;
                    earningsTableBody.appendChild(row);
                });
            }
            // Update chart
            if (!earningsChartInstance) setupEarningsChart();
            updateChartData(filteredForPeriod, periodFilter);
        }

        function updateEarningsSummaryOnPage(grandTotal, todayTotal, mlmTotal) {
            document.getElementById('total-earnings').textContent = `$${grandTotal.toFixed(2)}`;
            document.getElementById('today-earnings').textContent = `$${todayTotal.toFixed(2)}`;
            document.getElementById('all-referral-earnings').textContent = `$${mlmTotal.toFixed(2)}`;
        }

        function setupEarningsChart() {
            const ctx = document.getElementById('earnings-chart')?.getContext('2d');
            if (!ctx) return;

            if (earningsChartInstance) earningsChartInstance.destroy(); // Destroy previous instance if exists

            earningsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // To be populated by updateChartData
                    datasets: [
                        {
                            label: 'Total Daily Earnings (Plan + MLM)',
                            data: [], // To be populated
                            borderColor: 'var(--accent-color)',
                            backgroundColor: 'rgba(var(--accent-color-rgb), 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                         {
                            label: 'MLM Commissions',
                            data: [], // To be populated
                            borderColor: 'var(--secondary-color)',
                            backgroundColor: 'rgba(var(--secondary-color-rgb), 0.1)',
                            fill: true,
                            tension: 0.3,
                            hidden: true // Initially hidden, user can toggle
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (USD)' },
                            ticks: { color: 'var(--gray-text)'},
                            grid: { color: 'rgba(119,119,119, 0.2)' }
                        },
                        x: {
                            title: { display: true, text: 'Date/Time Period' },
                            ticks: { color: 'var(--gray-text)'},
                            grid: { color: 'rgba(119,119,119, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: {color: 'var(--dark-text)'} },
                        title: { display: true, text: 'Earnings Trend (Selected Period)', color: 'var(--primary-dark)' }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                }
            });
        }

        function updateChartData(earningsDataForPeriod, period) {
            if (!earningsChartInstance) return;

            let labels = [];
            let totalDataPoints = [];
            let mlmDataPoints = [];

            // Aggregate data by day for the chart
            const dailyTotals = {}; // { 'YYYY-MM-DD': totalAmount }
            const dailyMlmTotals = {}; // { 'YYYY-MM-DD': mlmAmount }

            earningsDataForPeriod.forEach(e => {
                const day = new Date(e.date).toLocaleDateString('en-CA'); // YYYY-MM-DD format for sorting
                dailyTotals[day] = (dailyTotals[day] || 0) + e.amount;
                if (e.type === 'Referral') {
                    dailyMlmTotals[day] = (dailyMlmTotals[day] || 0) + e.amount;
                }
            });

            // Get sorted dates for labels
            const sortedDays = Object.keys(dailyTotals).sort((a,b) => new Date(a) - new Date(b));

            labels = sortedDays.map(dayStr => formatDate(dayStr, true)); // Short format for labels (e.g., Jul 15)
            totalDataPoints = sortedDays.map(day => dailyTotals[day] || 0);
            mlmDataPoints = sortedDays.map(day => dailyMlmTotals[day] || 0);

            earningsChartInstance.data.labels = labels;
            earningsChartInstance.data.datasets[0].data = totalDataPoints;
            earningsChartInstance.data.datasets[1].data = mlmDataPoints;
            earningsChartInstance.update();
        }


        function initHistoryFilters() {
            document.getElementById('deposit-filter')?.addEventListener('change', loadDepositHistory);
            document.getElementById('withdraw-filter')?.addEventListener('change', loadWithdrawHistory);
            document.getElementById('earnings-period')?.addEventListener('change', loadEarningsHistory);
        }

        function initContactForm() {
            const contactFormEl = document.getElementById('contact-form');
            if (contactFormEl) {
                contactFormEl.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const name = document.getElementById('contact-name').value.trim();
                    const email = document.getElementById('contact-email').value.trim();
                    const subject = document.getElementById('contact-subject').value.trim();
                    const message = document.getElementById('contact-message').value.trim();

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!name || !email || !subject || !message) {
                        showNotification('Please fill all fields.', 'error'); return;
                    }
                    if (!emailRegex.test(email)) {
                        showNotification('Please enter a valid email address.', 'error'); return;
                    }
                    if (name.length > 100 || subject.length > 150 || message.length > 2000) {
                         showNotification('One or more fields exceed maximum length.', 'error'); return;
                    }


                    const submitBtn = this.querySelector('.submit-btn');
                    showLoadingButton(submitBtn, true);

                    const messageData = {
                        name: name,
                        email: email,
                        subject: subject,
                        message: message,
                        date: new Date().toISOString(),
                        userId: currentUser ? currentUser.uid : 'guest',
                        userAppEmail: currentUser ? currentUser.email : 'guest_form_submission',
                        status: 'new' // For admin tracking
                    };

                    database.ref('contact_messages').push(messageData)
                    .then(() => {
                        showNotification('Message sent! We will respond as soon as possible.', 'success');
                        contactFormEl.reset();
                    })
                    .catch(err => {
                        console.error("Contact form submission error:", err);
                        showNotification('Failed to send message. Please try again later or use another contact method.', 'error', true);
                    })
                    .finally(() => {
                        showLoadingButton(submitBtn, false, "Send Message");
                    });
                });
            }
        }

        function showConfirmationModal(title, message, confirmCallback, type = 'warning') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // Use innerHTML for <br>

            const modalIconContainer = confirmationModal.querySelector('.modal-icon');
            modalIconContainer.querySelectorAll('i').forEach(icon => icon.style.display = 'none'); // Hide all
            const iconToShow = modalIconContainer.querySelector(`i.${type}`);
            if(iconToShow) iconToShow.style.display = 'block'; // Show specific type

            const confirmBtnEl = document.getElementById('modal-confirm');
            confirmBtnEl.className = 'modal-btn confirm glowing-btn-hover'; // Reset classes
            if (type === 'error') confirmBtnEl.classList.add('error');
            else if (type === 'warning') confirmBtnEl.classList.add('warning');
            // 'success' will use default confirm style

            confirmationModal.classList.add('active');
            confirmationModal.classList.remove('hidden');

            // Re-bind event to avoid multiple executions if modal is reused
            const newConfirmBtn = confirmBtnEl.cloneNode(true);
            confirmBtnEl.parentNode.replaceChild(newConfirmBtn, confirmBtnEl);

            newConfirmBtn.onclick = () => {
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
                if (typeof confirmCallback === 'function') confirmCallback();
            };
             modalCancel.onclick = () => { // Ensure cancel also works
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
            };
            newConfirmBtn.focus();
        }

        function formatDate(dateString, short = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date'; // Check if date is valid

            const options = short ?
                { month: 'short', day: 'numeric' } :
                { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };

            try {
                return date.toLocaleDateString('en-US', options);
            } catch (e) {
                // Fallback for environments where toLocaleDateString with options might fail (rare)
                console.warn("toLocaleDateString with options failed, using simpler format.", e);
                if (short) return `${date.getMonth() + 1}/${date.getDate()}`;
                return date.toISOString().substring(0, 16).replace('T', ' ');
            }
        }

        // --- Profile Modal Functions ---
        function openProfileModal() {
            if (!currentUser || !userData) return;

            profileModalImg.src = userData.profileImage || DEFAULT_PROFILE_IMG_URL;
            profileNameInput.value = userData.name || '';
            profileCurrentPasswordInput.value = '';
            profileNewPasswordInput.value = '';
            profileConfirmPasswordInput.value = '';
            checkPasswordStrength(profileNewPasswordInput, '#profile-modal'); // Reset strength meter


            profileModal.classList.add('active');
            profileModal.classList.remove('hidden');
        }

        function closeProfileModal() {
            profileModal.classList.remove('active');
            profileModal.classList.add('hidden');
        }

        async function handleSaveProfileName() {
            const newName = profileNameInput.value.trim();
            if (!newName) {
                showNotification('Name cannot be empty.', 'error');
                return;
            }
            if (newName.length > 50) {
                showNotification('Name cannot exceed 50 characters.', 'error');
                return;
            }
            if (newName === userData.name) {
                showNotification('Name is unchanged.', 'info');
                return;
            }

            showLoadingButton(saveProfileNameBtn, true);
            try {
                await currentUser.updateProfile({ displayName: newName });
                await database.ref('users/' + currentUser.uid).update({ name: newName });
                showNotification('Name updated successfully!', 'success');
                // userData will update via the .on listener, which calls updateUI
            } catch (error) {
                console.error("Error updating name:", error);
                showNotification('Failed to update name: ' + error.message, 'error');
            } finally {
                showLoadingButton(saveProfileNameBtn, false, "Save Name");
            }
        }

        async function handleSaveProfilePassword() {
            const currentPassword = profileCurrentPasswordInput.value;
            const newPassword = profileNewPasswordInput.value;
            const confirmPassword = profileConfirmPasswordInput.value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill all password fields.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match.', 'error');
                return;
            }
            if (!validatePassword(newPassword)) {
                showNotification('New password must be at least 8 characters long and include uppercase, lowercase, number, and special character.', 'error', true);
                return;
            }

            showLoadingButton(saveProfilePasswordBtn, true);
            try {
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
                await currentUser.reauthenticateWithCredential(credential);
                await currentUser.updatePassword(newPassword);
                showNotification('Password changed successfully!', 'success');
                profileCurrentPasswordInput.value = '';
                profileNewPasswordInput.value = '';
                profileConfirmPasswordInput.value = '';
                checkPasswordStrength(profileNewPasswordInput, '#profile-modal');
            } catch (error) {
                console.error("Error changing password:", error);
                let message = 'Failed to change password. ';
                if (error.code === 'auth/wrong-password') {
                    message += 'Incorrect current password.';
                } else {
                    message += error.message;
                }
                showNotification(message, 'error');
            } finally {
                showLoadingButton(saveProfilePasswordBtn, false, "Change Password");
            }
        }

        function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file (jpg, png, gif).', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('File size should not exceed 5MB.', 'error');
                return;
            }

            profileImageUploadLoader.classList.remove('hidden');
            profileUploadLabel.classList.add('hidden'); // Hide button during upload

            const storageRef = storage.ref(`profileImages/${currentUser.uid}/profile_picture`); // Fixed name to overwrite
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    // Can use snapshot.bytesTransferred / snapshot.totalBytes for progress if needed
                },
                (error) => {
                    console.error("Upload failed:", error);
                    showNotification('Image upload failed: ' + error.message, 'error');
                    profileImageUploadLoader.classList.add('hidden');
                    profileUploadLabel.classList.remove('hidden');
                },
                async () => { // On success
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        await database.ref('users/' + currentUser.uid).update({ profileImage: downloadURL });
                        profileModalImg.src = downloadURL; // Update preview in modal
                        // userData will update via the .on listener, which calls updateUI for side menu & header
                        showNotification('Profile picture updated!', 'success');
                    } catch (dbError) {
                        console.error("Error updating database with new image URL:", dbError);
                        showNotification('Failed to save profile picture: ' + dbError.message, 'error');
                    } finally {
                        profileImageUploadLoader.classList.add('hidden');
                        profileUploadLabel.classList.remove('hidden');
                        profileImageUploadInput.value = ''; // Reset file input
                    }
                }
            );
        }


        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
