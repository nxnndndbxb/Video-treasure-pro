
<body html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Harvest - MLM (Golden Theme)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* style.css - (Golden Theme) */
        /* Global Styles */
        :root {
            --primary-color: #5D4037; /* Dark Brown */
            --primary-light: #8B5E3C;
            --primary-dark: #3E2723;
            --secondary-color: #B08D57; /* Muted Gold */
            --secondary-light: #D4AC79;
            --secondary-dark: #8C6D43;
            --accent-color: #D4AF37; /* Bright Gold */
            --accent-light: #E7C368;
            --accent-dark: #B8860B; /* DarkGoldenRod */
            --success-color: #556B2F; /* Dark Olive Green */
            --warning-color: #DAA520; /* GoldenRod */
            --danger-color: #A43B3B; /* Deep Red */
            --info-color: #B08D57;   /* Muted Gold (was new Teal) - for info elements */
            
            --light-color: #F5F2EB; /* Off-white with slight warmth */
            --light-text: #FFFFFF;
            --dark-text: #333333; /* Dark Gray for text on light backgrounds */
            --gray-text: #777777; /* Medium Gray */
            --light-gray: #e0e0e0;
            --medium-gray: #bdbdbd;
            --dark-gray: #616161;
            --card-bg: #FFFFFF; /* White cards are clean */
            
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
            --border-radius: 10px;
            --transition: all 0.3s ease;

            /* RGB versions for rgba() */
            --primary-color-rgb: 93, 64, 55;
            --secondary-color-rgb: 176, 141, 87;
            --accent-color-rgb: 212, 175, 55;
            --info-color-rgb: 176, 141, 87; /* Muted Gold RGB */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color); /* Warmer page background */
            color: var(--dark-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-dark); /* Deep brown titles */
        }

        p {
            margin-bottom: 15px;
            color: var(--gray-text);
        }

        a {
            color: var(--accent-color); /* Bright Gold links */
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            color: var(--accent-light);
        }

        /* Glowing Button Hover Effect */
        .glowing-btn-hover:hover {
            box-shadow: 0 0 8px rgba(var(--accent-color-rgb), 0.6), 
                        0 0 15px rgba(var(--accent-color-rgb), 0.4),
                        var(--shadow-hover); /* Combine with existing shadow if any */
        }


        /* Auth Styles */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); /* Dark Brown Gradient */
            color: var(--light-text);
            padding: 20px;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 4px 8px rgba(var(--primary-dark-rgb,0,0,0), 0.3)); /* Brownish shadow */
            border-radius: 50%; /* Ensure logo is circular if it's square by nature */
            object-fit: cover;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: var(--light-text);
        }

        #auth-options {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
        }

        .auth-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text); /* White text on bright gold is okay */
            box-shadow: var(--shadow);
            flex: 1;
            text-align: center;
        }

        .auth-btn:hover {
            transform: translateY(-3px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
            background-color: var(--accent-light);
        }

        .auth-form {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-hover);
            animation: fadeIn 0.5s ease;
            color: var(--dark-text);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-form h2 {
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-text);
        }
        
        .form-group.password-container i.fas.fa-lock { /* Specific for lock icon */
             left: 15px;
        }
        
        .password-container .password-toggle i { /* Specific for eye icon */
            left: auto;
            right: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-text);
            cursor: pointer;
        }

        .password-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .strength-bar {
            height: 4px;
            flex: 1;
            background-color: var(--light-gray);
            border-radius: 2px;
        }
        .strength-bar.weak { background-color: var(--danger-color); } /* New Danger */
        .strength-bar.medium { background-color: var(--warning-color); } /* New Warning */
        .strength-bar.strong { background-color: var(--success-color); } /* New Success */


        .strength-text {
            font-size: 0.8rem;
            color: var(--gray-text);
            margin-left: 5px;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px 12px 40px; /* Increased left padding for icon */
            margin-bottom: 5px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #fafafa; /* Slightly off-white input bg */
        }

        .password-container input {
            padding-right: 45px; /* Space for password toggle */
        }
        
        .password-container.has-strength input { 
            padding-right: 70px; 
        }


        .auth-form input:focus {
            border-color: var(--accent-color); /* Bright Gold focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3), 0 0 5px rgba(var(--accent-color-rgb), 0.2); /* Golden focus ring */
            background-color: var(--card-bg);
        }

        .terms {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }

        .terms input {
            width: auto;
            margin-right: 10px;
        }

        .terms label {
            font-size: 0.9rem;
            color: var(--gray-text);
        }

        #terms-link {
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .btn-text, .btn-loader {
            display: inline-block;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-text);
            font-size: 0.9rem;
        }

        .auth-switch span {
            color: var(--accent-color); /* Bright Gold */
            cursor: pointer;
            font-weight: 600;
        }

        #forgot-password-link {
            display: block;
            text-align: right;
            font-size: 0.9rem;
            color: var(--accent-color); /* Bright Gold */
            margin-top: -10px; /* Adjust if needed */
            margin-bottom: 15px;
            cursor: pointer;
        }
        #forgot-password-link:hover {
            text-decoration: underline;
        }


        /* App Styles */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--light-color); /* Warmer page background */
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        #email-verification-notice {
            background-color: var(--warning-color); /* GoldenRod */
            color: var(--dark-text); /* Dark text on GoldenRod */
            padding: 10px 20px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px; /* Below app-header */
            z-index: 99; /* Below app-header, above content */
            box-shadow: var(--shadow);
        }
        #email-verification-notice button {
            background: none;
            border: none;
            color: var(--primary-dark); /* Darkest Brown */
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }


        .menu-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            transform: scale(1.1);
            color: var(--accent-light); /* Light gold hover for menu icon */
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .app-logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-text);
            margin-bottom: 0; /* Override general h1 margin */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(var(--primary-dark-rgb, 0,0,0), 0.3); /* Darker inset on brown header */
            padding: 5px 10px;
            border-radius: 20px;
        }

        #user-balance {
            font-weight: 600;
        }

        .refresh-balance {
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .refresh-balance:hover {
            transform: rotate(180deg);
            color: var(--accent-light); /* Light gold hover */
        }

        .user-avatar {
            position: relative;
            cursor: pointer;
        }

        .user-avatar i {
            font-size: 1.8rem;
            color: var(--light-text);
        }

        .online-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: var(--success-color); /* Dark Olive Green */
            border-radius: 50%;
            border: 2px solid var(--primary-color); /* Dark Brown border */
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .side-menu.active {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            text-align: center;
            position: relative;
        }

        .menu-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid var(--light-text);
            object-fit: cover;
        }

        .menu-header h3 {
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .menu-header span#menu-user-email { /* Changed ID */
            font-size: 0.9rem;
            opacity: 0.9;
            word-break: break-all;
        }

        .user-level {
            margin-top: 10px;
        }

        #user-level-badge {
            display: inline-block;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text); /* White text okay on Bright Gold */
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .menu-items {
            list-style: none;
            padding: 10px 0;
            flex: 1;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            color: var(--gray-text);
        }

        .menu-item span {
            flex: 1;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .menu-item:hover {
            background-color: var(--light-color); /* Warm off-white */
            color: var(--accent-color); /* Bright Gold */
        }

        .menu-item.active {
            background-color: var(--light-color); /* Warm off-white */
            border-left: 4px solid var(--accent-color); /* Bright Gold */
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
        }

        .menu-footer {
            padding: 15px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray-text);
            border-top: 1px solid var(--light-gray);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            margin-top: 60px; /* Height of app-header */
            transition: var(--transition);
        }
        
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0; /* Reset margin when menu is not permanently open */
            }
            .side-menu.active + .main-content {
                /* Add blur or dim effect if needed when menu is open on mobile */
            }
            #email-verification-notice {
                top: 56px; /* Adjust if header height is different on mobile */
            }
        }

        /* Page Styles */
        .page {
            animation: fadeIn 0.5s ease;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            margin-bottom: 0;
        }

        .page-description {
            color: var(--gray-text);
            margin-bottom: 20px;
            width: 100%;
        }

        /* Home Page */
        .slideshow-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .slide {
            display: none;
            position: relative;
        }

        .slide img {
            width: 100%;
            vertical-align: middle;
            height: 300px; /* Fixed height for slides */
            object-fit: cover; /* Ensure image covers the area */
        }

        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(var(--primary-dark-rgb,0,0,0),0.9), transparent); /* Dark brown gradient */
            color: var(--light-text);
            padding: 30px 20px 20px;
        }

        .slide-content h3 {
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .slide-content p {
            color: rgba(255,255,255,0.8);
            margin-bottom: 0;
        }

        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(var(--primary-dark-rgb,0,0,0), 0.5); /* Dark brown semi-transparent */
        }

        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev:hover, .next:hover {
            background-color: rgba(var(--primary-dark-rgb,0,0,0), 0.8); /* Darker brown */
        }

        .dot-container { /* Used for styling the dot container below slideshow */
            text-align: center;
            padding: 10px 0;
        }

        .dot {
            cursor: pointer;
            height: 12px;
            width: 12px;
            margin: 0 5px;
            background-color: var(--light-gray);
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }

        .active-dot, .dot:hover {
            background-color: var(--accent-color); /* Bright Gold */
        }
        .fade {
            animation-name: fade;
            animation-duration: 1.5s;
        }
        @keyframes fade {
            from {opacity: .4}
            to {opacity: 1}
        }


        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card.large {
            grid-column: span 2; /* For wider stat cards if needed */
        }

        .stat-icon { 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-color); /* Warm off-white */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
        }
        .referral-stat .stat-icon { 
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            background-color: rgba(var(--accent-color-rgb), 0.1); /* Light Bright Gold */
        }


        .stat-card h3 {
            font-size: 1rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold for stat values */
            margin-bottom: 0;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .quick-action {
            flex: 1 1 150px; /* Flex grow, shrink, basis */
            min-width: 150px; /* Minimum width before wrapping */
            background-color: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            color: var(--gray-text);
            text-align: center;
        }

        .quick-action i {
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
        }

        .quick-action span {
            font-weight: 500;
        }

        .quick-action:hover {
            transform: translateY(-3px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
        }

        .quick-action:hover i {
            color: var(--light-text);
        }

        .announcement-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        .announcement-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .announcement-card h3 i { 
            color: var(--accent-color); /* Bright Gold for bullhorn */
        }

        .announcement-content {
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 5px;
        }

        /* Team Page */
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .rank-badge {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rank-badge i {
            font-size: 1.2rem;
        }

        .action-btn {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .ranking-table, .invitation-section, .direct-referrals-section, .commissions-earned-section {
             background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
         .direct-referrals-section h3, .commissions-earned-section h3 {
            margin-bottom: 15px;
         }


        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--light-color); /* Warm off-white */
            color: var(--primary-color); /* Dark Brown */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: var(--light-color); /* Warm off-white */
        }

        .current-user { 
            background-color: rgba(var(--accent-color-rgb), 0.1) !important; /* Light Bright Gold */
            font-weight: 500;
        }

        .invitation-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invite-code-container {
            display: flex;
            margin: 15px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px var(--light-gray);
        }

        #invite-code {
            flex: 1;
            padding: 12px 15px;
            border: none;
            font-weight: 600;
            color: var(--accent-color); /* Bright Gold */
            background-color: #fafafa;
        }

        .copy-btn {
            padding: 12px 20px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .copy-btn:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .invite-note {
            font-style: italic;
            color: var(--gray-text);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .referral-stat {
            background-color: var(--light-color); /* Warm off-white */
            padding: 15px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .referral-stat h4 {
            font-size: 0.9rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .referral-stat p {
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        .referral-share {
            margin: 25px 0;
        }

        .referral-share h4 {
            margin-bottom: 15px;
            color: var(--gray-text);
            font-size: 1rem;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .share-btn i {
            font-size: 1.1rem;
        }

        .share-btn.whatsapp {
            background-color: #25D366;
            color: white;
        }

        .share-btn.facebook {
            background-color: #3b5998; /* Facebook brand blue */
            color: white;
        }

        .share-btn.copy-link {
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--light-text); /* Muted gold okay with white text if large/bold enough. #B08D57 vs white is 3.13:1. Maybe dark text */
            /* Let's use dark text for better contrast */
            color: var(--dark-text); 
            border: 1px solid var(--secondary-dark);
        }
        .share-btn.copy-link:hover {
            background-color: var(--secondary-light);
        }


        .share-btn:hover {
            transform: translateY(-2px);
            /* box-shadow: var(--shadow-hover); Handled by .glowing-btn-hover if applied */
            opacity: 0.9;
        }

        /* Specific for MLM tables on Team Page */
        .direct-referrals-table th, .direct-referrals-table td,
        .commissions-earned-table th, .commissions-earned-table td {
            padding: 10px 15px;
            font-size: 0.9rem;
        }


        .status-pending {
            color: var(--warning-color); /* GoldenRod */
            font-weight: 600;
        }

        .status-completed {
            color: var(--success-color); /* Dark Olive Green */
            font-weight: 600;
        }

        .status-rejected, .status-cancelled {
            color: var(--danger-color); /* Deep Red */
            font-weight: 600;
        }
         .status-commission_pending, .status-pending_first_deposit {
            color: var(--info-color); /* Muted Gold */
            font-weight: 500;
        }


        /* Plans Page */
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .plan-card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .plan-card h3 {
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3rem;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            text-align: center;
            margin-bottom: 15px;
        }

        .plan-duration {
            text-align: center;
            color: var(--gray-text);
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 25px;
            flex: 1; /* Allows button to stick to bottom */
        }

        .plan-features li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.95rem;
            color: var(--gray-text);
        }

        .plan-features i {
            color: var(--success-color); /* Dark Olive Green */
            margin-top: 3px;
        }

        .buy-plan-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: auto; /* Pushes button to bottom if plan-features is flex:1 */
        }

        .buy-plan-btn:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .popular {
            border: 2px solid var(--accent-color); /* Bright Gold */
        }

        /* Shimmer for popular plan card */
        .plan-card.popular {
            position: relative;
            overflow: hidden;
        }
        .plan-card.popular::before {
            content: "";
            position: absolute;
            top: 0;
            left: -150%; 
            width: 70%; 
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 215, 0, 0.35), /* Gold shimmer */
                transparent
            );
            transform: skewX(-25deg); 
            transition: left 0.75s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
        }
        .plan-card.popular:hover::before {
            left: 150%; 
        }


        .popular-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .plan-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 30px;
        }

        .plan-info-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .plan-info-card h3 i { 
            color: var(--info-color); /* Muted Gold for info icon */
        }

        .info-content {
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 5px;
        }

        .info-content p {
            margin-bottom: 10px;
            display: flex; /* For aligning strong and text */
        }

        .info-content p strong {
            min-width: 120px; /* Ensure consistent label width */
            color: var(--dark-text);
            margin-right: 5px;
        }

        /* Deposit Page */
        .deposit-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .method-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column; /* Stack image and text */
            align-items: center;
            gap: 10px;
            border: 2px solid transparent;
            min-width: 150px; /* Minimum width for method cards for crypto names */
            text-align: center;
        }

        .method-card img {
            height: 40px; /* Adjusted height */
            width: auto;
            max-width: 100px; /* Max width for logo */
            object-fit: contain;
        }

        .method-card.active {
            border-color: var(--accent-color); /* Bright Gold */
            background-color: rgba(var(--accent-color-rgb), 0.05); /* Light Bright Gold */
        }

        .method-card:hover:not(.active) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent-light);
        }

        .deposit-instructions {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .deposit-instructions h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 15px;
        }

        .deposit-instructions h3 i {
            color: var(--info-color); /* Muted Gold */
        }

        .deposit-instructions p {
            margin-bottom: 15px;
        }

        .account-details {
            background-color: var(--light-color); /* Warm off-white */
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            margin-bottom: 10px;
            align-items: center; /* Align items vertically in the flex container */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            min-width: 180px; /* Adjusted width for longer labels */
            color: var(--dark-text);
            margin-bottom: 5px; /* Spacing on wrap */
            margin-right: 10px;
        }

        .detail-value-container {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px; /* Ensure space for address and button */
        }

        .detail-value {
            flex-grow: 1;
            font-family: monospace, 'Courier New', Courier; /* Monospace for numbers */
            font-size: 1rem; /* Adjusted for long addresses */
            color: var(--accent-color); /* Bright Gold */
            word-break: break-all; /* Prevent overflow */
        }

        .copy-address-btn {
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--dark-text); /* Dark text on Muted Gold */
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            margin-left: 10px;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .copy-address-btn:hover {
            background-color: var(--secondary-dark);
            color: var(--light-text);
        }


        .important-note {
            display: flex;
            gap: 10px;
            background-color: rgba(var(--warning-color-rgb, 218,165,32), 0.1); /* Light GoldenRod */
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid var(--warning-color); /* GoldenRod */
        }

        .important-note i {
            color: var(--warning-color); /* GoldenRod */
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .important-note p {
            margin-bottom: 0;
            color: var(--dark-text);
        }

        .deposit-form {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .deposit-form h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
        }

        .deposit-form h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .form-select { /* General select style */
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B08D57' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); /* Muted Gold arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
            transition: var(--transition);
            background-color: var(--card-bg); 
        }

        .form-select:focus {
            border-color: var(--accent-color); /* Bright Gold */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3); /* Golden focus ring */
        }

        #custom-amount-container {
            margin-top: 10px;
        }

        #custom-amount { /* Input for custom amount */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        #custom-amount:focus {
             border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }


        /* Withdraw Page */
        .withdraw-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: var(--light-color); /* Warm off-white */
            border-radius: 8px;
        }

        .info-item i {
            font-size: 1.5rem;
            color: var(--accent-color); /* Bright Gold */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        .info-content h4 {
            font-size: 0.9rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }

        .info-content p {
            font-weight: 500;
            color: var(--dark-text);
            margin-bottom: 0;
        }

        .withdraw-form {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .withdraw-form h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color); /* Dark Brown */
            margin-bottom: 20px;
        }

        .withdraw-form h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .amount-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .amount-btn {
            padding: 8px 12px; /* Slightly smaller padding */
            background-color: var(--light-color); /* Warm off-white */
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--secondary-dark); /* Darker Muted Gold */
        }

        .amount-btn:hover {
            background-color: var(--secondary-color); /* Muted Gold */
            color: var(--light-text);
            border-color: var(--secondary-color);
        }

        /* History Pages */
        .history-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px; 
        }

        .history-filter select {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            background-color: var(--card-bg);
            min-width: 150px; /* Give select some base width */
            /* Arrow color will be inherited from .form-select if class is added, or default */
        }

        .history-table { 
            width: 100%;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden; 
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-collapse: collapse; 
        }

        .history-table th { 
            background-color: var(--primary-color); /* Dark Brown */
            color: var(--light-text);
            text-align: left;
        }
        .history-table td {
            text-align: left;
        }

        .history-table tr:nth-child(even) {
            background-color: var(--light-color); /* Warm off-white */
        }
        .history-table tr:hover {
            background-color: rgba(var(--secondary-color-rgb), 0.1); /* Light Muted Gold */
        }


        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .summary-card h4 {
            color: var(--gray-text);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-weight: 700;
            color: var(--accent-color); /* Bright Gold */
            margin-bottom: 0;
            font-size: 1.2rem;
        }

        .action-link {
            color: var(--accent-color); /* Bright Gold */
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
        }

        .action-link:hover {
            color: var(--accent-dark);
        }
        td .action-link { 
            font-size: 0.9em;
        }


        /* Earnings Page */
        .earnings-stats { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .earnings-filter {
             margin-bottom: 15px;
        }
        .earnings-filter select {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            background-color: var(--card-bg);
            min-width: 150px;
        }


        .earnings-chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .earnings-chart-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .earnings-chart-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        #earnings-chart {
            width: 100% !important; 
            max-height: 350px; 
        }

        .earnings-table-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .earnings-table-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .earnings-table-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        .earnings-table th, .earnings-table td { 
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        .badge {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--light-text);
        }
        .badge.investment { background-color: var(--secondary-color); color: var(--dark-text); } /* Muted Gold, Dark Text */
        .badge.referral { background-color: var(--accent-color); } /* Bright Gold, Light Text okay */


        /* Contact Page */
        .contact-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .contact-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .contact-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light-color); /* Warm off-white */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.8rem; 
        }

        .contact-card.whatsapp .contact-icon {
            color: #25D366; /* WhatsApp Green */
        }

        .contact-card.email .contact-icon {
            color: var(--accent-color); /* Bright Gold */
        }

        .contact-card.phone .contact-icon {
            color: var(--info-color); /* Muted Gold */
        }

        .contact-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem; 
        }

        .contact-card p {
            margin-bottom: 20px;
            flex: 1; 
            color: var(--gray-text);
        }

        .contact-btn {
            display: inline-block;
            padding: 10px 25px; 
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            margin-top: auto; /* Push button to bottom */
        }

        .contact-btn:hover {
            background-color: var(--accent-light);
            color: var(--light-text); 
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }

        .contact-form-container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .contact-form-container h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .contact-form-container h3 i {
            color: var(--accent-color); /* Bright Gold */
        }

        #contact-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        #contact-form input,
        #contact-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #fafafa;
        }

        #contact-form textarea {
            resize: vertical;
            min-height: 120px;
        }

        #contact-form input:focus,
        #contact-form textarea:focus {
            border-color: var(--accent-color); /* Bright Gold */
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3); /* Golden focus ring */
            background-color: var(--card-bg);
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--light-color-rgb, 245,242,235), 0.8); /* Warm off-white overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            background-color: var(--card-bg);
            padding: 30px 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-hover);
            color: var(--dark-text);
        }

        .loader-content i {
            font-size: 2.5rem; 
            color: var(--accent-color); /* Bright Gold spinner */
            margin-bottom: 15px;
            display: block; 
        }

        .loader-content p {
            font-weight: 500;
            color: var(--dark-text);
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        /* Notification System */
        #notification-container {
            position: fixed;
            top: 80px; 
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: calc(100% - 40px); 
            max-width: 380px; 
        }

        .notification {
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: var(--light-text);
            box-shadow: var(--shadow-hover);
            animation: slideInRight 0.4s ease-out, fadeOut 0.5s ease-in 3.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px; 
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .notification.persistent { 
             animation: slideInRight 0.4s ease-out; 
        }


        @keyframes slideInRight {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .notification i {
            font-size: 1.3rem; 
            flex-shrink: 0;
        }

        .notification.success { background-color: var(--success-color); } /* Dark Olive Green */
        .notification.error { background-color: var(--danger-color); } /* Deep Red */
        .notification.warning { background-color: var(--warning-color); color: var(--dark-text); } /* GoldenRod, Dark Text */
        .notification.info { background-color: var(--info-color); color: var(--dark-text); } /* Muted Gold, Dark Text */

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--primary-dark-rgb,0,0,0), 0.7); /* Darker Brown backdrop */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px; 
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%; 
            max-width: 450px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
            opacity: 0;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-icon {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-icon i {
            font-size: 3.5rem; 
            display: none; 
        }

        .modal-icon i.success { display: block; color: var(--success-color); }
        .modal-icon i.warning { display: block; color: var(--warning-color); }
        .modal-icon i.error { display: block; color: var(--danger-color); }
        /* No specific modal icon for info, but can be added if needed */


        .modal h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-dark); /* Darkest Brown */
            font-size: 1.4rem;
        }

        .modal p {
            text-align: center;
            margin-bottom: 25px;
            color: var(--gray-text);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end; 
            gap: 15px; 
            margin-top: 10px; 
        }

        .modal-btn {
            padding: 10px 25px; 
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px; 
            font-size: 0.95rem;
        }

        .modal-btn.cancel {
            background-color: var(--light-gray);
            color: var(--dark-text);
            border: 1px solid var(--medium-gray);
        }

        .modal-btn.cancel:hover {
            background-color: var(--medium-gray);
        }

        .modal-btn.confirm {
            background-color: var(--accent-color); /* Bright Gold */
            color: var(--light-text);
        }
        .modal-btn.confirm.error { background-color: var(--danger-color); } 
        .modal-btn.confirm.warning { background-color: var(--warning-color); color: var(--dark-text); }


        .modal-btn.confirm:hover {
            background-color: var(--accent-light);
             /* box-shadow: var(--shadow-hover); combined in .glowing-btn-hover */
        }
        .modal-btn.confirm.error:hover { background-color: var(--danger-color); opacity: 0.8; }
        .modal-btn.confirm.warning:hover { background-color: var(--warning-color); opacity: 0.8; }


        .terms-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .terms-text {
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .terms-text h4 {
            margin-top: 20px;
            color: var(--primary-color); /* Dark Brown */
            font-size: 1.1rem;
        }
        .terms-content #terms-accept.submit-btn {
             width: auto; 
             margin: 20px auto 0; 
             display: block;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .stat-card.large {
                grid-column: span 1; 
            }
        }


        @media (max-width: 768px) {
            .stats-container, .referral-stats, .earnings-stats {
                grid-template-columns: 1fr;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .auth-form {
                padding: 25px; 
            }
            
            .side-menu {
                width: 260px; 
                left: -270px; 
            }
             .side-menu.active {
                left: 0;
            }

            
            .main-content {
                padding: 15px;
            }
            
            .quick-actions {
                flex-direction: row; 
                justify-content: space-around; 
            }
            .quick-action {
                flex-basis: calc(33.33% - 10px); 
            }

            .contact-methods {
                grid-template-columns: 1fr;
            }
            #notification-container {
                top: 70px; 
                width: calc(100% - 30px);
            }
            .slide img {
                height: 250px; 
            }
        }

        @media (max-width: 480px) {
            #auth-options {
                flex-direction: column;
                gap: 15px; 
            }
            
            .auth-btn {
                width: 100%;
            }
            .auth-form {
                padding: 20px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 0 10px; 
            }
            
            .modal-buttons {
                flex-direction: column-reverse; 
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .history-filter, .earnings-filter {
                flex-direction: column;
                align-items: stretch; 
            }
            .history-filter select, .earnings-filter select {
                width: 100%;
            }
            .quick-action {
                flex-basis: calc(50% - 8px); 
            }
            .app-logo h1 {
                font-size: 1rem; 
            }
            .slide img {
                height: 200px;
            }
            .prev, .next {
                padding: 12px;
                font-size: 16px;
            }
            .dot {
                height: 10px;
                width: 10px;
            }
            .deposit-methods .method-card {
                min-width: 140px; 
                padding: 10px;
            }
            .deposit-methods .method-card img {
                height: 30px;
            }
            .detail-label {
                width: 100%; 
                margin-bottom: 3px;
            }
            .detail-value-container {
                width: 100%;
                flex-direction: column; 
                align-items: flex-start;
            }
            .detail-value {
                width: 100%;
                margin-bottom: 5px;
            }
            .copy-address-btn {
                margin-left: 0;
                margin-top: 5px;
            }
        }

    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container" class="container">
        <div class="logo-container">
            <img src="https://iili.io/3voAf14.png" alt="Crypto Harvest Logo" class="logo">
            <h1 class="app-title">Crypto Harvest</h1>
        </div>
        
        <div id="auth-options">
            <button id="show-register-form-btn" class="auth-btn animate__animated animate__fadeInUp glowing-btn-hover">Register</button>
            <button id="show-login-form-btn" class="auth-btn animate__animated animate__fadeInUp glowing-btn-hover">Login</button>
        </div>
        
        <div id="register-form" class="auth-form hidden">
            <h2>Create Account</h2>
            <div class="form-group">
                <i class="fas fa-user"></i>
                <input type="text" id="reg-name" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reg-email" placeholder="Email Address" required>
            </div>
            <div class="form-group password-container has-strength">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
                <div class="password-strength">
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-text"></span>
                </div>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-confirm-password" placeholder="Confirm Password" required>
            </div>
            <div class="form-group">
                <i class="fas fa-user-plus"></i>
                <input type="text" id="reg-invite" placeholder="Invitation Code (Optional)">
            </div>
            <div class="form-group terms">
                <input type="checkbox" id="reg-terms">
                <label for="reg-terms">I agree to the <a href="#" id="terms-link">Terms & Conditions</a></label>
            </div>
            <button id="submit-register" class="submit-btn glowing-btn-hover">
                <span class="btn-text">Register</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Already have an account? <span id="switch-to-login">Login</span></p>
        </div>
        
        <div id="login-form" class="auth-form hidden">
            <h2>Login</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="login-email" placeholder="Email Address" required>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="login-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
            </div>
            <span id="forgot-password-link">Forgot Password?</span>
            <button id="submit-login" class="submit-btn glowing-btn-hover">
                <span class="btn-text">Login</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Don't have an account? <span id="switch-to-register">Register</span></p>
        </div>
    </div>
    
    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <div class="app-logo">
                <img src="https://iili.io/3voAf14.png" alt="Crypto Harvest Logo">
                <h1>Crypto Harvest</h1>
            </div>
            <div class="user-info">
                <div class="balance-container">
                    <span id="user-balance">$0.00</span>
                    <i class="fas fa-sync-alt refresh-balance" id="refresh-balance" title="Refresh Balance"></i>
                </div>
                <div class="user-avatar" id="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span class="online-status"></span>
                </div>
            </div>
        </header>

        <!-- Email Verification Notice -->
        <div id="email-verification-notice" class="hidden">
            Your email is not verified. Please check your inbox (and spam folder) for the verification link. 
            <button id="resend-verification-email-btn">Resend Email</button>
        </div>
        
        <!-- Side Menu -->
        <div class="side-menu" id="side-menu">
            <div class="menu-header">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Profile" id="menu-user-img"> <!-- Default user profile image -->
                <h3 id="menu-username">User Name</h3>
                <span id="menu-user-email">user@example.com</span>
                <div class="user-level">
                    <span id="user-level-badge">Standard</span>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item active" data-page="home"><i class="fas fa-home"></i> <span>Home</span></li>
                <li class="menu-item" data-page="team"><i class="fas fa-users"></i> <span>Team & MLM</span></li>
                <li class="menu-item" data-page="plans"><i class="fas fa-box-open"></i> <span>Plans</span></li>
                <li class="menu-item" data-page="deposit"><i class="fas fa-money-bill-wave"></i> <span>Deposit</span></li>
                <li class="menu-item" data-page="withdraw"><i class="fas fa-wallet"></i> <span>Withdraw</span></li>
                <li class="menu-item" data-page="deposit-history"><i class="fas fa-history"></i> <span>Deposit History</span></li>
                <li class="menu-item" data-page="withdraw-history"><i class="fas fa-clock"></i> <span>Withdraw History</span></li>
                <li class="menu-item" data-page="earnings"><i class="fas fa-chart-line"></i> <span>Earnings</span></li>
                <li class="menu-item" data-page="contact"><i class="fas fa-headset"></i> <span>Contact Us</span></li>
                <li class="menu-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></li>
            </ul>
            <div class="menu-footer">
                <p>Version 2.1.0 (MLM)</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden">
                <div class="loader-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading...</p>
                </div>
            </div>
            
            <!-- Home Page -->
            <div class="page" id="home-page">
                <div class="slideshow-container">
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1620714223084-8fcacc6dfd8d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGludmVzdG1lbnQlMjBncm93dGh8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>Earn Daily 5% Returns</h3>
                            <p>Invest in our plans and get guaranteed daily returns.</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8cmVmZXJyYWwlMjBwcm9ncmFtfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>MLM Rewards: Up to 3 Levels!</h3>
                            <p>Earn commissions from your downline network.</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.pexels.com/photos/50987/money-card-business-credit-card-50987.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%">
                        <div class="slide-content">
                            <h3>Easy Withdrawals</h3>
                            <p>Withdraw your earnings via USDT (BEP20/TRC20).</p>
                        </div>
                    </div>
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                </div>
                <br>
                <div class="dot-container" style="text-align:center">
                    <span class="dot" onclick="currentSlide(1)"></span> 
                    <span class="dot" onclick="currentSlide(2)"></span> 
                    <span class="dot" onclick="currentSlide(3)"></span> 
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Balance</h3>
                            <p id="total-balance">$0.00</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Plan</h3>
                            <p id="active-plan">None</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Daily Plan Earnings</h3>
                            <p id="daily-earnings">$0.00</p>
                        </div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total MLM Commissions</h3>
                            <p id="home-total-mlm-commissions">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action glowing-btn-hover" id="quick-deposit">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Deposit</span>
                    </button>
                    <button class="quick-action glowing-btn-hover" id="quick-withdraw">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw</span>
                    </button>
                    <button class="quick-action glowing-btn-hover" id="quick-invite">
                        <i class="fas fa-user-plus"></i>
                        <span>Invite (Team)</span>
                    </button>
                </div>
                
                <div class="announcement-card">
                    <h3><i class="fas fa-bullhorn"></i> Announcement</h3>
                    <div class="announcement-content">
                        <p id="announcement-text">Welcome to Crypto Harvest with our new MLM system! Grow your network and earn multi-level commissions. Start investing today!</p>
                    </div>
                </div>
            </div>
            
            <!-- Team Page -->
            <div class="page hidden" id="team-page">
                <div class="page-header">
                    <h2>Your Team & MLM Network</h2>
                </div>
                
                <div class="invitation-section">
                    <h3><i class="fas fa-user-plus"></i> Your Invitation Code</h3>
                    <div class="invite-code-container">
                        <input type="text" id="invite-code" readonly>
                        <button id="copy-invite" class="copy-btn glowing-btn-hover">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                    <p class="invite-note">Share this code with friends. You earn 10% from L1, 5% from L2, and 2% from L3 plan purchases!</p>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Direct Referrals (L1)</h4>
                                <p id="total-direct-referrals">0</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Total Commissions Earned</h4>
                                <p id="total-commissions-earned">$0.00</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Today's Commissions</h4>
                                <p id="today-commissions-earned">$0.00</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                            <div class="stat-icon">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Direct Referral Target</h4>
                                <p id="referral-target">0/5</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-share">
                        <h4>Share Your Link:</h4>
                        <div class="share-buttons">
                            <button class="share-btn whatsapp glowing-btn-hover">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="share-btn facebook glowing-btn-hover">
                                <i class="fab fa-facebook"></i> Facebook
                            </button>
                            <button class="share-btn copy-link glowing-btn-hover">
                                <i class="fas fa-link"></i> Copy Link
                            </button>
                        </div>
                    </div>
                </div>

                <div class="direct-referrals-section">
                    <h3><i class="fas fa-network-wired"></i> My Direct Referrals (Level 1)</h3>
                    <div class="table-responsive">
                        <table class="direct-referrals-table history-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Registration Date</th>
                                </tr>
                            </thead>
                            <tbody id="direct-referrals-body">
                                <!-- Filled by JS: Shows users current user directly referred -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="commissions-earned-section">
                    <h3><i class="fas fa-coins"></i> Commissions Earned History</h3>
                    <div class="table-responsive">
                        <table class="commissions-earned-table history-table">
                            <thead>
                                <tr>
                                    <th>Source User</th>
                                    <th>Level</th>
                                    <th>Commission</th>
                                    <th>Trigger Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="commissions-earned-body">
                                <!-- Filled by JS: Shows commissions current user received -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <div class="ranking-header" style="margin-top: 30px;">
                    <h3>Your Current Rank</h3>
                    <div class="rank-badge" id="user-rank-badge">
                        <span>#0</span>
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>
                <button id="view-ranking-btn" class="action-btn glowing-btn-hover">
                    <i class="fas fa-list-ol"></i> View Top Investors Ranking
                </button>
                <div class="ranking-table hidden" id="ranking-table-container"> <!-- Changed ID -->
                    <h3>Top 10 Investors (by Plan Amount)</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Investment</th>
                                    <th>Total Earnings (Plan + MLM)</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Plans Page -->
            <div class="page hidden" id="plans-page">
                <div class="page-header">
                    <h2>Investment Plans</h2>
                </div>
                <p class="page-description">Choose a plan to start earning daily 5% returns for 30 days. Plan purchases also trigger MLM commissions for your upline.</p>
                
                <div class="plans-container">
                    <div class="plan-card">
                        <h3>Basic Plan</h3>
                        <div class="plan-price">$5</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="5">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card popular">
                        <div class="popular-badge">Most Popular</div>
                        <h3>Silver Plan</h3>
                        <div class="plan-price">$10</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="10">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Gold Plan</h3>
                        <div class="plan-price">$25</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="25">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Platinum Plan</h3>
                        <div class="plan-price">$50</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="50">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Diamond Plan</h3>
                        <div class="plan-price">$100</div>
                        <div class="plan-duration">
                            <i class="fas fa-calendar-alt"></i> 30 Days
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> MLM Eligible</li>
                        </ul>
                        <button class="buy-plan-btn glowing-btn-hover" data-plan="100">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="plan-info-card">
                    <h3><i class="fas fa-info-circle"></i> Plan Information</h3>
                    <div class="info-content">
                        <p><strong>Daily Earnings:</strong> 5% of your investment amount</p>
                        <p><strong>Duration:</strong> 30 days (including weekends)</p>
                        <p><strong>Total Return:</strong> 150% (Principal + 50% profit)</p>
                        <p><strong>Withdrawals:</strong> Daily earnings can be withdrawn anytime (Min. $2)</p>
                        <p><strong>Principal:</strong> Returned at the end of the plan period</p>
                        <p><strong>MLM Commissions:</strong> L1: 10%, L2: 5%, L3: 2% on plan purchases</p>
                    </div>
                </div>
            </div>
            
            <!-- Deposit Page -->
            <div class="page hidden" id="deposit-page">
                <div class="page-header">
                    <h2>Deposit Funds</h2>
                </div>
                 <p class="page-description">Add funds to your account to purchase investment plans. Use USDT (BEP20 or TRC20) for deposits.</p>
                
                <div class="deposit-methods">
                    <div class="method-card active" data-method="usdt_bep20">
                        <img src="https://iili.io/3voPXmx.png" alt="USDT BEP20">
                        <span>USDT (BEP20)</span>
                    </div>
                    <div class="method-card" data-method="usdt_trc20">
                        <img src="https://iili.io/3voLiLQ.png" alt="USDT TRC20">
                        <span>USDT (TRC20)</span>
                    </div>
                </div>
                
                <div class="deposit-instructions">
                    <h3><i class="fas fa-info-circle"></i> Deposit Instructions (<span id="deposit-method-name">USDT BEP20</span>)</h3>
                    <p>Send USDT to the following address:</p>
                    <div class="account-details">
                        <div class="detail-item">
                            <span class="detail-label" id="deposit-account-label1">Deposit Address (BEP20):</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="deposit-account-number">0xeb0ee64208106984101b1f127cf221358771dbfa</span>
                                <button id="copy-deposit-address" class="copy-address-btn">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="important-note">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>After sending USDT, fill the form below to verify your deposit. Processing time: 5-30 minutes. Ensure you send to the correct network address.</p>
                    </div>
                </div>
                
                <div class="deposit-form">
                    <h3><i class="fas fa-edit"></i> Deposit Form</h3>
                    <div class="form-group">
                        <label for="deposit-amount">Amount (USD)</label>
                        <select id="deposit-amount" class="form-select">
                            <option value="">Select Amount</option>
                            <option value="5">$5 (Basic Plan)</option>
                            <option value="10">$10 (Silver Plan)</option>
                            <option value="25">$25 (Gold Plan)</option>
                            <option value="50">$50 (Platinum Plan)</option>
                            <option value="100">$100 (Diamond Plan)</option>
                            <option value="other">Other Amount</option>
                        </select>
                        <div id="custom-amount-container" class="hidden">
                            <input type="number" id="custom-amount" placeholder="Enter custom amount (Min $5)" min="5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="deposit-transaction">Transaction ID / Hash</label>
                        <input type="text" id="deposit-transaction" placeholder="Enter transaction ID or hash" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deposit-sender">Your Sending Wallet Address (Optional)</label>
                        <input type="text" id="deposit-sender" placeholder="e.g., Your USDT sending wallet address">
                    </div>
                                        
                    <button id="submit-deposit" class="submit-btn glowing-btn-hover">
                        <span class="btn-text">Submit Deposit</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>
            
            <!-- Withdraw Page -->
            <div class="page hidden" id="withdraw-page">
                <div class="page-header">
                    <h2>Withdraw Funds</h2>
                </div>
                <p class="page-description">Minimum withdrawal amount: $2. Max $500 per transaction. Withdrawals via USDT.</p>
                
                <div class="withdraw-info-card">
                    <div class="info-item">
                        <i class="fas fa-wallet"></i>
                        <div class="info-content">
                            <h4>Available Balance</h4>
                            <p id="withdraw-available-balance">$0.00</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <div class="info-content">
                            <h4>Processing Time</h4>
                            <p>1-6 hours (During business hours)</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-percentage"></i>
                        <div class="info-content">
                            <h4>Withdrawal Fee</h4>
                            <p>5% (Standard)</p>
                        </div>
                    </div>
                </div>
                
                <div class="withdraw-form">
                    <h3><i class="fas fa-money-bill-wave"></i> Withdrawal Request</h3>
                    
                    <div class="form-group">
                        <label for="withdraw-method">Withdrawal Method</label>
                        <select id="withdraw-method" class="form-select">
                            <option value="">Select Method</option>
                            <option value="usdt_bep20">USDT (BEP20)</option>
                            <option value="usdt_trc20">USDT (TRC20)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-account">Your USDT Wallet Address</label>
                        <input type="text" id="withdraw-account" placeholder="Enter your USDT (BEP20/TRC20) Address" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-name">Account Holder Name (Optional)</label>
                        <input type="text" id="withdraw-name" placeholder="Enter name associated with account if any">
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-amount">Amount (USD)</label>
                        <input type="number" id="withdraw-amount" placeholder="Enter amount (Min $2)" min="2" max="500" required>
                        <div class="amount-buttons">
                            <button class="amount-btn" data-amount="2">$2</button>
                            <button class="amount-btn" data-amount="5">$5</button>
                            <button class="amount-btn" data-amount="10">$10</button>
                            <button class="amount-btn" data-amount="20">$20</button>
                            <button class="amount-btn" data-amount="50">$50</button>
                        </div>
                    </div>
                    
                    <button id="submit-withdraw" class="submit-btn glowing-btn-hover">
                        <span class="btn-text">Request Withdrawal</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>
            
            <!-- Deposit History Page -->
            <div class="page hidden" id="deposit-history-page">
                <div class="page-header">
                    <h2>Deposit History</h2>
                    <div class="history-filter">
                        <select id="deposit-filter" class="form-select">
                            <option value="all">All Deposits</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="deposit-history-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Deposits</h4>
                        <p id="total-deposits">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Deposits</h4>
                        <p id="pending-deposits">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Deposits</h4>
                        <p id="completed-deposits">$0.00</p>
                    </div>
                </div>
            </div>
            
            <!-- Withdraw History Page -->
            <div class="page hidden" id="withdraw-history-page">
                <div class="page-header">
                    <h2>Withdrawal History</h2>
                    <div class="history-filter">
                        <select id="withdraw-filter" class="form-select">
                            <option value="all">All Withdrawals</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdraw-history-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Withdrawals</h4>
                        <p id="total-withdrawals">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Withdrawals</h4>
                        <p id="pending-withdrawals">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Withdrawals</h4>
                        <p id="completed-withdrawals">$0.00</p>
                    </div>
                </div>
            </div>
            
            <!-- Earnings Page -->
            <div class="page hidden" id="earnings-page">
                <div class="page-header">
                    <h2>Your Earnings Breakdown</h2>
                    <div class="earnings-filter">
                        <select id="earnings-period" class="form-select">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>
                
                <div class="earnings-stats">
                    <div class="stat-card large">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Grand Total Earnings (Plan + MLM)</h3>
                            <p id="total-earnings">$0.00</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Today's Total Earnings</h3>
                            <p id="today-earnings">$0.00</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total MLM Commissions</h3>
                            <p id="all-referral-earnings">$0.00</p> <!-- This is specifically total MLM commissions -->
                        </div>
                    </div>
                </div>
                
                <div class="earnings-chart-container">
                    <h3><i class="fas fa-chart-line"></i> Earnings Overview (Selected Period)</h3>
                    <canvas id="earnings-chart"></canvas>
                </div>
                
                <div class="earnings-table-container">
                    <h3><i class="fas fa-list"></i> Recent Earnings (Selected Period)</h3>
                    <div class="table-responsive">
                        <table class="earnings-table history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="earnings-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Contact Page -->
            <div class="page hidden" id="contact-page">
                <div class="page-header">
                    <h2>Contact Us</h2>
                </div>
                 <p class="page-description">Have questions or need help? Contact our support team.</p>
                
                <div class="contact-methods">
                    <div class="contact-card whatsapp">
                        <div class="contact-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <h3>WhatsApp Support</h3>
                        <p>Contact us directly on WhatsApp for quick assistance with your queries.</p>
                        <a href="https://wa.me/1XXXXXXXXXX" target="_blank" class="contact-btn glowing-btn-hover">Chat Now</a> <!-- Placeholder Number -->
                    </div>
                    
                    <div class="contact-card email">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h3>Email Support</h3>
                        <p>Send us an email, and our team will respond within 24 hours.</p>
                        <a href="mailto:support@cryptoharvest.com" class="contact-btn glowing-btn-hover">Email Us</a>
                    </div>
                    
                    <div class="contact-card phone">
                        <div class="contact-icon">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <h3>Call Support</h3>
                        <p>Call us during business hours (10AM - 6PM, Mon-Fri, EST).</p>
                        <a href="tel:+1XXXXXXXXXX" class="contact-btn glowing-btn-hover">Call Now</a> <!-- Placeholder Number -->
                    </div>
                </div>
                
                <div class="contact-form-container">
                    <h3><i class="fas fa-paper-plane"></i> Send us a Message</h3>
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">Your Name</label>
                            <input type="text" id="contact-name" placeholder="Enter your name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-email">Email Address</label>
                            <input type="email" id="contact-email" placeholder="Enter your email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-subject">Subject</label>
                            <input type="text" id="contact-subject" placeholder="Enter subject" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" rows="5" placeholder="Enter your message" required></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn glowing-btn-hover">
                            <span class="btn-text">Send Message</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Notification System -->
    <div id="notification-container"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content animate__animated animate__fadeInDown animate__faster">
            <div class="modal-icon">
                <i class="fas fa-check-circle success"></i>
                <i class="fas fa-exclamation-circle warning"></i>
                <i class="fas fa-times-circle error"></i>
            </div>
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn confirm glowing-btn-hover">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Terms Modal -->
    <div id="terms-modal" class="modal hidden">
        <div class="modal-content terms-content animate__animated animate__fadeInUp animate__faster">
            <h3>Terms & Conditions</h3>
            <div class="terms-text">
                <p><strong>Last Updated: July 2024</strong></p>
                
                <h4>1. Investment Plans</h4>
                <p>All investment plans offered by Crypto Harvest have a fixed duration of 30 days. Daily earnings are calculated at a rate of 5% of the principal investment amount. These earnings are credited daily to your account's 'earnings' sub-balance.</p>
                
                <h4>2. Withdrawals</h4>
                <p>The minimum amount for withdrawal is $2 from your main 'balance'. Withdrawal requests are typically processed within 1 to 6 hours during standard business hours (10:00 AM to 6:00 PM, Monday to Friday, EST). A standard withdrawal fee of 5% applies to all transactions. Maximum withdrawal per transaction is $500. Withdrawals are processed in USDT (BEP20 or TRC20).</p>
                
                <h4>3. Multi-Level Marketing (MLM) Program</h4>
                <p>Users can earn commissions from their downline network up to 3 levels.
                    Level 1 (Direct Referrals): 10% commission on their plan purchases.
                    Level 2: 5% commission on their plan purchases.
                    Level 3: 2% commission on their plan purchases.
                    Commissions are calculated on the plan amount purchased by a downline member and are credited directly to the upline user's main 'balance'.
                </p>
                
                <h4>4. Account Security</h4>
                <p>You are solely responsible for maintaining the confidentiality of your account credentials, including your password. Crypto Harvest is not liable for any loss or damage arising from your failure to protect your account. You must notify us immediately of any unauthorized use of your account or any other breach of security.</p>
                
                <h4>5. Amendments to Terms</h4>
                <p>Crypto Harvest reserves the right to modify these Terms & Conditions at any time without prior notice. Any changes will be effective immediately upon posting the revised terms on the platform. Your continued use of the platform after such modifications constitutes your acceptance of the new Terms & Conditions.</p>
                
                <h4>6. Prohibited Activities</h4>
                <p>Users are prohibited from creating multiple accounts, using automated scripts or bots, engaging in fraudulent activities, or attempting to exploit any vulnerabilities in the system. Violation of these terms may result in account suspension or termination and forfeiture of funds.</p>

                <h4>7. Disclaimer of Liability</h4>
                <p>Crypto Harvest provides its services "as is" and makes no warranties regarding the platform's reliability or profitability. Investment involves risk, and past performance is not indicative of future results. We are not responsible for any financial losses incurred by users.</p>
            </div>
            <button id="terms-accept" class="submit-btn glowing-btn-hover">I Understand & Accept</button>
        </div>
    </div>
        
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // app.js (MLM Version - Golden Theme - Crypto Harvest)
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAPm1qgzS0e6CJ1GOcpUGdFiFswYvS5LFg", // YOUR NEW API KEY
            authDomain: "hunting-9f603.firebaseapp.com", // Inferred from databaseURL
            databaseURL: "https://hunting-9f603-default-rtdb.asia-southeast1.firebasedatabase.app/", // YOUR NEW DATABASE URL
            projectId: "hunting-9f603", // Inferred from databaseURL
            storageBucket: "hunting-9f603.appspot.com", // Inferred from databaseURL
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // IMPORTANT: Replace with your ACTUAL Sender ID
            appId: "YOUR_APP_ID" // IMPORTANT: Replace with your ACTUAL App ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // MLM Configuration
        const MLM_COMMISSION_RATES = { 1: 0.10, 2: 0.05, 3: 0.02 }; // Level: Rate
        const MLM_MAX_LEVELS = 3;

        // DOM Elements (Selected examples, many are the same)
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const emailVerificationNoticeEl = document.getElementById('email-verification-notice');
        const resendVerificationEmailBtn = document.getElementById('resend-verification-email-btn');
        
        const showRegisterFormBtn = document.getElementById('show-register-form-btn');
        const showLoginFormBtn = document.getElementById('show-login-form-btn');
        
        const registerFormEl = document.getElementById('register-form'); 
        const loginFormEl = document.getElementById('login-form');     
        
        const switchToLogin = document.getElementById('switch-to-login');
        const switchToRegister = document.getElementById('switch-to-register');
        
        const submitRegisterBtn = document.getElementById('submit-register');
        const submitLoginBtn = document.getElementById('submit-login');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        const termsLink = document.getElementById('terms-link');
        const termsModal = document.getElementById('terms-modal');
        const termsAccept = document.getElementById('terms-accept');
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationContainer = document.getElementById('notification-container');
        const confirmationModal = document.getElementById('confirmation-modal'); 
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const loadingOverlay = document.getElementById('loading-overlay');
        const refreshBalance = document.getElementById('refresh-balance');
        const quickDeposit = document.getElementById('quick-deposit');
        const quickWithdraw = document.getElementById('quick-withdraw');
        const quickInvite = document.getElementById('quick-invite');

        // User data
        let currentUser = null;
        let userData = null;
        let earningsInterval = null; // For plan earnings
        let earningsChartInstance = null; 

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
        }
        
        function setupEventListeners() {
            showRegisterFormBtn.addEventListener('click', () => showAuthForm(registerFormEl));
            showLoginFormBtn.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToLogin.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToRegister.addEventListener('click', () => showAuthForm(registerFormEl));
            
            submitRegisterBtn.addEventListener('click', registerUser);
            submitLoginBtn.addEventListener('click', loginUser);
            forgotPasswordLink.addEventListener('click', handleForgotPassword);
            
            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.add('active');
                termsModal.classList.remove('hidden');
            });
            termsAccept.addEventListener('click', () => {
                termsModal.classList.remove('active');
                termsModal.classList.add('hidden');
            });
            document.addEventListener('click', (event) => {
                if (event.target === termsModal) { 
                    termsModal.classList.remove('active');
                    termsModal.classList.add('hidden');
                }
                if (event.target === confirmationModal) {
                    confirmationModal.classList.remove('active');
                    confirmationModal.classList.add('hidden');
                }
            });
            
            menuToggle.addEventListener('click', () => sideMenu.classList.toggle('active'));
            
            menuItems.forEach(item => {
                if (item.id !== 'logout-btn') {
                    item.addEventListener('click', () => navigateToPage(item.dataset.page));
                }
            });
            
            logoutBtn.addEventListener('click', logoutUser);
            modalCancel.addEventListener('click', () => {
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
            });
            
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.closest('.password-container').querySelector('input');
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                    }
                });
            });
            
            const passwordInput = document.getElementById('reg-password');
            if (passwordInput) passwordInput.addEventListener('input', checkPasswordStrength);
            
            const depositAmountSelect = document.getElementById('deposit-amount'); 
            if (depositAmountSelect) {
                depositAmountSelect.addEventListener('change', function() {
                    const customAmountContainer = document.getElementById('custom-amount-container');
                    if (this.value === 'other') customAmountContainer.classList.remove('hidden');
                    else customAmountContainer.classList.add('hidden');
                });
            }
                       
            if (quickDeposit) quickDeposit.addEventListener('click', () => navigateToPage('deposit'));
            if (quickWithdraw) quickWithdraw.addEventListener('click', () => navigateToPage('withdraw'));
            if (quickInvite) quickInvite.addEventListener('click', () => navigateToPage('team'));
            if (refreshBalance) refreshBalance.addEventListener('click', refreshUserBalance);
            if (resendVerificationEmailBtn) resendVerificationEmailBtn.addEventListener('click', resendVerificationEmail);

            initSlideshow();
            initPlanButtons();
            initTransactionButtons();
            initCopyButton();
            initRankingButton();
            initShareButtons();
            initAmountButtons();
            initContactForm();
            initHistoryFilters();
        }

        function showAuthForm(formToShow) {
            [registerFormEl, loginFormEl].forEach(form => {
                if (form) form.classList.add('hidden');
            });
            if (formToShow) formToShow.classList.remove('hidden');
            
            const authOptions = document.getElementById('auth-options');
            if (authOptions) authOptions.classList.add('hidden');
        }

        function navigateToPage(pageName) { 
            pages.forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            } else {
                console.error(`Page with ID ${pageName}-page not found.`);
                document.getElementById('home-page').classList.remove('hidden'); 
            }

            menuItems.forEach(item => item.classList.remove('active'));
            const activeMenuItem = document.querySelector(`.menu-item[data-page="${pageName}"]`);
            if (activeMenuItem) activeMenuItem.classList.add('active');
            
            sideMenu.classList.remove('active'); // Close menu on navigation

            // Page specific initializations
            if (pageName === 'team') initTeamPage();
            else if (pageName === 'plans') initPlansPage();
            else if (pageName === 'deposit') initDepositPage();
            else if (pageName === 'withdraw') initWithdrawPage();
            else if (pageName === 'earnings') initEarningsPage();
            else if (pageName === 'deposit-history') loadDepositHistory();
            else if (pageName === 'withdraw-history') loadWithdrawHistory();
        }

        function checkAuthState() {
            showLoading();
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid); 
                    authContainer.classList.add('hidden');
                    document.getElementById('auth-options').classList.add('hidden'); 
                    appContainer.classList.remove('hidden');
                    
                    if (!user.emailVerified) {
                        emailVerificationNoticeEl.classList.remove('hidden');
                    } else {
                        emailVerificationNoticeEl.classList.add('hidden');
                    }
                } else {
                    currentUser = null;
                    userData = null;
                    authContainer.classList.remove('hidden');
                    document.getElementById('auth-options').classList.remove('hidden'); 
                    appContainer.classList.add('hidden');
                    emailVerificationNoticeEl.classList.add('hidden');
                    showAuthForm(loginFormEl); // Default to login form
                    
                    if (earningsInterval) {
                        clearInterval(earningsInterval);
                        earningsInterval = null;
                    }
                    hideLoading();
                }
            });
        }

        function loadUserData(userId) {
            showLoading();
            database.ref('users/' + userId).on('value', snapshot => {
                userData = snapshot.val();
                if (userData) {
                    updateUI();
                    startEarningsCalculation(); // For plan earnings
                    if (!authContainer.classList.contains('hidden') && currentUser.emailVerified) { 
                         showNotification('Login successful!', 'success');
                    }
                } else {
                    // This case might happen if user was deleted from DB but auth still exists
                    console.warn("User data not found for UID:", userId, "Logging out.");
                    logoutUser(); 
                }
                hideLoading();
            }, error => {
                showNotification('Error loading user data: ' + error.message, 'error');
                logoutUser(); // Logout if data can't be loaded
                hideLoading();
            });
        }
        
        function refreshUserBalance() {
            if (!currentUser) return;
            showLoading();
            database.ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val(); // This will trigger the 'on' listener above, which calls updateUI
                    if (userData) {
                        // updateUI(); // Not strictly needed here as 'on' listener will do it
                        showNotification('Balance refreshed!', 'success');
                    }
                })
                .catch(error => showNotification('Error refreshing balance: ' + error.message, 'error'))
                .finally(() => hideLoading());
        }

        function updateUI() {
            if (!currentUser || !userData) return;
            
            // Menu details
            document.getElementById('menu-username').textContent = userData.name || 'User';
            document.getElementById('menu-user-email').textContent = userData.email || currentUser.email || 'Email Not Set';
            document.getElementById('menu-user-img').src = userData.profileImage || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            
            updateBalanceDisplay(); // Update balance in header and relevant pages
            
            // Home Page Stats
            const activePlanAmount = userData.activePlan || 0;
            const activePlanName = activePlanAmount > 0 ? `${getPlanName(activePlanAmount)} ($${activePlanAmount})` : 'None';
            document.getElementById('active-plan').textContent = activePlanName;
            
            const dailyPlanEarningsVal = activePlanAmount > 0 ? (activePlanAmount * 0.05) : 0;
            document.getElementById('daily-earnings').textContent = `$${dailyPlanEarningsVal.toFixed(2)}`; // Plan earnings specifically

            document.getElementById('home-total-mlm-commissions').textContent = `$${(userData.totalReferralEarnings || 0).toFixed(2)}`;
            
            // Team Page related
            document.getElementById('invite-code').value = userData.inviteCode || currentUser.uid.slice(0, 8).toUpperCase();
            
            const directReferralCount = userData.downline ? Object.keys(userData.downline).length : 0;
            document.getElementById('total-direct-referrals').textContent = directReferralCount;
            document.getElementById('total-commissions-earned').textContent = `$${(userData.totalReferralEarnings || 0).toFixed(2)}`;
            
            const today = new Date().toISOString().split('T')[0];
            let todayCommissions = 0;
            if (userData.referralHistory) { // Commissions received by this user
                Object.values(userData.referralHistory).forEach(entry => {
                    if (entry.date && entry.date.startsWith(today)) {
                        todayCommissions += entry.amount || 0;
                    }
                });
            }
            document.getElementById('today-commissions-earned').textContent = `$${todayCommissions.toFixed(2)}`;
            
            const referralTargetCount = 5; // Example target
            document.getElementById('referral-target').textContent = `${directReferralCount}/${referralTargetCount} ${directReferralCount >= referralTargetCount ? '(Completed)' : ''}`;
            
            document.getElementById('user-rank-badge').innerHTML = `<span>#${userData.rank || 'N/A'}</span> <i class="fas fa-trophy"></i>`;

            // User Level Badge
            let level = "Standard";
            if (userData.activePlan >= 100) level = "Diamond Investor";
            else if (userData.activePlan >= 50) level = "Platinum Investor";
            else if (userData.activePlan >= 25) level = "Gold Investor";
            else if (userData.activePlan >= 10) level = "Silver Investor";
            else if (userData.activePlan >= 5) level = "Basic Investor";
            document.getElementById('user-level-badge').textContent = level;

            // If Team page is active, refresh its specific data
            if (document.getElementById('team-page') && !document.getElementById('team-page').classList.contains('hidden')) {
                loadDirectReferrals();
                loadCommissionsEarnedHistory();
            }
            // If Earnings page is active, refresh its data
            if (document.getElementById('earnings-page') && !document.getElementById('earnings-page').classList.contains('hidden')) {
                loadEarningsHistory(); // This will also update the chart
            }
        }

        function getPlanName(amount) {
            if (amount === 5) return "Basic Plan";
            if (amount === 10) return "Silver Plan";
            if (amount === 25) return "Gold Plan";
            if (amount === 50) return "Platinum Plan";
            if (amount === 100) return "Diamond Plan";
            return "Custom Plan";
        }

        function updateBalanceDisplay() {
            if (!userData) return;
            // Main balance includes plan earnings (from userData.earnings) and direct deposits/commissions (in userData.balance)
            const currentBalance = userData.balance || 0; // Main balance (deposits, MLM commissions)
            const currentPlanEarnings = userData.earnings || 0; // Plan investment earnings
            const totalAvailable = currentBalance + currentPlanEarnings;

            document.getElementById('user-balance').textContent = `$${totalAvailable.toFixed(2)}`; // Header balance
            document.getElementById('total-balance').textContent = `$${totalAvailable.toFixed(2)}`; // Home page total balance
            
            const withdrawAvailEl = document.getElementById('withdraw-available-balance');
            if (withdrawAvailEl) withdrawAvailEl.textContent = `$${totalAvailable.toFixed(2)}`;
        }

        async function registerUser() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const termsAccepted = document.getElementById('reg-terms').checked;
            const inviteCodeInput = document.getElementById('reg-invite').value.trim();
            
            // Validations
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!name || !email || !password || !confirmPassword) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address.', 'error'); return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match.', 'error'); return;
            }
            if (password.length < 8 || !validatePassword(password)) {
                showNotification('Password: 8+ chars, uppercase, lowercase, number, special char.', 'error'); return;
            }
            if (!termsAccepted) {
                showNotification('Please accept the Terms & Conditions.', 'error'); return;
            }

            showLoadingButton(submitRegisterBtn, true);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                currentUser = user;

                await user.sendEmailVerification();
                showNotification('Registration successful! Please check your email to verify your account.', 'success', true);

                const newUserRef = database.ref('users/' + user.uid);
                const newUserData = {
                    name: name,
                    email: email,
                    balance: 0, // Main balance for deposits, MLM commissions
                    earnings: 0, // For plan investment earnings
                    totalReferralEarnings: 0, // Cumulative MLM commissions
                    activePlan: null,
                    planStartDate: null,
                    lastEarningsUpdate: null, // For plan earnings calculation
                    inviteCode: generateInviteCode(),
                    referredBy: inviteCodeInput || null, // Store the code they used
                    referredByUid: null, // Will be set by setupMLMUplines
                    uplineUids: {}, // Will be populated by setupMLMUplines
                    downline: {}, // Stores direct L1 referrals
                    registrationDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    rank: "New"
                };
                
                await newUserRef.set(newUserData); // Set initial data
                
                if (inviteCodeInput) {
                    await setupMLMUplines(inviteCodeInput, user.uid, name, email);
                }
                // checkAuthState will handle UI transition and email verification notice after this
                registerFormEl.reset();
            } catch (error) {
                showNotification('Registration failed: ' + error.message, 'error');
            } finally {
                showLoadingButton(submitRegisterBtn, false, "Register");
            }
        }
        
        async function setupMLMUplines(referrerInviteCode, newUserId, newUserName, newUserEmail) {
            if (!referrerInviteCode) return;

            try {
                const snapshot = await database.ref('users').orderByChild('inviteCode').equalTo(referrerInviteCode).once('value');
                if (snapshot.exists()) {
                    const referrerUid = Object.keys(snapshot.val())[0];
                    const referrerData = snapshot.val()[referrerUid];

                    const updates = {};
                    updates[`users/${newUserId}/referredByUid`] = referrerUid; // Store referrer's UID

                    // Set uplineUids for the new user
                    const newUserUplines = {};
                    newUserUplines.level1 = referrerUid;
                    if (referrerData.uplineUids && referrerData.uplineUids.level1) {
                        newUserUplines.level2 = referrerData.uplineUids.level1;
                    }
                    if (referrerData.uplineUids && referrerData.uplineUids.level2) {
                        newUserUplines.level3 = referrerData.uplineUids.level2;
                    }
                    updates[`users/${newUserId}/uplineUids`] = newUserUplines;

                    // Add new user to referrer's downline (L1)
                    updates[`users/${referrerUid}/downline/${newUserId}`] = {
                        name: newUserName,
                        email: newUserEmail,
                        registrationDate: new Date().toISOString()
                    };

                    await database.ref().update(updates);
                    console.log(`MLM uplines set for ${newUserId}. Added to ${referrerUid}'s downline.`);
                } else {
                    console.warn("Referrer with invite code not found:", referrerInviteCode);
                    // Optionally mark that an invalid code was attempted
                    await database.ref(`users/${newUserId}`).update({ attemptedInviteCode: referrerInviteCode });
                }
            } catch (error) {
                console.error("Error setting up MLM uplines: ", error);
            }
        }


        function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('Please enter email and password.', 'error'); return;
            }
            
            showLoadingButton(submitLoginBtn, true);
            auth.signInWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    // Update last login time
                    if (userCredential.user) {
                        await database.ref('users/' + userCredential.user.uid).update({ lastLogin: new Date().toISOString() });
                    }
                    // checkAuthState handles UI transition. loadUserData shows success message.
                    loginFormEl.reset();
                })
                .catch((error) => {
                    showNotification('Login failed: ' + error.message, 'error');
                })
                .finally(() => {
                    showLoadingButton(submitLoginBtn, false, "Login");
                });
        }

        function handleForgotPassword() {
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                showLoading();
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showNotification('Password reset email sent to ' + email + '. Check your inbox.', 'success');
                    })
                    .catch((error) => {
                        showNotification('Error sending reset email: ' + error.message, 'error');
                    })
                    .finally(() => hideLoading());
            }
        }

        function resendVerificationEmail() {
            if (currentUser && !currentUser.emailVerified) {
                showLoadingButton(resendVerificationEmailBtn, true, "Sending...");
                currentUser.sendEmailVerification()
                    .then(() => {
                        showNotification('Verification email resent! Please check your inbox.', 'success');
                    })
                    .catch((error) => {
                        showNotification('Error resending email: ' + error.message, 'error');
                    })
                    .finally(() => {
                        showLoadingButton(resendVerificationEmailBtn, false, "Resend Email");
                        resendVerificationEmailBtn.disabled = true;
                        setTimeout(() => { resendVerificationEmailBtn.disabled = false; }, 60000); // Re-enable after 1 minute
                    });
            }
        }

        function generateInviteCode() {
            return 'CH' + Math.random().toString(36).substring(2, 8).toUpperCase(); // CH for Crypto Harvest
        }

        function validatePassword(password) {
            // Regex: At least 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special character
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&_#-^()[\]{}\\;:<>~`+=|/"',.])[A-Za-z\d@$!%*?&_#-^()[\]{}\\;:<>~`+=|/"',.]{8,}$/.test(password);
        }

        function checkPasswordStrength() {
            const password = document.getElementById('reg-password').value;
            const strengthBars = document.querySelectorAll('#register-form .strength-bar');
            const strengthText = document.querySelector('#register-form .strength-text');
            
            let score = 0;
            if (!password) {
                strengthBars.forEach(bar => bar.className = 'strength-bar'); // Reset color
                strengthText.textContent = '';
                return;
            }

            if (password.length >= 8) score++;
            if (password.length >= 10) score++; // Bonus for longer
            if (/[A-Z]/.test(password)) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[@$!%*?&_#-^()[\]{}\\;:<>~`+=|/"',.]/.test(password)) score++;


            strengthBars.forEach((bar, index) => bar.className = 'strength-bar' ); // Reset first
            
            if (score <= 2) {
                strengthBars[0].classList.add('weak');
                strengthText.textContent = 'Weak'; strengthText.style.color = 'var(--danger-color)';
            } else if (score >= 3 && score <= 4) {
                strengthBars[0].classList.add('medium'); strengthBars[1].classList.add('medium');
                strengthText.textContent = 'Medium'; strengthText.style.color = 'var(--warning-color)';
            } else { // Score 5 or 6
                strengthBars.forEach(b => b.classList.add('strong'));
                strengthText.textContent = 'Strong'; strengthText.style.color = 'var(--success-color)';
            }
        }
        
        function logoutUser() {
            showLoading();
            auth.signOut()
                .then(() => { /* Handled by onAuthStateChanged which will clear currentUser, userData */ })
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => { /* onAuthStateChanged will hide loading after state change */ });
        }
        
        function showLoadingButton(buttonElement, isLoading, defaultText = "Submit") {
            const btnTextEl = buttonElement.querySelector('.btn-text');
            const btnLoaderEl = buttonElement.querySelector('.btn-loader');

            if (isLoading) {
                if(btnTextEl) btnTextEl.classList.add('hidden');
                if(btnLoaderEl) btnLoaderEl.classList.remove('hidden');
                buttonElement.disabled = true;
            } else {
                if(btnTextEl) {
                    btnTextEl.classList.remove('hidden');
                    if (defaultText) btnTextEl.textContent = defaultText;
                }
                if(btnLoaderEl) btnLoaderEl.classList.add('hidden');
                buttonElement.disabled = false;
            }
        }


        function showNotification(message, type, persistent = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate__animated`; 
            if (persistent) notification.classList.add('persistent');
            
            let iconClass;
            switch (type) {
                case 'success': iconClass = 'fa-check-circle'; break;
                case 'error': iconClass = 'fa-times-circle'; break;
                case 'warning': iconClass = 'fa-exclamation-triangle'; break; 
                case 'info': iconClass = 'fa-info-circle'; break;
                default: iconClass = 'fa-bell';
            }
            
            notification.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
            notificationContainer.appendChild(notification);
            
            notification.classList.add('animate__slideInRight'); 
            
            if (!persistent) {
                setTimeout(() => {
                    notification.classList.remove('animate__slideInRight');
                    notification.classList.add('animate__fadeOutUp'); 
                    setTimeout(() => notification.remove(), 500); 
                }, 3500);
            } else { // Add a close button for persistent notifications
                 const closeBtn = document.createElement('button');
                 closeBtn.innerHTML = '&times;';
                 closeBtn.style.cssText = "background:none; border:none; color:inherit; font-size:1.2em; cursor:pointer; margin-left:auto; padding:0 5px;";
                 closeBtn.onclick = () => notification.remove();
                 notification.appendChild(closeBtn);
            }
        }

        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }

        let slideIndex = 1; 
        let slideshowTimeout;

        function initSlideshow() { showSlides(slideIndex); }
        function plusSlides(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex += n); }
        function currentSlide(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex = n); }

        function showSlides(n) {
            let i;
            const slides = document.getElementsByClassName("slide");
            const dots = document.getElementsByClassName("dot");
            if (slides.length === 0 || dots.length === 0) return; 

            if (n > slides.length) {slideIndex = 1}
            if (n < 1) {slideIndex = slides.length}
            
            for (i = 0; i < slides.length; i++) slides[i].style.display = "none";  
            for (i = 0; i < dots.length; i++) dots[i].className = dots[i].className.replace(" active-dot", "");
            
            slides[slideIndex-1].style.display = "block";  
            dots[slideIndex-1].className += " active-dot";
            
            slideshowTimeout = setTimeout(() => { plusSlides(1); }, 5000); 
        }

        function initPlanButtons() {
            const buyButtons = document.querySelectorAll('.buy-plan-btn');
            buyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const planAmount = parseInt(this.dataset.plan);
                    purchasePlan(planAmount, this); 
                });
            });
        }
        
        function initPlansPage() { // Called when navigating to plans page
            if (!currentUser || !currentUser.emailVerified) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Verify Email";
                });
                return;
            }

            if (userData && userData.activePlan) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Plan Active";
                });
            } else {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').textContent = "Buy Now";
                });
            }
        }

        async function purchasePlan(planAmount, buttonElement) {
            if (!currentUser || !userData) {
                showNotification('Please login to purchase a plan.', 'error'); return;
            }
            if (!currentUser.emailVerified) {
                showNotification('Please verify your email before purchasing a plan.', 'warning');
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }
            
            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);
            
            if (totalAvailableBalance < planAmount) {
                showNotification('Insufficient balance. Please deposit funds.', 'error'); return;
            }
            
            if (userData.activePlan) {
                showNotification('You already have an active plan. Wait for it to complete or contact support.', 'error'); return;
            }
            
            showConfirmationModal(
                `Confirm Plan Purchase`,
                `Purchase ${getPlanName(planAmount)} for $${planAmount}? You'll earn 5% daily for 30 days. This will also trigger MLM commissions for your upline.`,
                async () => { // Make this callback async
                    showLoadingButton(buttonElement, true);
                    
                    let newPlanEarnings = userData.earnings || 0; // For plan investment earnings
                    let newMainBalance = userData.balance || 0;   // For deposits, MLM commissions
                    let amountFromPlanEarnings = 0;
                    let amountFromMainBalance = 0;

                    // Deduct from plan earnings first, then from main balance
                    if (newPlanEarnings >= planAmount) {
                        amountFromPlanEarnings = planAmount;
                        newPlanEarnings -= planAmount;
                    } else {
                        amountFromPlanEarnings = newPlanEarnings;
                        const remaining = planAmount - newPlanEarnings;
                        newPlanEarnings = 0;
                        amountFromMainBalance = remaining;
                        newMainBalance -= remaining;
                    }
                    
                    const updates = {
                        balance: newMainBalance,
                        earnings: newPlanEarnings,
                        activePlan: planAmount,
                        planStartDate: new Date().toISOString(),
                        lastEarningsUpdate: new Date().toISOString() 
                    };
                    
                    try {
                        await database.ref('users/' + currentUser.uid).update(updates);
                        const logEntry = {
                            type: 'plan_purchase',
                            amount: planAmount,
                            planName: getPlanName(planAmount),
                            date: new Date().toISOString(),
                            deductedFromBalance: amountFromMainBalance,
                            deductedFromEarnings: amountFromPlanEarnings // Renamed from deductedFromEarnings
                        };
                        await database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);

                        showNotification(`${getPlanName(planAmount)} purchased successfully! Daily plan earnings: $${(planAmount * 0.05).toFixed(2)}.`, 'success');
                        
                        if (document.getElementById('plans-page') && !document.getElementById('plans-page').classList.contains('hidden')) {
                            initPlansPage(); // Re-check button states
                        }
                        startEarningsCalculation(); // Start plan earnings
                        
                        // Award MLM Commissions
                        await awardMLMCommissions(currentUser.uid, planAmount, 'plan_purchase');

                    } catch (error) {
                        showNotification(`Purchase error: ${error.message}`, 'error');
                        // Potentially revert balance if partial update failed, though Firebase updates are atomic for a single path.
                    } finally {
                        showLoadingButton(buttonElement, false, "Buy Now");
                    }
                }, 'success' 
            );
        }

        async function awardMLMCommissions(sourceUserUid, triggerAmount, triggerAction = 'plan_purchase') {
            if (!sourceUserUid || triggerAmount <= 0) return;
            console.log(`Attempting to award MLM commissions for ${sourceUserUid} from ${triggerAmount} purchase.`);

            try {
                const sourceUserSnapshot = await database.ref(`users/${sourceUserUid}`).once('value');
                if (!sourceUserSnapshot.exists()) {
                    console.error("Source user for MLM commission not found:", sourceUserUid);
                    return;
                }
                const sourceUserData = sourceUserSnapshot.val();

                if (!sourceUserData.uplineUids || Object.keys(sourceUserData.uplineUids).length === 0) {
                    console.log("Source user has no uplines:", sourceUserUid);
                    return;
                }
                console.log("Source user uplines:", sourceUserData.uplineUids);

                for (let level = 1; level <= MLM_MAX_LEVELS; level++) {
                    const uplineUid = sourceUserData.uplineUids[`level${level}`];
                    if (uplineUid) {
                        const commissionRate = MLM_COMMISSION_RATES[level];
                        if (commissionRate) {
                            const commissionAmount = parseFloat((triggerAmount * commissionRate).toFixed(2));

                            if (commissionAmount > 0) {
                                const uplineUserRef = database.ref(`users/${uplineUid}`);
                                const uplineSnapshot = await uplineUserRef.once('value');
                                if (uplineSnapshot.exists()) {
                                    const uplineData = uplineSnapshot.val();
                                    const newBalance = parseFloat(((uplineData.balance || 0) + commissionAmount).toFixed(2));
                                    const newTotalReferralEarnings = parseFloat(((uplineData.totalReferralEarnings || 0) + commissionAmount).toFixed(2));

                                    await uplineUserRef.update({
                                        balance: newBalance,
                                        totalReferralEarnings: newTotalReferralEarnings
                                    });

                                    const commissionEntry = {
                                        sourceUserUid: sourceUserUid,
                                        sourceUserName: sourceUserData.name || "N/A",
                                        sourceUserEmail: sourceUserData.email || "N/A", // Store email of the source user
                                        amount: commissionAmount,
                                        level: level,
                                        date: new Date().toISOString(),
                                        triggerAction: triggerAction,
                                        triggerAmount: triggerAmount,
                                        planName: triggerAction === 'plan_purchase' ? getPlanName(triggerAmount) : null
                                    };
                                    await database.ref(`users/${uplineUid}/referralHistory`).push(commissionEntry);
                                    console.log(`Awarded $${commissionAmount} (L${level}) to ${uplineUid} (Balance: ${newBalance}).`);
                                } else {
                                    console.warn(`Upline user UID: ${uplineUid} (Level ${level}) not found.`);
                                }
                            }
                        }
                    } else {
                        console.log(`No upline found at level ${level} for user ${sourceUserUid}.`);
                        break; // No more uplines in this chain
                    }
                }
            } catch (error) {
                console.error("Error awarding MLM commissions:", error);
                showNotification("Error processing MLM commissions.", "error");
            }
        }


        function startEarningsCalculation() { // For Plan Investment Earnings
            if (earningsInterval) clearInterval(earningsInterval); 

            if (!currentUser || !userData || !userData.activePlan || !userData.planStartDate) {
                return;
            }
            
            const planStartDate = new Date(userData.planStartDate);
            const planEndDate = new Date(planStartDate);
            planEndDate.setDate(planEndDate.getDate() + 30); 
            
            const now = new Date();

            if (now >= planEndDate) { // Plan completed
                const principal = userData.activePlan;
                const updates = {
                    balance: (userData.balance || 0) + principal, // Return principal to main balance
                    activePlan: null,
                    planStartDate: null,
                    lastEarningsUpdate: null,
                    earnings: (userData.earnings || 0), // Keep accumulated plan earnings as is, or move to balance if desired
                    planCompletedOn: now.toISOString()
                };
                
                database.ref('users/' + currentUser.uid).update(updates)
                    .then(() => {
                        const logEntry = {
                            type: 'plan_completion',
                            amount: principal,
                            description: `Principal for ${getPlanName(principal)} returned to balance.`,
                            date: now.toISOString()
                        };
                        database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);
                        showNotification(`Your ${getPlanName(principal)} plan has completed! $${principal} principal returned to balance.`, 'success', true);
                    });
                return; 
            }
            
            // Catch-up logic for missed hourly earnings (if any)
            const lastUpdate = userData.lastEarningsUpdate ? new Date(userData.lastEarningsUpdate) : planStartDate;
            const hoursPassedSinceLastUpdate = (now - lastUpdate) / (1000 * 60 * 60);
            
            if (hoursPassedSinceLastUpdate >= 1) { 
                const planAmount = userData.activePlan;
                const hourlyPlanEarnings = (planAmount * 0.05) / 24; // 5% daily / 24 hours
                const missedPlanEarnings = hourlyPlanEarnings * Math.floor(hoursPassedSinceLastUpdate);
                
                if (missedPlanEarnings > 0) {
                    const newTotalPlanEarnings = (userData.earnings || 0) + missedPlanEarnings;
                    const earningsUpdate = {
                        earnings: parseFloat(newTotalPlanEarnings.toFixed(2)), // Add to userData.earnings
                        lastEarningsUpdate: now.toISOString()
                    };
                    const logEntry = {
                        type: 'investment_earning',
                        amount: parseFloat(missedPlanEarnings.toFixed(2)),
                        plan: planAmount,
                        date: now.toISOString(),
                        description: `Hourly plan earnings catch-up`
                    };
                    database.ref(`users/${currentUser.uid}/earningsHistory`).push(logEntry); // Log investment earnings
                    database.ref('users/' + currentUser.uid).update(earningsUpdate);
                }
            }
            
            // Regular interval for hourly plan earnings
            earningsInterval = setInterval(() => {
                if (!currentUser || !userData || !userData.activePlan) { 
                    clearInterval(earningsInterval);
                    return;
                }
                // Re-check plan completion inside interval
                 const currentActivePlan = userData.activePlan; 
                 const currentPlanStartDate = new Date(userData.planStartDate);
                 const currentPlanEndDate = new Date(currentPlanStartDate);
                 currentPlanEndDate.setDate(currentPlanEndDate.getDate() + 30);

                if (new Date() >= currentPlanEndDate) {
                    clearInterval(earningsInterval);
                    startEarningsCalculation(); // Trigger completion logic
                    return;
                }

                const planAmount = currentActivePlan;
                const hourlyRate = (planAmount * 0.05) / 24;
                
                const newTotalPlanEarnings = (userData.earnings || 0) + hourlyRate;
                const updateData = {
                    earnings: parseFloat(newTotalPlanEarnings.toFixed(2)), // Update userData.earnings
                    lastEarningsUpdate: new Date().toISOString()
                };

                const logEntry = {
                    type: 'investment_earning',
                    amount: parseFloat(hourlyRate.toFixed(2)),
                    plan: planAmount,
                    date: new Date().toISOString(),
                    description: `Regular hourly plan earning`
                };
                database.ref(`users/${currentUser.uid}/earningsHistory`).push(logEntry);

                database.ref('users/' + currentUser.uid).update(updateData)
                .catch(err => console.error("Error updating hourly plan earnings:", err));

            }, 3600000); // Every hour
        }

        function initTransactionButtons() {
            const depositButton = document.getElementById('submit-deposit');
            if (depositButton) depositButton.addEventListener('click', submitDepositRequest); 
            
            const withdrawButton = document.getElementById('submit-withdraw');
            if (withdrawButton) withdrawButton.addEventListener('click', submitWithdrawalRequest); 
        }

        function initDepositPage() {
            const methodCards = document.querySelectorAll('#deposit-page .method-card');
            const depositMethodNameEl = document.getElementById('deposit-method-name');
            const depositAccountLabel1El = document.getElementById('deposit-account-label1');
            const depositAccountNumberEl = document.getElementById('deposit-account-number');
            const copyDepositAddressBtn = document.getElementById('copy-deposit-address');

            const usdtAddresses = { // Keep these updated and secure
                usdt_bep20: '0xeb0ee64208106984101b1f127cf221358771dbfa', // Example
                usdt_trc20: 'TKEmWeig1jtWLgPZp4pX4PHAsPsrFNdqf2'  // Example
            };

            methodCards.forEach(card => {
                card.addEventListener('click', function() {
                    methodCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    const method = this.dataset.method;
                    let methodNameText = '';
                    let addressLabelText = '';
                    let addressValue = '';

                    if (method === 'usdt_bep20') {
                        methodNameText = 'USDT (BEP20)';
                        addressLabelText = 'Deposit Address (BEP20):';
                        addressValue = usdtAddresses.usdt_bep20;
                    } else if (method === 'usdt_trc20') {
                        methodNameText = 'USDT (TRC20)';
                        addressLabelText = 'Deposit Address (TRC20):';
                        addressValue = usdtAddresses.usdt_trc20;
                    }
                    
                    if (depositMethodNameEl) depositMethodNameEl.textContent = methodNameText;
                    if (depositAccountLabel1El) depositAccountLabel1El.textContent = addressLabelText;
                    if (depositAccountNumberEl) depositAccountNumberEl.textContent = addressValue;
                });
            });
            
            if (copyDepositAddressBtn) {
                copyDepositAddressBtn.addEventListener('click', () => {
                    const addressToCopy = depositAccountNumberEl.textContent;
                    navigator.clipboard.writeText(addressToCopy).then(() => {
                        showNotification('Address copied to clipboard!', 'success');
                    }).catch(err => {
                        showNotification('Failed to copy address.', 'error');
                    });
                });
            }
            // Trigger click on default active card to set initial details
            const defaultActiveCard = document.querySelector('#deposit-page .method-card.active');
            if (defaultActiveCard) defaultActiveCard.click();
        }


        function submitDepositRequest() { 
            if (!currentUser || !currentUser.emailVerified) {
                showNotification('Please verify your email before making a deposit.', 'warning');
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }

            const amountSelect = document.getElementById('deposit-amount');
            let amount = amountSelect.value === 'other' ? 
                parseFloat(document.getElementById('custom-amount').value) : 
                parseFloat(amountSelect.value);
            
            const transactionId = document.getElementById('deposit-transaction').value.trim();
            const senderAddress = document.getElementById('deposit-sender').value.trim(); 
            const method = document.querySelector('#deposit-page .method-card.active')?.dataset.method;

            if (!amount || isNaN(amount) || amount < 5) { 
                showNotification('Invalid amount. Minimum deposit is $5.', 'error'); return;
            }
            if (!transactionId || !method) { 
                showNotification('Please fill Amount, Transaction ID, and select a Method.', 'error'); return;
            }
            
            const submitDepositBtn = document.getElementById('submit-deposit');
            showLoadingButton(submitDepositBtn, true);
            
            const depositData = {
                userId: currentUser.uid, 
                userName: userData.name, 
                userEmail: currentUser.email,
                amount: amount,
                method: method, 
                transactionId: transactionId,
                senderAddress: senderAddress, 
                date: new Date().toISOString(),
                status: 'pending' // Admin will verify and update status & user's balance
            };
            
            const depositKey = database.ref(`users/${currentUser.uid}/deposits`).push().key; 
            database.ref(`users/${currentUser.uid}/deposits/${depositKey}`).set({...depositData, id: depositKey})
            .then(() => {
                // Also send to an admin queue for verification
                database.ref(`admin/pending_deposits/${depositKey}`).set({...depositData, userUid: currentUser.uid, depositId: depositKey });

                showNotification('Deposit request submitted! Processing takes 5-30 mins after admin verification.', 'success');
                const depositForm = document.querySelector('#deposit-page .deposit-form');
                if (depositForm) depositForm.reset(); 
                document.getElementById('custom-amount-container').classList.add('hidden');
                amountSelect.value = ""; // Reset select
            })
            .catch(error => {
                showNotification(`Deposit error: ${error.message}`, 'error');
            })
            .finally(() => {
                showLoadingButton(submitDepositBtn, false, "Submit Deposit");
            });
        }

        function initWithdrawPage() {
            if (userData) updateBalanceDisplay(); 
        }

        function initAmountButtons() {
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            document.querySelectorAll('#withdraw-page .amount-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    if(withdrawAmountInput) withdrawAmountInput.value = this.dataset.amount;
                });
            });
        }

        function submitWithdrawalRequest() { 
            if (!currentUser || !currentUser.emailVerified) {
                showNotification('Please verify your email before making a withdrawal.', 'warning');
                emailVerificationNoticeEl.classList.remove('hidden');
                return;
            }

            const method = document.getElementById('withdraw-method').value; 
            const account = document.getElementById('withdraw-account').value.trim(); 
            const name = document.getElementById('withdraw-name').value.trim(); 
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            if (!method || !account || !amount || isNaN(amount)) {
                showNotification('Please select method, enter your USDT address, and specify amount.', 'error'); return;
            }
             
            if (account.length < 20) { // Basic validation for address length
                 showNotification('Please enter a valid USDT wallet address.', 'error'); return;
            }
            if (amount < 2) {
                showNotification('Minimum withdrawal is $2.', 'error'); return;
            }
            if (amount > 500) {
                showNotification('Maximum withdrawal is $500.', 'error'); return;
            }
            
            // Withdraw from total available balance (plan earnings + main balance)
            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);
            if (amount > totalAvailableBalance) {
                showNotification('Insufficient total available balance.', 'error'); return;
            }
            
            const withdrawalFeePercentage = 0.05; 
            const feeAmount = parseFloat((amount * withdrawalFeePercentage).toFixed(2));
            const netAmountToReceive = parseFloat((amount - feeAmount).toFixed(2)); 
            const amountToDeduct = amount; 

            const withdrawalData = {
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: currentUser.email,
                method: method, 
                account: account, 
                name: name, 
                requestedAmount: amount,
                fee: feeAmount,
                netAmount: netAmountToReceive,
                date: new Date().toISOString(),
                status: 'pending' // Admin will verify and process
            };
            
            showConfirmationModal(
                'Confirm Withdrawal',
                `Withdraw $${amount.toFixed(2)} via ${method.toUpperCase().replace('_', ' ')} to ${account}? <br>Fee: $${feeAmount.toFixed(2)}. You will receive: $${netAmountToReceive.toFixed(2)}.`,
                async () => { // Make callback async
                    const submitWithdrawBtn = document.getElementById('submit-withdraw');
                    showLoadingButton(submitWithdrawBtn, true);
                    
                    let newPlanEarnings = userData.earnings || 0;
                    let newMainBalance = userData.balance || 0;
                    
                    // Deduct from plan earnings first, then from main balance
                    if (newPlanEarnings >= amountToDeduct) {
                        newPlanEarnings -= amountToDeduct;
                    } else {
                        const remainingToDeduct = amountToDeduct - newPlanEarnings;
                        newPlanEarnings = 0;
                        newMainBalance -= remainingToDeduct;
                    }
                    
                    const balanceUpdate = { 
                        earnings: parseFloat(newPlanEarnings.toFixed(2)), 
                        balance: parseFloat(newMainBalance.toFixed(2)) 
                    };
                    
                    try {
                        await database.ref('users/' + currentUser.uid).update(balanceUpdate);
                        
                        const withdrawalKey = database.ref(`users/${currentUser.uid}/withdrawals`).push().key;
                        await database.ref(`users/${currentUser.uid}/withdrawals/${withdrawalKey}`).set({...withdrawalData, id: withdrawalKey});
                        
                        // Send to admin queue
                        await database.ref(`admin/pending_withdrawals/${withdrawalKey}`).set({...withdrawalData, userUid: currentUser.uid, withdrawalId: withdrawalKey});
                        
                        showNotification('Withdrawal request submitted! Processing takes 1-6 hours after admin approval.', 'success');
                        const withdrawForm = document.querySelector('#withdraw-page .withdraw-form');
                        if(withdrawForm) withdrawForm.reset();
                        document.getElementById('withdraw-method').value = ""; // Reset select

                    } catch (error) {
                        showNotification(`Withdrawal error: ${error.message}`, 'error');
                        // Consider reverting balance if any step failed, though Firebase updates are atomic per path.
                    } finally {
                        showLoadingButton(submitWithdrawBtn, false, "Request Withdrawal");
                    }
                }, 'warning' 
            );
        }

        function initCopyButton() { 
            const copyButton = document.getElementById('copy-invite');
            const inviteCodeInput = document.getElementById('invite-code'); 
            if (copyButton && inviteCodeInput) {
                copyButton.addEventListener('click', () => {
                    inviteCodeInput.select();
                    inviteCodeInput.setSelectionRange(0, 99999); 
                    try {
                        navigator.clipboard.writeText(inviteCodeInput.value).then(() => {
                             showNotification('Invite code copied!', 'success');
                        });
                    } catch (err) {
                        showNotification('Failed to copy code.', 'error');
                    }
                });
            }
        }

        function initShareButtons() {
            const inviteCodeEl = document.getElementById('invite-code');
            const baseAppUrl = window.location.origin + window.location.pathname; 

            document.querySelector('.share-btn.whatsapp')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const message = `Join Crypto Harvest with my invite code: ${inviteCode} and earn daily with MLM! Sign up here: ${baseAppUrl}?ref=${inviteCode}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            });
            
            document.querySelector('.share-btn.facebook')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const referralLink = `${baseAppUrl}?ref=${inviteCode}`;
                const message = `Join Crypto Harvest with my invite code: ${inviteCode} and earn daily with MLM!`;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}&quote=${encodeURIComponent(message)}`, '_blank');
            });
            
            document.querySelector('.share-btn.copy-link')?.addEventListener('click', () => {
                const inviteCode = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const link = `${baseAppUrl}?ref=${inviteCode}`;
                navigator.clipboard.writeText(link)
                    .then(() => showNotification('Referral link copied!', 'success'))
                    .catch(() => showNotification('Failed to copy link.', 'error'));
            });
        }

        function initRankingButton() {
            const viewRankingBtn = document.getElementById('view-ranking-btn');
            const rankingTableDiv = document.getElementById('ranking-table-container'); 
            if (viewRankingBtn && rankingTableDiv) {
                viewRankingBtn.addEventListener('click', () => {
                    const isHidden = rankingTableDiv.classList.contains('hidden');
                    if (isHidden) {
                        loadUserRankings(); 
                        rankingTableDiv.classList.remove('hidden');
                        viewRankingBtn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Ranking`;
                    } else {
                        rankingTableDiv.classList.add('hidden');
                        viewRankingBtn.innerHTML = `<i class="fas fa-list-ol"></i> View Top Investors Ranking`;
                    }
                });
            }
        }

        function initTeamPage() {
            // These will be called by updateUI if the page is active or when data changes
            loadDirectReferrals();
            loadCommissionsEarnedHistory();
        }

        function loadUserRankings() { // Top investors by active plan
            showLoading();
            database.ref('users').orderByChild('activePlan').limitToLast(20).once('value') 
                .then(snapshot => {
                    const rankings = [];
                    snapshot.forEach(userSnapshot => {
                        const user = userSnapshot.val();
                        if (user.name && user.activePlan && user.activePlan > 0) { 
                            rankings.push({
                                id: userSnapshot.key,
                                name: user.name,
                                investment: user.activePlan, // Active plan amount
                                totalEarnings: (user.earnings || 0) + (user.totalReferralEarnings || 0) // Plan earnings + MLM
                            });
                        }
                    });
                    
                    // Sort by investment (activePlan) descending, then by total earnings
                    rankings.sort((a, b) => b.investment - a.investment || b.totalEarnings - a.totalEarnings); 
                    
                    const rankingBody = document.getElementById('ranking-body');
                    if (!rankingBody) { hideLoading(); return; }
                    rankingBody.innerHTML = '';
                    
                    const top10 = rankings.slice(0, 10);
                    if (top10.length === 0) {
                        rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No active investors found.</td></tr>';
                    } else {
                        top10.forEach((user, index) => {
                            const row = document.createElement('tr');
                            if (currentUser && user.id === currentUser.uid) {
                                row.classList.add('current-user');
                            }
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${user.name}</td>
                                <td>$${user.investment.toFixed(0)}</td>
                                <td>$${user.totalEarnings.toFixed(2)}</td>
                            `;
                            rankingBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    showNotification('Error loading rankings: ' + error.message, 'error');
                })
                .finally(() => hideLoading());
        }

        function loadDepositHistory() {
            const depositHistoryBody = document.getElementById('deposit-history-body'); 
            if (!depositHistoryBody) return;

            if (!currentUser || !userData || !userData.deposits) {
                depositHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No deposit history.</td></tr>';
                updateDepositSummary(0, 0, 0);
                return;
            }
            
            const filterValue = document.getElementById('deposit-filter')?.value || 'all';
            const depositsArray = Object.entries(userData.deposits).map(([key, value]) => ({ ...value, id: key })); 

            depositHistoryBody.innerHTML = '';
            
            const filteredDeposits = depositsArray
                .filter(d => filterValue === 'all' || d.status === filterValue)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredDeposits.length === 0) {
                 depositHistoryBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No deposits match '${filterValue}'.</td></tr>`;
            } else {
                filteredDeposits.forEach(deposit => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>$${deposit.amount.toFixed(2)}</td>
                        <td>${deposit.method ? deposit.method.toUpperCase().replace('_', ' ') : 'N/A'}</td>
                        <td>${formatDate(deposit.date)}</td>
                        <td class="status-${deposit.status}">${deposit.status}</td>
                        <td>
                            ${deposit.status === 'pending' ? 
                                `<span class="action-link" data-id="${deposit.id}" data-type="deposit">Cancel</span>` : 
                                '--'}
                        </td>
                    `;
                    depositHistoryBody.appendChild(row);
                });
            }
            let summaryTotal = 0, summaryPending = 0, summaryCompleted = 0;
            depositsArray.forEach(d => {
                if (d.status === 'completed') summaryCompleted += d.amount; // Only completed count towards total verified deposits
                if (d.status === 'pending') summaryPending += d.amount;
                summaryTotal += d.amount; // Show all attempted deposits
            });
            updateDepositSummary(summaryTotal, summaryPending, summaryCompleted);
            
            attachCancelListeners(depositHistoryBody, 'deposit');
        }

        function updateDepositSummary(total, pending, completed) {
            document.getElementById('total-deposits').textContent = `$${total.toFixed(2)}`;
            document.getElementById('pending-deposits').textContent = `$${pending.toFixed(2)}`;
            document.getElementById('completed-deposits').textContent = `$${completed.toFixed(2)}`;
        }

        function loadWithdrawHistory() {
            const withdrawHistoryBody = document.getElementById('withdraw-history-body'); 
             if (!withdrawHistoryBody) return;

            if (!currentUser || !userData || !userData.withdrawals) {
                withdrawHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No withdrawal history.</td></tr>';
                updateWithdrawalSummary(0, 0, 0);
                return;
            }

            const filterValue = document.getElementById('withdraw-filter')?.value || 'all';
            const withdrawalsArray = Object.entries(userData.withdrawals).map(([key, value]) => ({ ...value, id: key }));

            withdrawHistoryBody.innerHTML = '';

            const filteredWithdrawals = withdrawalsArray
                .filter(w => filterValue === 'all' || w.status === filterValue)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredWithdrawals.length === 0) {
                 withdrawHistoryBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No withdrawals match '${filterValue}'.</td></tr>`;
            } else {
                filteredWithdrawals.forEach(withdrawal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>$${withdrawal.requestedAmount.toFixed(2)}</td>
                        <td>${withdrawal.method ? withdrawal.method.toUpperCase().replace('_', ' ') : 'N/A'}</td>
                        <td>${formatDate(withdrawal.date)}</td>
                        <td class="status-${withdrawal.status}">${withdrawal.status}</td>
                        <td>
                            ${withdrawal.status === 'pending' ? 
                                `<span class="action-link" data-id="${withdrawal.id}" data-type="withdrawal" data-amount="${withdrawal.requestedAmount}">Cancel</span>` :
                                '--'}
                        </td>
                    `;
                    withdrawHistoryBody.appendChild(row);
                });
            }
            let summaryTotal = 0, summaryPending = 0, summaryCompleted = 0;
            withdrawalsArray.forEach(w => {
                if (w.status === 'completed') summaryCompleted += w.requestedAmount;
                if (w.status === 'pending') summaryPending += w.requestedAmount;
                summaryTotal += w.requestedAmount;
            });
            updateWithdrawalSummary(summaryTotal, summaryPending, summaryCompleted);
            
            attachCancelListeners(withdrawHistoryBody, 'withdrawal');
        }

        function updateWithdrawalSummary(total, pending, completed) {
            document.getElementById('total-withdrawals').textContent = `$${total.toFixed(2)}`;
            document.getElementById('pending-withdrawals').textContent = `$${pending.toFixed(2)}`;
            document.getElementById('completed-withdrawals').textContent = `$${completed.toFixed(2)}`;
        }

        function attachCancelListeners(tableBody, type) {
            tableBody.querySelectorAll('.action-link').forEach(link => {
                link.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const amount = parseFloat(this.dataset.amount); 
                    if (type === 'deposit') cancelTransaction(id, 'deposit', 0); // No refund for deposit cancellation by user
                    else if (type === 'withdrawal') cancelTransaction(id, 'withdrawal', amount); // Refund for withdrawal
                });
            });
        }

        async function cancelTransaction(id, type, amountToRefund = 0) {
            const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
            showConfirmationModal(
                `Cancel ${capitalizedType}`,
                `Are you sure you want to cancel this ${type} request? ${type === 'withdrawal' ? 'The amount will be refunded to your balance.' : ''}`,
                async () => { // Make callback async
                    showLoading();
                    const userTransactionPath = `users/${currentUser.uid}/${type}s/${id}`; 
                    const adminQueuePath = `admin/pending_${type}s/${id}`; 
                    
                    try {
                        await database.ref(userTransactionPath).update({ status: 'cancelled' });
                        await database.ref(adminQueuePath).update({ status: 'cancelled_by_user', cancelledDate: new Date().toISOString() }); 
                        
                        if (type === 'withdrawal' && amountToRefund > 0 && userData) {
                            // Refund to main balance or earnings based on where it was taken. Simpler to refund to main balance.
                            const currentBalance = userData.balance || 0;
                            const currentPlanEarnings = userData.earnings || 0;
                            // For simplicity, refund to main balance. Or decide based on original deduction.
                            // Here, we'll add to main balance.
                            const newMainBalance = parseFloat((currentBalance + amountToRefund).toFixed(2));
                            await database.ref(`users/${currentUser.uid}`).update({ balance: newMainBalance });
                        }
                        
                        showNotification(`${capitalizedType} request cancelled.`, 'success');
                        if(type === 'deposit') loadDepositHistory();
                        if(type === 'withdrawal') loadWithdrawHistory();
                    } catch (error) {
                        showNotification(`Error cancelling ${type}: ${error.message}`, 'error');
                    } finally {
                        hideLoading();
                    }
                }, 'warning'
            );
        }

        // --- MLM Specific UI Functions for Team Page ---
        function loadDirectReferrals() { // L1 downline
            const directReferralsBody = document.getElementById('direct-referrals-body');
            if (!directReferralsBody || !currentUser || !userData || !userData.downline) {
                if(directReferralsBody) directReferralsBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No direct referrals yet.</td></tr>';
                return;
            }

            const downlineEntries = Object.values(userData.downline);
            directReferralsBody.innerHTML = '';

            if (downlineEntries.length === 0) {
                directReferralsBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No direct referrals yet.</td></tr>';
                return;
            }
            
            // Sort by registration date if available
            downlineEntries.sort((a,b) => new Date(b.registrationDate || 0) - new Date(a.registrationDate || 0));

            downlineEntries.forEach(referralInfo => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${referralInfo.name || 'N/A'}</td>
                    <td>${referralInfo.email || 'N/A'}</td>
                    <td>${formatDate(referralInfo.registrationDate) || 'N/A'}</td>
                `;
                directReferralsBody.appendChild(row);
            });
        }

        function loadCommissionsEarnedHistory() { // Commissions current user received
            const commissionsBody = document.getElementById('commissions-earned-body'); 
            if (!commissionsBody) return;

            if (!currentUser || !userData || !userData.referralHistory) {
                commissionsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
                return;
            }
            
            const commissionsArray = Object.values(userData.referralHistory)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent
            
            commissionsBody.innerHTML = '';
            if (commissionsArray.length === 0) {
                 commissionsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
            } else {
                commissionsArray.forEach(commission => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${commission.sourceUserName || 'User'} (ID: ...${commission.sourceUserUid.slice(-6)})</td>
                        <td>Level ${commission.level}</td>
                        <td>$${commission.amount.toFixed(2)}</td>
                        <td>$${commission.triggerAmount.toFixed(2)} (${commission.planName || commission.triggerAction})</td>
                        <td>${formatDate(commission.date)}</td>
                    `;
                    commissionsBody.appendChild(row);
                });
            }
        }
        // --- End MLM Specific UI Functions ---

        function initEarningsPage() {
            loadEarningsHistory(); // This will also setup/update the chart
            // No need to call setupEarningsChart separately if loadEarningsHistory handles it
        }

        function loadEarningsHistory() { // For Earnings Page
            const earningsTableBody = document.getElementById('earnings-body'); 
            if (!earningsTableBody) return;

            if (!currentUser || !userData) {
                earningsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No earnings history.</td></tr>';
                updateEarningsSummaryOnPage(0, 0, 0); // Update summary on earnings page
                if (earningsChartInstance) updateChartData([], 'all'); // Clear chart
                return;
            }
            
            const periodFilter = document.getElementById('earnings-period')?.value || 'all';
            const allEarningsEntries = [];

            // Consolidate plan earnings and MLM commissions
            if (userData.earningsHistory) { // Plan investment earnings
                Object.values(userData.earningsHistory).forEach(entry => {
                    allEarningsEntries.push({
                        date: entry.date,
                        type: 'Investment', // Plan earning
                        amount: entry.amount,
                        description: `From ${entry.plan ? getPlanName(entry.plan) : 'Active Plan'}`
                    });
                });
            }
            if (userData.referralHistory) { // MLM commissions earned by this user
                Object.values(userData.referralHistory).forEach(entry => {
                    allEarningsEntries.push({
                        date: entry.date,
                        type: 'Referral', // MLM Commission
                        amount: entry.amount,
                        description: `L${entry.level} from ${entry.sourceUserName || 'Downline'}`
                    });
                });
            }

            allEarningsEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort all combined entries

            const now = new Date();
            const filteredForPeriod = allEarningsEntries.filter(e => {
                const entryDate = new Date(e.date);
                if (periodFilter === 'today') return entryDate.toDateString() === now.toDateString();
                if (periodFilter === 'week') {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1) ); // Monday as start of week
                    weekStart.setHours(0,0,0,0);
                    return entryDate >= weekStart;
                }
                if (periodFilter === 'month') return entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear();
                return true; // 'all'
            });

            // Calculate summaries for the Earnings Page
            let grandTotalAllTime = 0;
            let todayGrandTotal = 0;
            let totalMLMAllTime = userData.totalReferralEarnings || 0; // Use the dedicated field for total MLM

            allEarningsEntries.forEach(e => { 
                grandTotalAllTime += e.amount;
                if (new Date(e.date).toDateString() === new Date().toDateString()) {
                    todayGrandTotal += e.amount;
                }
            });

            updateEarningsSummaryOnPage(
                grandTotalAllTime, 
                todayGrandTotal,
                totalMLMAllTime 
            );
            
            earningsTableBody.innerHTML = '';
            if (filteredForPeriod.length === 0) {
                earningsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No earnings for this period.</td></tr>`;
            } else {
                // Display limited entries, e.g., top 50 for performance
                filteredForPeriod.slice(0, 50).forEach(earning => { 
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(earning.date)}</td>
                        <td><span class="badge ${earning.type.toLowerCase()}">${earning.type}</span></td>
                        <td>$${earning.amount.toFixed(2)}</td>
                        <td>${earning.description}</td>
                    `;
                    earningsTableBody.appendChild(row);
                });
            }
            // Update or setup chart
            if (!earningsChartInstance) setupEarningsChart(); // Ensure chart is setup once
            updateChartData(filteredForPeriod, periodFilter); 
        }
        
        function updateEarningsSummaryOnPage(grandTotal, todayTotal, mlmTotal) {
            document.getElementById('total-earnings').textContent = `$${grandTotal.toFixed(2)}`; // Grand total
            document.getElementById('today-earnings').textContent = `$${todayTotal.toFixed(2)}`; // Today's grand total
            document.getElementById('all-referral-earnings').textContent = `$${mlmTotal.toFixed(2)}`; // Total MLM commissions
        }

        function setupEarningsChart() { 
            const ctx = document.getElementById('earnings-chart')?.getContext('2d');
            if (!ctx) return;

            if (earningsChartInstance) earningsChartInstance.destroy(); 
            
            earningsChartInstance = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: [], 
                    datasets: [
                        {
                            label: 'Total Daily Earnings (Plan + MLM)', // Combined
                            data: [], 
                            borderColor: 'var(--accent-color)', // Bright Gold
                            backgroundColor: 'rgba(var(--accent-color-rgb), 0.1)', // Light Bright Gold
                            fill: true,
                            tension: 0.3
                        },
                         { // Optional: Separate line for MLM commissions
                            label: 'MLM Commissions',
                            data: [],
                            borderColor: 'var(--secondary-color)', // Muted Gold
                            backgroundColor: 'rgba(var(--secondary-color-rgb), 0.1)',// Light Muted Gold
                            fill: true,
                            tension: 0.3,
                            hidden: true // Initially hidden, user can toggle
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Amount (USD)' },
                            ticks: { color: 'var(--gray-text)'}, /* Gold Theme */
                            grid: { color: 'rgba(var(--gray-text-rgb, 119,119,119), 0.2)' } /* Gold Theme */
                        },
                        x: { 
                            title: { display: true, text: 'Date/Time Period' },
                            ticks: { color: 'var(--gray-text)'}, /* Gold Theme */
                            grid: { color: 'rgba(var(--gray-text-rgb, 119,119,119), 0.2)' } /* Gold Theme */
                        }
                    },
                    plugins: { 
                        legend: { display: true, position: 'top', labels: {color: 'var(--dark-text)'} }, /* Gold Theme */
                        title: { display: true, text: 'Earnings Trend (Selected Period)', color: 'var(--primary-dark)' } /* Gold Theme */
                    }
                }
            });
        }

        function updateChartData(earningsDataForPeriod, period) { // earningsDataForPeriod is already filtered
            if (!earningsChartInstance) return;

            let labels = [];
            let totalDataPoints = [];
            let mlmDataPoints = []; // For separate MLM line

            // Aggregate data by day for chart display
            const dailyTotals = {};
            const dailyMlmTotals = {};

            earningsDataForPeriod.forEach(e => {
                const day = new Date(e.date).toLocaleDateString('en-CA'); // YYYY-MM-DD format for sorting
                dailyTotals[day] = (dailyTotals[day] || 0) + e.amount;
                if (e.type === 'Referral') {
                    dailyMlmTotals[day] = (dailyMlmTotals[day] || 0) + e.amount;
                }
            });
            
            const sortedDays = Object.keys(dailyTotals).sort((a,b) => new Date(a) - new Date(b));
            
            labels = sortedDays.map(dayStr => formatDate(dayStr, true)); // Format as 'Mon, DD'
            totalDataPoints = sortedDays.map(day => dailyTotals[day] || 0);
            mlmDataPoints = sortedDays.map(day => dailyMlmTotals[day] || 0);
            
            earningsChartInstance.data.labels = labels;
            earningsChartInstance.data.datasets[0].data = totalDataPoints;
            earningsChartInstance.data.datasets[1].data = mlmDataPoints;
            earningsChartInstance.update();
        }


        function initHistoryFilters() {
            document.getElementById('deposit-filter')?.addEventListener('change', loadDepositHistory);
            document.getElementById('withdraw-filter')?.addEventListener('change', loadWithdrawHistory);
            document.getElementById('earnings-period')?.addEventListener('change', loadEarningsHistory);
        }

        function initContactForm() {
            const contactFormEl = document.getElementById('contact-form'); 
            if (contactFormEl) {
                contactFormEl.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('contact-name').value.trim();
                    const email = document.getElementById('contact-email').value.trim();
                    const subject = document.getElementById('contact-subject').value.trim();
                    const message = document.getElementById('contact-message').value.trim();
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!name || !email || !subject || !message || !emailRegex.test(email)) {
                        showNotification('Please fill all fields correctly, including a valid email.', 'error'); return;
                    }
                    
                    const submitBtn = this.querySelector('.submit-btn');
                    showLoadingButton(submitBtn, true);
                    
                    const messageData = { 
                        name, 
                        email, // Email from form
                        subject, 
                        message, 
                        date: new Date().toISOString(), 
                        userId: currentUser ? currentUser.uid : 'guest',
                        userAppEmail: currentUser ? currentUser.email : 'guest_form_submission' // Logged-in user's email
                    };

                    database.ref('contact_messages').push(messageData)
                    .then(() => {
                        showNotification('Message sent! We will respond soon.', 'success');
                        contactFormEl.reset();
                    })
                    .catch(err => {
                        showNotification('Failed to send message. Try again.', 'error');
                    })
                    .finally(() => {
                        showLoadingButton(submitBtn, false, "Send Message");
                    });
                });
            }
        }

        function showConfirmationModal(title, message, confirmCallback, type = 'warning') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; 
            
            const modalIconContainer = confirmationModal.querySelector('.modal-icon'); 
            modalIconContainer.querySelectorAll('i').forEach(icon => icon.style.display = 'none');
            const iconToShow = modalIconContainer.querySelector(`i.${type}`);
            if(iconToShow) iconToShow.style.display = 'block';
            
            // Configure confirm button style based on type
            const confirmBtnEl = document.getElementById('modal-confirm');
            confirmBtnEl.className = 'modal-btn confirm glowing-btn-hover'; // Reset classes, add glowing
            if (type === 'error') confirmBtnEl.classList.add('error');
            else if (type === 'warning') confirmBtnEl.classList.add('warning');
            // else default 'success' style (or primary/accent) is fine

            confirmationModal.classList.add('active');
            confirmationModal.classList.remove('hidden');
            
            // Re-attach listener to confirm button to avoid multiple calls from old listeners
            const newConfirmBtn = confirmBtnEl.cloneNode(true);
            confirmBtnEl.parentNode.replaceChild(newConfirmBtn, confirmBtnEl);
            
            newConfirmBtn.onclick = () => {
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
                if (typeof confirmCallback === 'function') confirmCallback();
            };
             modalCancel.onclick = () => { 
                confirmationModal.classList.remove('active');
                confirmationModal.classList.add('hidden');
            };
        }

        function formatDate(dateString, short = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date'; // Check if date is valid

            if (short) { // For chart labels like "Jul 15"
                 return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

